const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./@hugotomazi-vendor-BCKjIbph.js","./@capacitor-vendor-BO59Eym-.js"])))=>i.map(i=>d[i]);
import{r as y,j as r,a as Y}from"./react-vendor-DUMAdzxi.js";import{R as Pt,c as It}from"./react-dom-vendor-BQyVO993.js";import{_ as Et}from"./@hugotomazi-vendor-BCKjIbph.js";import{u as fe,B as f,T as nt,D as xe,a as j,I as X,d as rt,F as He,b as At,S as jt,M as re,c as G,C as Mt,e as Ft,R as Dt,f as Te,g as Pe,h as L,i as Rt,j as Ut,k as Nt,l as at,m as it,n as je,o as Me,p as Fe,q as Ue,r as ot,L as Ve,s as ct,t as We,v as Lt,w as Ot,x as zt,P as Bt,y as Kt,z as Ht,A as Vt,E as Wt,G as $t,H as $e,J as Jt,K as Gt,N as qt,O as Yt,Q as Qt,U as Je,V as pe,W as Zt,X as Xt,Y as _t,Z as es,_ as ts,$ as ss,a0 as ns,a1 as rs,a2 as as,a3 as is,a4 as os,a5 as cs,a6 as ls,a7 as ds,a8 as Ge,a9 as qe,aa as us,ab as hs,ac as oe,ad as gs,ae as fs,af as ps,ag as ms}from"./@mui-vendor-DUsSYvh2.js";import{m as Ne}from"./mitt-vendor-DJ65BbbF.js";import{v as ys}from"./uuid-vendor-BKrj-4V8.js";import{t as bs,i as de}from"./i18next-vendor-CMUxQoQY.js";import{a as xs,r as Ss,b as Ie}from"./mobx-vendor-BBz5gzLy.js";import{i as Ye,o as Qe}from"./react-device-detect-vendor-CEfIdEC1.js";import{J as Se}from"./jszip-vendor-z9MW0yWn.js";import{B as ws}from"./i18next-browser-languagedetector-vendor-OJKzRF51.js";import{i as Cs,u as ue,T as we}from"./react-i18next-vendor-XEHgpih7.js";import{A as vs}from"./ably-vendor-DXKSc1eN.js";import{C as ks,a as lt,r as Ts}from"./@capacitor-vendor-BO59Eym-.js";import{Q as De}from"./react-qrcode-logo-vendor-CUO0FCxv.js";import{o as Le}from"./mobx-react-lite-vendor-B6TFuRC2.js";import{H as Ps}from"./react-router-dom-vendor-BuVDghpy.js";import{a as Is,b as Ze}from"./react-router-vendor-DWz9kk0e.js";import"./@babel-vendor-CvQiZcsS.js";import"./scheduler-vendor-DYLXRpC5.js";import"./clsx-vendor-B-dksMZM.js";import"./@emotion-vendor-BjJ2an68.js";import"./hoist-non-react-statics-vendor-DQogQWOa.js";import"./stylis-vendor-DDa9OTMq.js";import"./react-transition-group-vendor-B4pUypdV.js";import"./react-is-vendor-DSf3zZfm.js";import"./@popperjs-vendor-DC5wud4b.js";import"./ua-parser-js-vendor-C8z0plQm.js";import"./html-parse-stringify-vendor-zLifhomV.js";import"./void-elements-vendor-CDiu0thy.js";import"./lodash.isequal-vendor-CoVwtXDn.js";import"./qrcode-generator-vendor-B7rwAJ2l.js";import"./use-sync-external-store-vendor-DyPNEIg6.js";import"./@remix-run-vendor-DdLerVrA.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(n){if(n.ep)return;n.ep=!0;const a=t(n);fetch(n.href,a)}})();const dt=Ne(),Es=()=>{const o=fe(),[e,t]=y.useState([]),s=y.useRef(null),n=y.useRef(null);return y.useEffect(()=>{dt.on("show",a=>{const i=Date.now(),c=n.current;if(c&&c.message===a.message&&i-c.timestamp<200)return;n.current={message:a.message,timestamp:i};const l=ys(),h={id:l,message:a.message,duration:a.duration||2500,zIndex:a.zIndex||9999};t(d=>[...d,h]),setTimeout(()=>{t(d=>d.map(b=>b.id===l?{...b,isExiting:!0}:b)),setTimeout(()=>{t(d=>d.filter(b=>b.id!==l))},300)},h.duration)})},[]),Pt.createPortal(r.jsxs("div",{ref:s,style:{position:"fixed",bottom:"10%",left:"50%",transform:"translateX(-50%)",zIndex:Math.max(...e.map(a=>a.zIndex),9999)},children:[r.jsx("div",{style:{position:"relative"},children:e.map((a,i)=>r.jsx("div",{className:`toast ${a.isExiting?"toast-exit":"toast-enter"}`,style:{backgroundColor:o.palette.background.paper,color:o.palette.text.primary,padding:"10px 20px",borderRadius:"8px",fontSize:"14px",maxWidth:"300px",textAlign:"center",whiteSpace:"pre-wrap",wordBreak:"break-word",boxShadow:"0 4px 8px rgba(0,0,0,0.3)",position:"relative",marginBottom:"10px",transition:"transform 300ms ease, opacity 300ms ease, margin 300ms ease",opacity:a.isExiting?0:1,transform:a.isExiting?"translateY(10px)":"translateY(0)"},children:a.message},a.id))}),r.jsx("style",{children:`
        .toast-enter {
          animation: fadeInUp 200ms ease-out;
        }

        .toast-exit {
          animation: fadeOutDown 300ms ease-in;
        }

        @keyframes fadeInUp {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        @keyframes fadeOutDown {
          from {
            opacity: 1;
            transform: translateY(0);
          }
          to {
            opacity: 0;
            transform: translateY(10px);
          }
        }
      `})]}),document.body)},me=new Map,As=1e3,x=(o,e,t)=>{me.has(o)&&clearTimeout(me.get(o));const s=setTimeout(()=>{dt.emit("show",{message:o,severity:t?.kind??"success",duration:e??2500,zIndex:t?.zIndex??9999}),me.delete(o)},As);me.set(o,s)},ge="user_settings",ne={roomId:"",userTheme:"light",userLanguage:"system",serverMode:"auto",customServerUrl:"wss://ecs.letshare.fun/",authToken:"98d9a399675116e5256e9082c192bc06eb6434937af99f201252e9424c7a5652",ablyKey:"4TtssQ.e9OvDA:wYBGdtWQNgicbeIKNtgeV_s5XEKmfLKD_Gue5XQrWuw",version:"3.3.0",isNewUser:!0},Ee={settingsPageState:!1,isConnectedToServer:!1,staticIp:""};class js{settings={...ne};unrmb={...Ee};constructor(){xs(this),this.loadFromLocalStorage(),Ss(()=>this.settings,e=>{localStorage.setItem(ge,JSON.stringify(e))})}update(e,t){if(!(e in ne))throw new Error(`âŒ update() ä¸å…è®¸çš„è®¾ç½®é¡¹: ${e}`);const s=this.settings[e];typeof t=="object"&&t!==null&&typeof s=="object"&&!Array.isArray(s)?this.settings[e]={...s,...t}:this.settings[e]=t,localStorage.setItem(ge,JSON.stringify(this.settings))}get(e){if(!(e in ne))throw new Error(`âŒ get() ä¸å…è®¸çš„è®¾ç½®é¡¹: ${e}`);return this.settings[e]}getUnrmb(e){if(!(e in Ee))throw new Error(`âŒ getUnrmb() ä¸å…è®¸çš„å­—æ®µ: ${e}`);return this.unrmb[e]}updateUnrmb(e,t){if(!(e in Ee))throw new Error(`âŒ updateUnrmb() ä¸å…è®¸çš„å­—æ®µ: ${e}`);this.unrmb[e]=t}getAllSettings(){return{...this.settings}}reset(){Ie(()=>{this.settings={...ne}}),localStorage.setItem(ge,JSON.stringify(this.settings))}loadFromLocalStorage(){const e=localStorage.getItem(ge);try{const t=e?JSON.parse(e):null;if(t&&typeof t=="object"&&Object.keys(ne).every(n=>n in t))Ie(()=>{this.settings={...ne,...t}});else throw new Error("æ— æ•ˆé…ç½®æˆ–å­—æ®µç¼ºå¤±ï¼Œå·²é‡ç½®ä¸ºé»˜è®¤å€¼")}catch(t){console.warn("âš ï¸ åŠ è½½é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®:",t),Ie(()=>{this.settings={...ne}}),localStorage.setItem(ge,JSON.stringify(this.settings))}}}const m=new js;class Oe{rtc;static rtcServers=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.counterpath.net"},{urls:"stun:stun.internetcalls.com"},{urls:"stun:stun.voip.aebc.com"},{urls:"stun:stun.voipbuster.com"},{urls:"stun:stun.xten.com"},{urls:"stun:global.stun.twilio.com:3478"}];constructor(e){this.rtc=e}createPeerConnection(e){const t=new RTCPeerConnection({iceServers:Oe.rtcServers,iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});this.rtc.negotiationMap.set(e,{isNegotiating:!1,queue:[]}),t.onnegotiationneeded=async()=>{};let s=[],n=!1;return t.onicecandidate=a=>{if(a.candidate){let i=m.getUnrmb("staticIp");s.push(a.candidate);const h=a.candidate.candidate.split(" "),d=h[4],b=h[7];i&&d!==i&&b==="srflx"&&x(bs("alert.proxy")),n||(n=!0,setTimeout(()=>{this.rtc.broadcastSignal({type:"candidate",candidates:s,to:e}),s=[],n=!1},400))}},t.ondatachannel=a=>{this.rtc.setupDataChannel(a.channel,e)},t.onconnectionstatechange=()=>{if(console.log(`[CONNECT] ${e} çŠ¶æ€:`,t.connectionState),t.connectionState==="connected"){console.log(`[CONNECT] âœ… ${e} è¿æ¥æˆåŠŸï¼Œå–æ¶ˆè¶…æ—¶`);const a=this.rtc.userList.get(e);a&&(a.status="connected",a.hadP2PConnection=!0,this.rtc.userList.set(e,a)),clearTimeout(this.rtc.connectionTimeouts.get(e))}if(["failed","disconnected","closed"].includes(t.connectionState)){console.warn(`[CONNECT] âŒ ${e} è¿æ¥å¤±è´¥æˆ–æ–­å¼€`);const a=this.rtc.userList.get(e);a?.hadP2PConnection&&t.connectionState==="disconnected"?(console.log(`[CONNECT] ğŸšª ${e} had P2P connection before, likely offline, removing user`),this.rtc.clearCache(e),this.rtc.userList.delete(e)):(console.log(`[CONNECT] ğŸ“± ${e} P2P failed, switching to text-only mode`),this.rtc.clearCache(e),a&&(a.status="text-only",a.lastSeen=Date.now(),this.rtc.userList.set(e,a))),t.close(),k.peers.delete(e),this.rtc.updateConnectedUsers(this.rtc.userList)}},e&&k.peers.set(e,t),t}removePeer(e){const t=k.peers.get(e);t&&(t.close(),k.peers.delete(e)),this.rtc.dataChannels.delete(e),this.rtc.negotiationMap.delete(e),this.rtc.lastConnectAttempt.delete(e),this.rtc.userList.delete(e),console.log(`ğŸ§¹ å·²æ¸…é™¤ä¸ ${e} çš„è¿æ¥èµ„æº`)}isPrivateIP(e){return e.startsWith("10.")||e.startsWith("192.168.")||e.match(/^172\.(1[6-9]|2\d|3[0-1])\./)}}const z=()=>Ye&&Qe==="iOS"?"apple":Ye&&Qe==="Android"?"android":"desktop";function ut(o,e){const[t,s]=o.split(":"),[n,a]=e.split(":");if(!s||!a)return!1;const i=s.localeCompare(a);if(i>0)return!0;if(i<0)return!1;const c=t.localeCompare(n);return c>0?!0:c<0?!1:o>e}function ee(o){return o?o.length<2?{isValid:!1,message:"æˆ¿é—´åå¤ªçŸ­å•¦ï¼Œè‡³å°‘ä¸¤ä¸ªå­—ç¬¦"}:o.length>12?{isValid:!1,message:"æˆ¿é—´åæœ€å¤š 12 ä¸ªå­—ç¬¦"}:/^[\u4e00-\u9fa5a-zA-Z0-9 _-]+$/.test(o)?{isValid:!0,message:"æˆ¿é—´ååˆæ³•"}:{isValid:!1,message:"åªèƒ½ä½¿ç”¨ä¸­æ–‡ã€å­—æ¯ã€æ•°å­—ã€ç©ºæ ¼ã€ä¸‹åˆ’çº¿æˆ–ä¸­åˆ’çº¿"}:{isValid:!1,message:"æˆ¿é—´åä¸èƒ½ä¸ºç©º"}}async function Ms(){const o=new AbortController,e=setTimeout(()=>o.abort(),3e3),t=async()=>{try{const n=await fetch("https://ipinfo.io/json?token=43b00e5b7d1add",{signal:o.signal});if(!n.ok)throw new Error("Response not OK");const a=await n.json();return{ip:a.ip?.trim()||null,region:a.region?.trim()||null,country:a.country?.trim()||null,countryCode:a.country?.trim()||null,lang:null,source:"ipinfo"}}catch(n){throw console.warn("ğŸŒ ipinfo.io è¯·æ±‚å¤±è´¥:",n),n}},s=async()=>{try{const n=await fetch("https://ipapi.co/json/",{signal:o.signal});if(!n.ok)throw new Error("Response not OK");const a=await n.json();return{ip:a.ip?.trim()||null,region:a.region?.trim()||null,country:a.country_name?.trim()||null,countryCode:a.country_code?.trim()||null,lang:a.languages?.split(",")[0]?.trim()||null,source:"ipapi"}}catch(n){throw console.warn("ğŸŒ ipapi.co è¯·æ±‚å¤±è´¥:",n),n}};try{const n=await t();return console.log("âœ… ä½¿ç”¨ä¸»æœåŠ¡å™¨ ipinfo.io è·å–IPä¿¡æ¯:",n),n}catch{console.warn("âš ï¸ ä¸»æœåŠ¡å™¨å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æœåŠ¡å™¨");try{const n=await s();return console.log("âœ… ä½¿ç”¨å¤‡ç”¨æœåŠ¡å™¨ ipapi.co è·å–IPä¿¡æ¯:",n),n}catch(n){return console.error("âŒ æ‰€æœ‰IPæ£€æµ‹æœåŠ¡éƒ½å¤±è´¥äº†:",n),{ip:null,region:null,country:null,countryCode:null,lang:null,source:null}}}finally{clearTimeout(e)}}const Xe={translation:{meta:{title:"LetShare | Perkongsian Fail & Teks Merentas Platform"},welcome:"Selamat datang ke Aplikasi Saya",language:"Bahasa",button:{file:"Fail",image:"Gambar",text:"Teks",clipboard:"Papan Klip",searchUsers:"Cari pengguna dalam Wi-Fi yang sama",disconnected:"Server telah terputus",cancel:"Batal",confirm:"Sahkan",accept:"Terima",reject:"Tolak",downloadAll:"Download All"},prompt:{dropToUpload:"Lepaskan untuk muat naik"},guide:{title:"Panduan Pengguna ğŸ‰:",step1:"1. Sambungkan kedua-dua peranti ke Wi-Fi yang <strong>sama</strong>",step2:"2. ID bilik mesti <strong>sepadan</strong> di kedua-dua peranti!"},dialog:{newShare:"âœ¨ Kongsi Baru",incomingMessage:"Anda menerima mesej, adakah anda mahu terima?",inputText:"Masukkan Teks"},placeholder:{inputText:"Sila masukkan teks untuk dihantar..."},toast:{copiedToClipboard:"Berjaya salin ke papan klip",zipFailed:"Pemampatan gagal. Sila cuba lagi.",connectingUser:"Sedang sambung ke pengguna...",taskInProgress:"Tugas sedang dijalankan!",clipboardEmpty:"Papan klip kosong atau tidak disokong.",noContentSelected:"Tiada kandungan dipilih",emptyInput:"Kosong"},transfer:{sending:"ğŸ“¤ Menghantar fail kepada <strong>{{name}}</strong>",receiving:"ğŸ“¥ Menerima fail dari <strong>{{name}}</strong>: {{filename}}",byte:"bait",receivedFiles:"ğŸ“ Fail yang diterima",noTasks:"Tiada tugas aktif"},settings:{title:"Tetapan",languageLabel:"Bahasa",languageOptions:{system:"Ikut sistem",zh:"Cina Ringkas"},roomId:{label:"ID Bilik",required:"ID bilik wajib diisi",helper:"Peranti mesti menggunakan ID bilik yang sama untuk berhubung"},saveButton:"Simpan Tetapan",joinSuccess:"Berjaya sertai bilik",advanced:{title:"Tetapan Lanjutan",serverMode:{label:"Mod Pelayan",auto:"Automatik",global:"Global",china:"China",switchSuccess:"Berjaya beralih ke pelayan {{mode}}",switchError:"Gagal beralih ke pelayan {{mode}}"},customServerUrl:{label:"URL Pelayan Tersuai",helper:"Hanya tersedia dalam mod tersuai",disabled:"Hanya tersedia dalam mod tersuai"},authToken:{label:"Token Pengesahan",helper:"Hanya tersedia dalam mod tersuai",disabled:"Hanya tersedia dalam mod tersuai"},ablyKey:{label:"Kunci Ably",helper:"Hanya tersedia dalam mod global",disabled:"Hanya tersedia dalam mod global"},resetAll:"Set Semula Semua Tetapan",resetConfirm:"Adakah anda pasti mahu menetapkan semula semua tetapan? Ini akan memadamkan semua konfigurasi dan memuat semula halaman."}},footer:{shareTitle:"Kongsi Â· Segera",qrPrompt:"Imbas kod QR untuk menyertai bilik:"},userId:{inputError:"Hanya huruf, nombor",display:"ID anda"},alert:{invalidRoom:"Nama bilik tidak sah",newUser:"Pengguna baru telah bersambung: {{name}}",transferCancelled:"Pihak lawan membatalkan pemindahan!",chunkMissing:"Kepingan {{index}} hilang. Sila hantar semula fail!",unzipping:"Sedang mengekstrak... sila tunggu",fileReceived:"Berjaya menerima fail daripada {{name}}!",disconnected:"Terputus sambungan. Sila tunggu atau segarkan semula",proxy:"IP virtual telah terdeteksi, mohon jangan gunakan proxy atau VPN, jika tidak, Anda mungkin tidak dapat terhubung!",p2pDisconnected:"Sambungan P2P dengan {{name}} terputus, beralih ke mod teks",p2pTimeout:"Sambungan P2P dengan {{name}} tamat masa, beralih ke mod teks",p2pFailed:"Sambungan P2P dengan {{name}} gagal, beralih ke mod teks",serverConnectionFailed:"Semua pelayan isyarat gagal disambungkan!",roomSwitchFailed:"Gagal menukar bilik: {{error}}",fileSendP2PRequired:"Penghantaran fail memerlukan sambungan P2P, pengguna semasa hanya menyokong mod teks"},status:{textOnly:"Teks Sahaja",connecting:"Menyambung",connected:"Bersambung",disconnected:"Terputus"},background:{timeout:"â± Halaman latar belakang melebihi {{seconds}} saat, memutuskan sambungan pelayan untuk penjimatan"}}},Fs={en:{translation:{meta:{title:"LetShare | Cross-platform File & Text Sharing"},welcome:"Welcome to My App",language:"Language",button:{file:"File",image:"Image",text:"Text",clipboard:"Clipboard",searchUsers:"Search Users in Same Wi-Fi",disconnected:"The server has been disconnected",cancel:"Cancel",confirm:"Confirm",accept:"Accept",reject:"Reject",downloadAll:"Download All"},prompt:{dropToUpload:"Drop to upload"},guide:{title:"User Guide ğŸ‰:",step1:"1. Connect both devices to the <strong>same</strong> Wi-Fi",step2:"2. Room IDs <strong>must match</strong> on both devices!"},dialog:{newShare:"âœ¨ New Share",incomingMessage:"You received a message, accept it?",inputText:"Input Text"},placeholder:{inputText:"Please enter the text to send..."},toast:{copiedToClipboard:"Copied to clipboard",zipFailed:"File compression failed. Please try again.",connectingUser:"Connecting to user, please wait...",taskInProgress:"A task is already in progress!",clipboardEmpty:"Clipboard is empty or unsupported.",noContentSelected:"No content selected",emptyInput:"It's empty"},transfer:{sending:"ğŸ“¤ Sending file to <strong>{{name}}</strong>",receiving:"ğŸ“¥ Receiving file from <strong>{{name}}</strong>: {{filename}}",byte:"byte",receivedFiles:"ğŸ“ Received Files",noTasks:"No active tasks"},settings:{title:"Settings",languageLabel:"Language",languageOptions:{system:"Follow system",zh:"Simplified Chinese"},roomId:{label:"Room ID",required:"Room ID is required",helper:"Only Same RoomId Can Connect"},saveButton:"Save Settings",joinSuccess:"Successfully joined room",advanced:{title:"Advanced Settings",serverMode:{label:"Server Mode",auto:"Auto",global:"Global",china:"China",switchSuccess:"Successfully switched to {{mode}} server",switchError:"Failed to switch to {{mode}} server"},customServerUrl:{label:"Custom Server URL",helper:"Only available in custom mode",disabled:"Only available in custom mode"},authToken:{label:"Auth Token",helper:"Only available in custom mode",disabled:"Only available in custom mode"},ablyKey:{label:"Ably Key",helper:"Only available in global mode",disabled:"Only available in global mode"},resetAll:"Reset All Settings",resetConfirm:"Are you sure you want to reset all settings? This will clear all configurations and refresh the page."}},footer:{shareTitle:"Share Â· Instantly",qrPrompt:"Scan the QR code to join room:"},chat:{noMessages:"No chat messages yet",inputPlaceholder:"Type a message...",deleteHistory:"Delete chat history",sendFile:"Send file"},userId:{inputError:"Only letters, numbers",display:"Your ID"},alert:{invalidRoom:"Invalid room name",newUser:"New user connected: {{name}}",transferCancelled:"The other party cancelled the transfer!",chunkMissing:"File chunk {{index}} missing. Please resend the file!",unzipping:"Extracting... please wait",fileReceived:"Successfully received file from {{name}}!",disconnected:"Disconnected. Please wait or refresh the page",proxy:"Virtual IP detected, please don't use proxy or VPN, otherwise you may not be able to connect!",p2pDisconnected:"P2P connection with {{name}} disconnected, switched to text mode",p2pTimeout:"P2P connection with {{name}} timed out, switched to text mode",p2pFailed:"P2P connection with {{name}} failed, switched to text mode",serverConnectionFailed:"All signaling servers failed to connect!",roomSwitchFailed:"Failed to switch room: {{error}}",fileSendP2PRequired:"File sending requires P2P connection, current user only supports text mode"},status:{textOnly:"Text Only",connecting:"Connecting",connected:"Connected",disconnected:"Disconnected"},background:{timeout:"â± Background page exceeded {{seconds}} seconds, disconnecting server for saving"}}},zh:{translation:{meta:{title:"ä¹äº«Share | æ–‡ä»¶ & æ–‡æœ¬è·¨å¹³å°å…±äº«"},welcome:"æ¬¢è¿ä½¿ç”¨æˆ‘çš„åº”ç”¨",language:"è¯­è¨€",button:{file:"æ–‡ä»¶",image:"å›¾ç‰‡",text:"æ–‡æœ¬",clipboard:"å‰ªè´´æ¿",searchUsers:"æœç´¢åŒWIFIä¸‹ç”¨æˆ·",disconnected:"æœåŠ¡å™¨å·²æ–­å¼€è¿æ¥",cancel:"å–æ¶ˆ",confirm:"ç¡®è®¤",accept:"æ¥å—",reject:"æ‹’ç»",downloadAll:"å…¨éƒ¨ä¸‹è½½"},prompt:{dropToUpload:"æ¾æ‰‹ä¸Šä¼ æ–‡ä»¶"},guide:{title:"ä½¿ç”¨æŒ‡å—ğŸ‰ï¼š",step1:"1. ä¸¤ä¸ªè®¾å¤‡è¿æ¥åˆ°<strong>åŒä¸€ä¸ª</strong>å±€åŸŸç½‘ï¼ˆéƒ¨åˆ†å…¬å…± WiFi ä¸å¯ç”¨ï¼‰",step2:"2. ä¸¤ä¸ªè®¾å¤‡æˆ¿é—´å·<strong>å¿…é¡»ç›¸åŒ</strong>ï¼"},dialog:{newShare:"âœ¨ æ–°åˆ†äº«",incomingMessage:"æ‚¨æœ‰æ¥è‡ªå¤–éƒ¨çš„æ¶ˆæ¯ï¼Œæ˜¯å¦æ¥å—ï¼Ÿ",inputText:"è¾“å…¥æ–‡æœ¬"},placeholder:{inputText:"è¯·è¾“å…¥è¦å‘é€çš„æ–‡æœ¬..."},toast:{copiedToClipboard:"æˆåŠŸå†™å…¥å‰ªè´´æ¿",zipFailed:"æ–‡ä»¶å‹ç¼©å¤±è´¥ï¼Œè¯·é‡è¯•ï¼",connectingUser:"æ­£åœ¨è¿æ¥ç›®æ ‡ç”¨æˆ·ï¼Œè¯·ç­‰å¾…è¿æ¥å»ºç«‹",taskInProgress:"æœ‰ä»»åŠ¡æ­£åœ¨è¿›è¡Œä¸­ï¼",clipboardEmpty:"å‰ªåˆ‡æ¿ä¸ºç©º, æˆ–æµè§ˆå™¨ä¸æ”¯æŒ",noContentSelected:"æœªé€‰æ‹©å‘é€å†…å®¹",emptyInput:"ç©ºå•¦"},transfer:{sending:"ğŸ“¤ æ­£åœ¨å‘é€æ–‡ä»¶ç»™ <strong>{{name}}</strong>",receiving:"ğŸ“¥ æ­£åœ¨æ¥æ”¶æ¥è‡ª <strong>{{name}}</strong> çš„æ–‡ä»¶ï¼š{{filename}}",byte:"å­—èŠ‚",receivedFiles:"ğŸ“ å·²æ¥æ”¶çš„æ–‡ä»¶",noTasks:"æ²¡æœ‰è¿›è¡Œä¸­çš„ä»»åŠ¡"},settings:{title:"è®¾ç½®",languageLabel:"è¯­è¨€/Language",languageOptions:{system:"è·Ÿéšç³»ç»Ÿ",zh:"ç®€ä½“ä¸­æ–‡"},roomId:{label:"æˆ¿é—´å·",required:"æˆ¿é—´å·å¿…å¡«å•¦",helper:"åªæœ‰åŒä¸€æˆ¿é—´å·æ‰èƒ½äº’ç›¸è¿æ¥å“¦"},saveButton:"ä¿å­˜è®¾ç½®",joinSuccess:"æˆåŠŸåŠ å…¥æˆ¿é—´",advanced:{title:"é«˜çº§è®¾ç½®",serverMode:{label:"æœåŠ¡å™¨æ¨¡å¼",auto:"è‡ªåŠ¨",global:"æµ·å¤–",china:"ä¸­å›½",switchSuccess:"æˆåŠŸåˆ‡æ¢åˆ°{{mode}}æœåŠ¡å™¨",switchError:"åˆ‡æ¢åˆ°{{mode}}æœåŠ¡å™¨å¤±è´¥"},customServerUrl:{label:"è‡ªå®šä¹‰æœåŠ¡å™¨URL",helper:"ä»…åœ¨è‡ªå®šä¹‰æ¨¡å¼ä¸‹å¯ç”¨",disabled:"ä»…åœ¨è‡ªå®šä¹‰æ¨¡å¼ä¸‹å¯ç”¨"},authToken:{label:"è®¤è¯ä»¤ç‰Œ (Auth Token)",helper:"ä»…åœ¨è‡ªå®šä¹‰æ¨¡å¼ä¸‹å¯ç”¨",disabled:"ä»…åœ¨è‡ªå®šä¹‰æ¨¡å¼ä¸‹å¯ç”¨"},ablyKey:{label:"Ably å¯†é’¥",helper:"ä»…åœ¨æµ·å¤–æ¨¡å¼ä¸‹å¯ç”¨",disabled:"ä»…åœ¨æµ·å¤–æ¨¡å¼ä¸‹å¯ç”¨"},resetAll:"é‡ç½®æ‰€æœ‰è®¾ç½®",resetConfirm:"ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰é…ç½®å¹¶åˆ·æ–°é¡µé¢ã€‚"}},footer:{shareTitle:"åˆ†äº«Â·ä¸€è§¦å³å‘",qrPrompt:"æ‰«æäºŒç»´ç ä»¥åŠ å…¥æˆ¿é—´:"},chat:{noMessages:"æš‚æ— èŠå¤©è®°å½•",inputPlaceholder:"è¾“å…¥æ¶ˆæ¯...",deleteHistory:"åˆ é™¤èŠå¤©è®°å½•",sendFile:"å‘é€æ–‡ä»¶"},userId:{inputError:"åªå…è®¸12å­—ç¬¦ä»¥å†…çš„å­—æ¯ã€æ•°å­—å’Œæ±‰å­—",display:"ä½ çš„ID"},alert:{invalidRoom:"æˆ¿é—´åä¸åˆæ³•",newUser:"æ–°ç”¨æˆ·å·²è¿æ¥: {{name}}",transferCancelled:"å¯¹æ–¹å–æ¶ˆäº†ä¼ è¾“ï¼",chunkMissing:"æ–‡ä»¶ä¼ è¾“ç¼ºå°‘åˆ‡ç‰‡ {{index}}ï¼Œè¯·é‡æ–°ä¼ è¾“ï¼",unzipping:"è§£å‹ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...",fileReceived:"æˆåŠŸæ¥å—æ¥è‡ª {{name}} çš„æ–‡ä»¶ï¼",disconnected:"ä¸å¯¹æ–¹æ–­å¼€è¿æ¥ï¼Œè¯·ç­‰å¾…æˆ–åˆ·æ–°é¡µé¢",proxy:"æ£€æµ‹åˆ°è™šæ‹ŸIPï¼Œè¯·ä¸è¦ä½¿ç”¨ä»£ç†æˆ–VPNï¼Œå¦åˆ™å¯èƒ½æ— æ³•è¿æ¥ï¼",p2pDisconnected:"ä¸ {{name}} çš„P2Pè¿æ¥æ–­å¼€ï¼Œå·²åˆ‡æ¢åˆ°æ–‡æœ¬æ¨¡å¼",p2pTimeout:"ä¸ {{name}} çš„P2Pè¿æ¥è¶…æ—¶ï¼Œå·²åˆ‡æ¢åˆ°æ–‡æœ¬æ¨¡å¼",p2pFailed:"ä¸ {{name}} çš„P2Pè¿æ¥å¤±è´¥ï¼Œå·²åˆ‡æ¢åˆ°æ–‡æœ¬æ¨¡å¼",serverConnectionFailed:"æ‰€æœ‰ä¿¡ä»¤æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼",roomSwitchFailed:"åˆ‡æ¢æˆ¿é—´å¤±è´¥: {{error}}",fileSendP2PRequired:"æ–‡ä»¶å‘é€éœ€è¦P2Pè¿æ¥ï¼Œå½“å‰ç”¨æˆ·ä»…æ”¯æŒæ–‡æœ¬æ¨¡å¼"},status:{textOnly:"ä»…æ–‡æœ¬",connecting:"è¿æ¥ä¸­",connected:"å·²è¿æ¥",disconnected:"å·²æ–­å¼€"},background:{timeout:"â± åå°é¡µé¢è¶…è¿‡ {{seconds}} ç§’ï¼Œæ–­å¼€æœåŠ¡å™¨ä»¥èŠ‚çœèµ„æº"}}},ms:Xe,id:Xe},Ds=m.get("userLanguage"),_e=Ds??"system",et=()=>{if(_e==="system"){const o=navigator.language.toLowerCase();return o.startsWith("zh")?"zh":o.startsWith("ms")?"ms":o.startsWith("id")?"id":"en"}return _e};de.use(ws).use(Cs).init({resources:Fs,lng:et(),fallbackLng:{id:["ms"],default:["en"]},interpolation:{escapeValue:!1},detection:{order:[],caches:[]}}).then(()=>{document.title=de.t("meta.title"),document.documentElement.lang=et()});class Rs{ably=null;ablyChannel=null;currentRoomId=null;config;signalCallback=null;constructor(e){this.config=e}async connect(e){if(!ee(e).isValid)return!1;try{if(!this.ably)this.ably=new vs.Realtime({key:m.get("ablyKey")}),await new Promise((t,s)=>{this.ably.connection.once("connected",t),this.ably.connection.once("failed",s)});else{const t=this.ably.connection.state;t==="closed"||t==="disconnected"||t==="suspended"?(console.log(`å½“å‰è¿æ¥çŠ¶æ€ä¸º ${t}ï¼Œå°è¯•é‡æ–°è¿æ¥ Ably...`),this.ably.connection.connect(),await this.ably.connection.whenState("connected")):t==="connecting"&&await this.ably.connection.whenState("connected")}return this.subscribeToRoom(e),!0}catch(t){return console.error("Ably è¿æ¥å¤±è´¥:",t),!1}}async disconnect(e){this.ablyChannel?.unsubscribe(),this.ablyChannel=null,this.ably&&(e?this.ably.connection.close():(this.ably.connection.close(),this.ably=null))}broadcastSignal(e){const t={...e,from:this.config.uniqId};this.ablyChannel&&(e.to?this.ablyChannel.publish(`signal:${e.to}`,t):this.ablyChannel.publish("signal:all",t))}onSignalReceived(e){this.signalCallback=e}isConnected(){return this.ably?.connection.state==="connected"}async switchRoom(e){if(!ee(e).isValid)throw new Error("Invalid room name");if(!this.ably||this.ably.connection.state!=="connected"){await this.connect(e);return}this.subscribeToRoom(e)}getConnectionType(){return"ably"}subscribeToRoom(e){if(!ee(e).isValid)return!1;if(!this.ably)return;this.ablyChannel&&(this.ablyChannel.unsubscribe(),console.log(`[A]ç¦»å¼€æ—§æˆ¿é—´: ${this.currentRoomId}`)),this.ablyChannel=this.ably.channels.get(e),this.currentRoomId=e;const t=this.config.uniqId;this.ablyChannel.subscribe(`signal:${t}`,s=>{this.handleSignal({data:JSON.stringify(s.data)})}),this.ablyChannel.subscribe("signal:all",s=>{this.handleSignal({data:JSON.stringify(s.data)})})}handleSignal(e){this.signalCallback&&this.signalCallback(e)}}class Us{ws=null;currentRoomId=null;config;signalCallback=null;messageCallback=null;binaryCallback=null;isSubscribed=!1;constructor(e){this.config=e}async connect(e){if(!ee(e).isValid)return!1;try{const t=m.get("authToken");if(!t)return console.error("âŒ ç¼ºå°‘è®¤è¯Tokenï¼Œè¯·åœ¨è®¾ç½®ä¸­é…ç½®"),!1;const n=`${m.get("customServerUrl")}?token=${t}&userId=${this.config.uniqId}`;return this.ws=new WebSocket(n),new Promise((a,i)=>{if(!this.ws){i(new Error("WebSocketåˆ›å»ºå¤±è´¥"));return}const c=setTimeout(()=>{i(new Error("è¿æ¥è¶…æ—¶"))},1e4);this.ws.onopen=async()=>{clearTimeout(c),console.log("âœ… å·²è¿æ¥è‡ªå®šä¹‰æœåŠ¡å™¨"),await this.subscribeToRoom(e),a(!0)},this.ws.onmessage=l=>{l.data instanceof ArrayBuffer?this.handleBinaryMessage(l.data):l.data instanceof Blob?l.data.arrayBuffer().then(h=>{this.handleBinaryMessage(h)}):this.handleMessage(l)},this.ws.onclose=()=>{clearTimeout(c),console.warn("ğŸ”Œ WebSocketè¿æ¥å…³é—­")},this.ws.onerror=l=>{clearTimeout(c),console.error("âŒ WebSocketè¿æ¥é”™è¯¯:",l),i(l)}})}catch(t){return console.error("âŒ è‡ªå®šä¹‰æœåŠ¡å™¨è¿æ¥å¤±è´¥:",t),!1}}async disconnect(e){this.ws&&(this.isSubscribed&&this.currentRoomId&&await this.unsubscribeFromRoom(),this.ws.onclose=null,this.ws.close(),this.ws=null),this.isSubscribed=!1,this.currentRoomId=null}broadcastSignal(e){if(this.ws&&this.ws.readyState===WebSocket.OPEN&&this.isSubscribed){const t={...e,from:this.config.uniqId},s={type:"publish",channel:this.currentRoomId,event:e.to?`signal:${e.to}`:"signal:all",data:t};this.ws.send(JSON.stringify(s))}}onSignalReceived(e){this.signalCallback=e}isConnected(){return this.ws!==null&&this.ws.readyState===WebSocket.OPEN&&this.isSubscribed}async switchRoom(e){if(!ee(e).isValid)throw new Error("Invalid room name");this.isSubscribed&&this.currentRoomId&&await this.unsubscribeFromRoom(),await this.subscribeToRoom(e)}getConnectionType(){return"custom"}send(e){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(e)):console.error("âŒ WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯")}sendBinary(e){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(e):console.error("âŒ WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€äºŒè¿›åˆ¶æ•°æ®")}onMessageReceived(e){this.messageCallback=e}onBinaryReceived(e){this.binaryCallback=e}getUniqId(){return this.config.uniqId}async subscribeToRoom(e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)throw new Error("WebSocketæœªè¿æ¥");return new Promise((t,s)=>{if(!this.ws){s(new Error("WebSocketæœªè¿æ¥"));return}const n=setTimeout(()=>{s(new Error("è®¢é˜…è¶…æ—¶"))},5e3),a=this.ws.onmessage,i=this;this.ws.onmessage=function(h){try{const d=JSON.parse(h.data);if(d.type==="subscribed"&&d.channel===e){clearTimeout(n),i.currentRoomId=e,i.isSubscribed=!0,i.ws&&(i.ws.onmessage=a),t();return}}catch{}a&&a.call(this,h)};const c={type:"subscribe",channel:e,event:`signal:${this.config.uniqId}`};this.ws.send(JSON.stringify(c));const l={type:"subscribe",channel:e,event:"signal:all"};this.ws.send(JSON.stringify(l))})}async unsubscribeFromRoom(){if(!this.ws||this.ws.readyState!==WebSocket.OPEN||!this.currentRoomId)return;const e={type:"unsubscribe",channel:this.currentRoomId,event:`signal:${this.config.uniqId}`};this.ws.send(JSON.stringify(e));const t={type:"unsubscribe",channel:this.currentRoomId,event:"signal:all"};this.ws.send(JSON.stringify(t)),this.isSubscribed=!1,this.currentRoomId=null}handleMessage(e){try{const t=JSON.parse(e.data);let s=null;if(t.data)try{s=typeof t.data=="string"?JSON.parse(t.data):t.data}catch{s=t.data}if(s&&s.type&&s.type.startsWith("file:transfer:")){console.log(`[CustomConnectionProvider] æ”¶åˆ°æ–‡ä»¶ä¼ è¾“æ¶ˆæ¯: ${s.type}`),this.messageCallback&&this.messageCallback(s);return}if(t.type==="message"&&t.channel&&(t.event==="signal:all"||t.event===`signal:${this.config.uniqId}`)){const n={data:JSON.stringify(t.data)};this.signalCallback&&this.signalCallback(n);return}if(t.type&&t.type.startsWith("file:transfer:")){console.log(`[CustomConnectionProvider] æ”¶åˆ°é¡¶å±‚æ–‡ä»¶ä¼ è¾“æ¶ˆæ¯: ${t.type}`),this.messageCallback&&this.messageCallback(t);return}this.messageCallback&&this.messageCallback(t)}catch(t){console.error("âŒ å¤„ç†æœåŠ¡å™¨æ¶ˆæ¯å¤±è´¥:",t)}}handleBinaryMessage(e){const t=e.byteLength;if(console.log(`[CustomConnectionProvider] æ”¶åˆ°äºŒè¿›åˆ¶æ¶ˆæ¯: ${t} å­—èŠ‚`),t>0){const n=new Uint8Array(e).slice(0,Math.min(32,t));console.log(`[CustomConnectionProvider] å‰${n.length}å­—èŠ‚:`,Array.from(n).map(a=>a.toString(16).padStart(2,"0")).join(" "))}this.binaryCallback?this.binaryCallback(e):console.warn("[CustomConnectionProvider] âš ï¸ æ²¡æœ‰è®¾ç½®äºŒè¿›åˆ¶å›è°ƒå‡½æ•°ï¼Œæ•°æ®è¢«å¿½ç•¥")}}class Ns{currentProvider=null;config;failureCount=new Map;maxFailures=1;signalCallback=null;messageCallback=null;binaryCallback=null;constructor(e){this.config=e}async connect(e){const t=m.get("serverMode");return t==="ably"?this.connectWithProvider("ably",e):t==="custom"?this.connectWithProvider("custom",e):this.connectAuto(e)}async disconnect(e){this.currentProvider&&(await this.currentProvider.disconnect(e),this.currentProvider=null)}broadcastSignal(e){this.currentProvider&&this.currentProvider.broadcastSignal(e)}onSignalReceived(e){this.signalCallback=e,this.currentProvider&&this.currentProvider.onSignalReceived(e)}isConnected(){return this.currentProvider?.isConnected()??!1}async switchRoom(e){if(this.currentProvider)await this.currentProvider.switchRoom(e);else throw new Error("æ²¡æœ‰æ´»è·ƒçš„è¿æ¥æä¾›è€…")}getConnectionType(){return this.currentProvider?.getConnectionType()??"none"}send(e){this.currentProvider?.send?this.currentProvider.send(e):console.error("âŒ å½“å‰è¿æ¥æä¾›è€…ä¸æ”¯æŒsendæ–¹æ³•")}sendBinary(e){this.currentProvider?.sendBinary?this.currentProvider.sendBinary(e):console.error("âŒ å½“å‰è¿æ¥æä¾›è€…ä¸æ”¯æŒsendBinaryæ–¹æ³•")}onMessageReceived(e){this.messageCallback=e,this.currentProvider?.onMessageReceived&&this.currentProvider.onMessageReceived(e)}onBinaryReceived(e){this.binaryCallback=e,this.currentProvider?.onBinaryReceived&&this.currentProvider.onBinaryReceived(e)}getUniqId(){return this.currentProvider?.getUniqId?.()??this.config.uniqId}async connectAuto(e){const t=await Ms(),s=this.isOverseasRegion(t);m.updateUnrmb("staticIp",t.ip||"");const n=s?"ably":"custom",a=s?"custom":"ably";return await this.connectWithProvider(n,e)||(console.warn(`âŒ ${n} è¿æ¥å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æä¾›è€… ${a}`),await this.connectWithProvider(a,e))?!0:(console.error("âŒ æ‰€æœ‰è¿æ¥æä¾›è€…éƒ½å¤±è´¥äº†"),!1)}async connectWithProvider(e,t){const s=this.failureCount.get(e)||0;if(s>=this.maxFailures)return console.warn(`âš ï¸ ${e} æä¾›è€…å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼Œè·³è¿‡`),!1;try{this.currentProvider&&await this.currentProvider.disconnect();let n;return e==="ably"?n=new Rs(this.config):n=new Us(this.config),this.signalCallback&&n.onSignalReceived(this.signalCallback),this.messageCallback&&n.onMessageReceived&&n.onMessageReceived(this.messageCallback),this.binaryCallback&&n.onBinaryReceived&&n.onBinaryReceived(this.binaryCallback),await n.connect(t)?(this.currentProvider=n,this.signalCallback&&this.currentProvider.onSignalReceived(this.signalCallback),this.messageCallback&&this.currentProvider.onMessageReceived&&this.currentProvider.onMessageReceived(this.messageCallback),this.binaryCallback&&this.currentProvider.onBinaryReceived&&this.currentProvider.onBinaryReceived(this.binaryCallback),this.failureCount.set(e,0),console.log(`âœ… æˆåŠŸè¿æ¥åˆ° ${e} æä¾›è€…`),!0):(this.failureCount.set(e,s+1),console.warn(`âŒ ${e} æä¾›è€…è¿æ¥å¤±è´¥ (${s+1}/${this.maxFailures})`),!1)}catch(n){const a=this.failureCount.get(e)||0;return this.failureCount.set(e,a+1),console.error(`âŒ ${e} æä¾›è€…è¿æ¥å¼‚å¸¸:`,n),!1}}isOverseasRegion(e){if(!e.countryCode&&!e.country)return console.warn("âš ï¸ æ— æ³•è·å–åœ°åŒºä¿¡æ¯ï¼Œé»˜è®¤ä½¿ç”¨å›½å†…æœåŠ¡å™¨"),!1;const t=e.countryCode?.toUpperCase(),s=e.country?.toLowerCase();return t==="CN"||t==="CHN"||s==="china"||s==="ä¸­å›½"||s?.includes("china")||s?.includes("ä¸­å›½")?(console.log("ğŸ‡¨ğŸ‡³ æ£€æµ‹åˆ°ä¸­å›½å¤§é™†ï¼Œä½¿ç”¨å›½å†…æœåŠ¡å™¨"),!1):(console.log(`ğŸŒ æ£€æµ‹åˆ°æµ·å¤–åœ°åŒº (${t}/${s})ï¼Œä½¿ç”¨æµ·å¤–æœåŠ¡å™¨`),!0)}resetFailureCount(){this.failureCount.clear()}getFailureCount(e){return this.failureCount.get(e)||0}}class ce{static instance=null;keyPairs=new Map;signingKeys=new Map;sharedSecrets=new Map;userPublicKeys=new Map;processedMessages=new Set;constructor(){}static getInstance(){return ce.instance||(ce.instance=new ce),ce.instance}async initializeForUser(e){const t=await this.generateSeedFromUniqId(e),s=await this.generateDeterministicKeyPair(t,"ECDH");this.keyPairs.set(e,s);const n=await this.generateDeterministicKeyPair(t+"_sign","ECDSA");this.signingKeys.set(e,n);const a=await this.exportPublicKey(s.publicKey),i=await this.exportPublicKey(n.publicKey),c=await this.signPublicKey(n.privateKey,a);return console.log(`ğŸ” å·²ä¸ºç”¨æˆ· ${e} åˆå§‹åŒ–åŠ å¯†å¯†é’¥`),{publicKeyDH:a,publicKeySign:i,signature:c}}async generateSeedFromUniqId(e){const s=new TextEncoder().encode(e+"LetShare_E2E_Seed"),n=await crypto.subtle.digest("SHA-256",s),a=new Uint8Array(n);return btoa(String.fromCharCode(...a))}async generateDeterministicKeyPair(e,t){const s=t==="ECDH"?["deriveKey"]:["sign","verify"];return await crypto.subtle.generateKey({name:t,namedCurve:"P-256"},!0,s)}async registerUserPublicKeys(e,t){if(!await this.verifyPublicKeySignature(t.publicKeySign,t.publicKeyDH,t.signature))throw new Error(`ğŸ” ç”¨æˆ· ${e} çš„å…¬é’¥ç­¾åéªŒè¯å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨ä¸­é—´äººæ”»å‡»`);console.log(`ğŸ” âœ… ç”¨æˆ· ${e} çš„å…¬é’¥ç­¾åéªŒè¯é€šè¿‡`),this.userPublicKeys.set(e,t),await this.computeSharedSecret(e,t.publicKeyDH),console.log(`ğŸ”‘ å·²æ³¨å†Œç”¨æˆ· ${e} çš„å…¬é’¥å¹¶è®¡ç®—å…±äº«å¯†é’¥`)}async computeSharedSecret(e,t){const s=Array.from(this.keyPairs.keys());if(s.length===0)throw new Error("æœ¬åœ°å¯†é’¥å¯¹æœªåˆå§‹åŒ–");const n=s[0],a=this.keyPairs.get(n);if(!a)throw new Error("æœ¬åœ°å¯†é’¥å¯¹æœªåˆå§‹åŒ–");const i=await this.importPublicKey(t,"ECDH"),c=await crypto.subtle.deriveKey({name:"ECDH",public:i},a.privateKey,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"]);this.sharedSecrets.set(e,c)}async encryptTextMessage(e,t,s){const n=this.sharedSecrets.get(t);if(!n)throw new Error(`ä¸ç”¨æˆ· ${t} çš„å…±äº«å¯†é’¥æœªå»ºç«‹`);const a=crypto.getRandomValues(new Uint8Array(12)),i=Date.now(),c={content:s,timestamp:i,fromUniqId:e},l=await crypto.subtle.encrypt({name:"AES-GCM",iv:a},n,new TextEncoder().encode(JSON.stringify(c))),h=btoa(String.fromCharCode(...new Uint8Array(l))),d=btoa(String.fromCharCode(...a)),b=this.signingKeys.get(e);if(!b)throw new Error(`ç”¨æˆ· ${e} çš„ç­¾åå¯†é’¥æœªæ‰¾åˆ°`);const g=h+d+i.toString(),p=await this.signData(b.privateKey,g);return{encryptedData:h,iv:d,timestamp:i,fromUniqId:e,signature:p}}async decryptTextMessage(e,t){const s=this.sharedSecrets.get(e);if(!s)throw new Error(`ä¸ç”¨æˆ· ${e} çš„å…±äº«å¯†é’¥æœªå»ºç«‹`);const n=`${e}_${t.timestamp}_${t.iv}`;if(this.processedMessages.has(n))throw new Error("æ£€æµ‹åˆ°é‡æ”¾æ”»å‡»");if(Date.now()-t.timestamp>5*60*1e3)throw new Error("æ¶ˆæ¯å·²è¿‡æœŸ");const i=this.userPublicKeys.get(e);if(i){const c=await this.importPublicKey(i.publicKeySign,"ECDSA"),l=t.encryptedData+t.iv+t.timestamp.toString();if(!await this.verifyDataSignature(c,t.signature,l))throw new Error("ğŸ” æ¶ˆæ¯ç­¾åéªŒè¯å¤±è´¥ï¼Œæ¶ˆæ¯å¯èƒ½è¢«ç¯¡æ”¹")}try{const c=Uint8Array.from(atob(t.encryptedData),g=>g.charCodeAt(0)),l=Uint8Array.from(atob(t.iv),g=>g.charCodeAt(0)),h=await crypto.subtle.decrypt({name:"AES-GCM",iv:l},s,c),d=new TextDecoder().decode(h),b=JSON.parse(d);if(b.fromUniqId!==e)throw new Error("å‘é€è€…èº«ä»½éªŒè¯å¤±è´¥");return this.processedMessages.add(n),this.cleanupProcessedMessages(),console.log(`ğŸ”“ æˆåŠŸè§£å¯†æ¥è‡ªç”¨æˆ· ${e} çš„æ¶ˆæ¯`),b.content}catch(c){throw console.error("è§£å¯†å¤±è´¥:",c),new Error("æ¶ˆæ¯è§£å¯†å¤±è´¥")}}canEncryptForUser(e){return this.sharedSecrets.has(e)}getUserPublicKeys(e){return this.userPublicKeys.get(e)||null}clearUserData(e){this.sharedSecrets.delete(e),this.userPublicKeys.delete(e);const t=[];this.processedMessages.forEach(s=>{s.startsWith(e+"_")&&t.push(s)}),t.forEach(s=>this.processedMessages.delete(s)),console.log(`ğŸ§¹ å·²æ¸…ç†ç”¨æˆ· ${e} çš„åŠ å¯†æ•°æ®`)}cleanupProcessedMessages(){const e=Date.now(),t=[];this.processedMessages.forEach(s=>{const n=s.split("_");if(n.length>=2){const a=parseInt(n[1]);e-a>5*60*1e3&&t.push(s)}}),t.forEach(s=>this.processedMessages.delete(s))}async signPublicKey(e,t){const n=new TextEncoder().encode(t),a=await crypto.subtle.sign({name:"ECDSA",hash:"SHA-256"},e,n);return btoa(String.fromCharCode(...new Uint8Array(a)))}async verifyPublicKeySignature(e,t,s){try{const n=await this.importPublicKey(e,"ECDSA"),i=new TextEncoder().encode(t),c=Uint8Array.from(atob(s),l=>l.charCodeAt(0));return await crypto.subtle.verify({name:"ECDSA",hash:"SHA-256"},n,c,i)}catch(n){return console.error("å…¬é’¥ç­¾åéªŒè¯å¤±è´¥:",n),!1}}async signData(e,t){const n=new TextEncoder().encode(t),a=await crypto.subtle.sign({name:"ECDSA",hash:"SHA-256"},e,n);return btoa(String.fromCharCode(...new Uint8Array(a)))}async verifyDataSignature(e,t,s){try{const a=new TextEncoder().encode(s),i=Uint8Array.from(atob(t),c=>c.charCodeAt(0));return await crypto.subtle.verify({name:"ECDSA",hash:"SHA-256"},e,i,a)}catch(n){return console.error("æ•°æ®ç­¾åéªŒè¯å¤±è´¥:",n),!1}}async exportPublicKey(e){const t=await crypto.subtle.exportKey("spki",e);return btoa(String.fromCharCode(...new Uint8Array(t)))}async importPublicKey(e,t){const s=Uint8Array.from(atob(e),a=>a.charCodeAt(0)),n=t==="ECDH"?["deriveKey"]:["verify"];return await crypto.subtle.importKey("spki",s,{name:t,namedCurve:"P-256"},!1,n)}}class Ls{encryption;currentUniqId="";isInitialized=!1;constructor(){this.encryption=ce.getInstance()}async initialize(e){this.currentUniqId=e;const t=await this.encryption.initializeForUser(e);return this.isInitialized=!0,t}async registerUserKeys(e,t){if(!this.isInitialized){console.warn("âš ï¸ åŠ å¯†åŠŸèƒ½æœªåˆå§‹åŒ–ï¼Œè·³è¿‡å¯†é’¥æ³¨å†Œ");return}try{await this.encryption.registerUserPublicKeys(e,t)}catch(s){if(console.error(`âŒ æ³¨å†Œç”¨æˆ· ${e} å¯†é’¥å¤±è´¥:`,s),s instanceof Error&&s.message.includes("ç­¾åéªŒè¯å¤±è´¥"))throw console.error(`ğŸš¨ æ£€æµ‹åˆ°å¯èƒ½çš„ä¸­é—´äººæ”»å‡»ï¼ç”¨æˆ· ${e} çš„å…¬é’¥ç­¾åæ— æ•ˆ`),s}}async wrapOutgoingMessage(e,t){if(t.type==="text"&&t.message&&this.canEncryptForUser(e))try{const s=await this.encryption.encryptTextMessage(this.currentUniqId,e,t.message);return{...t,type:"encrypted_text",encryptedMessage:s,message:void 0}}catch(s){return console.warn("âš ï¸ æ¶ˆæ¯åŠ å¯†å¤±è´¥ï¼Œä½¿ç”¨æ˜æ–‡å‘é€:",s),t}return t}async unwrapIncomingMessage(e,t){if(t.type==="encrypted_text"&&t.encryptedMessage)try{const s=await this.encryption.decryptTextMessage(e,t.encryptedMessage);return{...t,type:"text",message:s,encryptedMessage:void 0}}catch(s){return console.error("âŒ æ¶ˆæ¯è§£å¯†å¤±è´¥:",s),s instanceof Error&&s.message.includes("ç­¾åéªŒè¯å¤±è´¥")?(console.error(`ğŸš¨ æ£€æµ‹åˆ°æ¶ˆæ¯ç¯¡æ”¹ï¼æ¥è‡ª ${e} çš„æ¶ˆæ¯ç­¾åæ— æ•ˆ`),{type:"text",message:"[ğŸš¨ æ£€æµ‹åˆ°æ¶ˆæ¯ç¯¡æ”¹ï¼Œå·²æ‹’ç»æ˜¾ç¤º]",error:!0}):{type:"text",message:"[ğŸ”’ åŠ å¯†æ¶ˆæ¯è§£å¯†å¤±è´¥]",error:!0}}return t}canEncryptForUser(e){return this.isInitialized?this.encryption.canEncryptForUser(e):!1}getCurrentUserPublicKeys(){return this.isInitialized?this.encryption.getUserPublicKeys(this.currentUniqId):null}clearUserData(e){this.encryption.clearUserData(e)}isEncryptedMessage(e){return e.type==="encrypted_text"&&!!e.encryptedMessage}isReady(){return this.isInitialized}getEncryptionStatus(){const e=[];return{initialized:this.isInitialized,currentUser:this.currentUniqId,encryptedUsers:e}}getCurrentUniqId(){return this.currentUniqId}}const q=de.t,O={REQUEST:"file:transfer:request",ACCEPT:"file:transfer:accept",REJECT:"file:transfer:reject",START:"file:transfer:start",CHUNK:"file:transfer:chunk",END:"file:transfer:end",CANCEL:"file:transfer:cancel",ERROR:"file:transfer:error",PROGRESS:"file:transfer:progress"};class Os{connectionManager;sendingSessions=new Map;receivingSessions=new Map;DEFAULT_CHUNK_SIZE=64*1024;onProgressCallback=null;onFileReceivedCallback=null;currentSendingTransferId=null;onDownloadPageStateChange=null;onFileMetaInfoChange=null;constructor(e){this.connectionManager=e,this.setupMessageHandlers()}setProgressCallback(e){this.onProgressCallback=e}setFileReceivedCallback(e){this.onFileReceivedCallback=e}setDownloadPageStateCallback(e){this.onDownloadPageStateChange=e}setFileMetaInfoCallback(e){this.onFileMetaInfoChange=e}setupMessageHandlers(){}handleFileTransferMessage(e,t){switch(console.log(`[ServerFileTransfer] Received message type: ${e}`,t),e){case O.REQUEST:this.handleTransferRequest(t);break;case O.ACCEPT:this.handleTransferAccept(t);break;case O.REJECT:this.handleTransferReject(t);break;case O.START:this.handleTransferStart(t);break;case O.CHUNK:this.handleTransferChunk(t);break;case O.END:this.handleTransferEnd(t);break;case O.CANCEL:this.handleTransferCancel(t);break;case O.ERROR:this.handleTransferError(t);break;case O.PROGRESS:this.handleTransferProgress(t);break}}handleBinaryData(e){console.log(`[ServerFileTransfer] Received binary data: ${e.byteLength} bytes`);for(const[t,s]of this.receivingSessions)if(s.status==="receiving"){const n=s.receivedChunks.size;s.receivedChunks.set(n,e);const a=s.receivedChunks.size/s.totalChunks*100;this.onProgressCallback?.(a),console.log(`[ServerFileTransfer] Chunk ${n+1}/${s.totalChunks} received (${a.toFixed(1)}%)`),s.receivedChunks.size===s.totalChunks&&this.assembleAndSaveFile(s);break}}async sendFileViaServer(e,t,s){const n=this.generateTransferId(),a=this.DEFAULT_CHUNK_SIZE,i=Math.ceil(t.size/a);console.log("[ServerFileTransfer] Sending file via server:",{transferId:n,fileName:t.name,fileSize:t.size,totalChunks:i,toUserId:e});const c={transferId:n,file:t,toUserId:e,totalChunks:i,chunkSize:a,sentChunks:0,status:"pending"};this.sendingSessions.set(n,c),this.currentSendingTransferId=n;const l={type:O.REQUEST,channel:s,data:{transfer_id:n,file_name:t.name,file_size:t.size,file_type:t.type||"application/octet-stream",chunk_size:a,total_chunks:i,from_user_id:this.connectionManager.getUniqId(),to_user_id:e,room_name:s}};console.log("[ServerFileTransfer] å‘é€ REQUEST æ¶ˆæ¯:",l),this.connectionManager.send(l),console.log(`[ServerFileTransfer] âœ… REQUEST æ¶ˆæ¯å·²å‘é€ç»™ ${e}`),x(q("toast.waitingForAccept"),2e3,{kind:"info"})}async handleTransferRequest(e){console.log("[ServerFileTransfer] Received transfer request:",e);const t={transferId:e.transfer_id,fileName:e.file_name,fileSize:e.file_size,fileType:e.file_type,totalChunks:e.total_chunks,chunkSize:e.chunk_size,receivedChunks:new Map,fromUserId:e.from_user_id,roomName:e.room_name,status:"pending"};this.receivingSessions.set(e.transfer_id,t),await this.showAcceptDialog(e)?this.acceptTransfer(e.transfer_id,e.from_user_id):this.rejectTransfer(e.transfer_id,e.from_user_id,"ç”¨æˆ·æ‹’ç»")}async showAcceptDialog(e){const t=(e.file_size/1048576).toFixed(2),s=e.from_user_id.split(":")[0];return console.log("[ServerFileTransfer] æ”¶åˆ°æ–‡ä»¶ä¼ è¾“è¯·æ±‚:"),console.log(`  - æ¥è‡ª: ${s}`),console.log(`  - æ–‡ä»¶å: ${e.file_name}`),console.log(`  - å¤§å°: ${t} MB`),console.log("[ServerFileTransfer] è‡ªåŠ¨æ¥å—æ–‡ä»¶ä¼ è¾“"),x(`${s} æ­£åœ¨å‘é€æ–‡ä»¶: ${e.file_name} (${t} MB)`,3e3,{kind:"info"}),Promise.resolve(!0)}acceptTransfer(e,t){const s=this.receivingSessions.get(e);if(!s){console.error(`[ServerFileTransfer] âŒ Session not found: ${e}`);return}s.status="receiving",this.onFileMetaInfoChange?.(s.fileName),this.onDownloadPageStateChange?.(!0),this.onProgressCallback?.(0),console.log("[ServerFileTransfer] å‡†å¤‡å‘é€ ACCEPT æ¶ˆæ¯:",{transferId:e,toUserId:t,roomName:s.roomName,isConnected:this.connectionManager.isConnected()});try{const n={type:O.ACCEPT,channel:s.roomName,data:{transfer_id:e}};console.log("[ServerFileTransfer] å‘é€ ACCEPT æ¶ˆæ¯:",n),this.connectionManager.send(n),console.log(`[ServerFileTransfer] âœ… ACCEPT æ¶ˆæ¯å·²å‘é€: ${e}`)}catch(n){console.error("[ServerFileTransfer] âŒ å‘é€ ACCEPT æ¶ˆæ¯å¤±è´¥:",n)}console.log(`[ServerFileTransfer] Accepted transfer: ${e}`),x(q("toast.receivingFile"),2e3,{kind:"info"})}rejectTransfer(e,t,s){const n=this.receivingSessions.get(e);if(this.receivingSessions.delete(e),n){const a={type:O.REJECT,channel:n.roomName,data:{transfer_id:e,reason:s}};this.connectionManager.send(a)}console.log(`[ServerFileTransfer] Rejected transfer: ${e}`),x(q("toast.transferRejected"),2e3,{kind:"info"})}async handleTransferAccept(e){console.log("[ServerFileTransfer] æ”¶åˆ° ACCEPT æ¶ˆæ¯:",e);const t=this.sendingSessions.get(e.transfer_id);if(!t){console.error(`[ServerFileTransfer] âŒ Sending session not found: ${e.transfer_id}`),console.log("[ServerFileTransfer] å½“å‰å‘é€ä¼šè¯:",Array.from(this.sendingSessions.keys()));return}t.status="accepted",console.log(`[ServerFileTransfer] âœ… Transfer accepted: ${e.transfer_id}`);try{await this.startSending(t)}catch(s){console.error("[ServerFileTransfer] âŒ å¼€å§‹å‘é€æ–‡ä»¶å¤±è´¥:",s),x(q("toast.fileTransferFailed"),3e3,{kind:"error"})}}handleTransferReject(e){if(!this.sendingSessions.get(e.transfer_id))return;const s=e.transfer_id;this.sendingSessions.delete(s),this.onProgressCallback?.(null),this.onDownloadPageStateChange?.(!1),x(`${q("toast.transferRejected")}: ${e.reason||"æœªçŸ¥åŸå› "}`,3e3,{kind:"warning"}),console.log(`[ServerFileTransfer] Transfer rejected: ${s}`)}async startSending(e){e.status="transferring",this.onFileMetaInfoChange?.(e.file.name),this.onDownloadPageStateChange?.(!0),this.onProgressCallback?.(0),this.connectionManager.send({type:O.START,data:{transfer_id:e.transferId}});for(let t=0;t<e.totalChunks;t++){const s=t*e.chunkSize,a=await e.file.slice(s,s+e.chunkSize).arrayBuffer(),i={transfer_id:e.transferId,chunk_index:t,chunk_size:a.byteLength,total_chunks:e.totalChunks},c=JSON.stringify(i),l=new TextEncoder().encode(c),h=256,d=new Uint8Array(h);d.set(l);const b=new Uint8Array(h+a.byteLength);b.set(d,0),b.set(new Uint8Array(a),h),this.connectionManager.sendBinary(b.buffer),e.sentChunks++;const g=e.sentChunks/e.totalChunks*100;this.onProgressCallback?.(g),console.log(`[ServerFileTransfer] Sent chunk ${t+1}/${e.totalChunks}`),await new Promise(p=>setTimeout(p,10))}this.connectionManager.send({type:O.END,data:{transfer_id:e.transferId}}),console.log(`[ServerFileTransfer] File sending completed: ${e.transferId}`),setTimeout(()=>{this.onProgressCallback?.(null),this.onDownloadPageStateChange?.(!1)},1500)}handleTransferStart(e){const t=this.receivingSessions.get(e.transfer_id);t&&(t.status="receiving",console.log(`[ServerFileTransfer] Transfer started: ${e.transfer_id}`))}handleTransferChunk(e){console.log("[ServerFileTransfer] Chunk metadata received:",e)}handleTransferEnd(e){const t=this.sendingSessions.get(e.transfer_id);t&&(t.status="completed",this.sendingSessions.delete(e.transfer_id),x(q("toast.fileSent"),2e3,{kind:"success"}),console.log(`[ServerFileTransfer] Send completed: ${e.transfer_id}`));const s=this.receivingSessions.get(e.transfer_id);s&&(s.status="completed",console.log(`[ServerFileTransfer] Receive completed: ${e.transfer_id}`))}handleTransferCancel(e){this.sendingSessions.delete(e.transfer_id),this.receivingSessions.delete(e.transfer_id),this.onProgressCallback?.(null),this.onDownloadPageStateChange?.(!1),x(`${q("toast.transferCancelled")}: ${e.reason||""}`,2e3,{kind:"warning"}),console.log(`[ServerFileTransfer] Transfer cancelled: ${e.transfer_id}`)}handleTransferError(e){this.sendingSessions.delete(e.transfer_id),this.receivingSessions.delete(e.transfer_id),this.onProgressCallback?.(null),this.onDownloadPageStateChange?.(!1),x(`${q("toast.transferError")}: ${e.error||""}`,3e3,{kind:"error"}),console.error(`[ServerFileTransfer] Transfer error: ${e.transfer_id}`,e.error)}handleTransferProgress(e){console.log(`[ServerFileTransfer] Progress: ${e.percentage.toFixed(2)}%`),this.onProgressCallback?.(e.percentage)}async assembleAndSaveFile(e){console.log(`[ServerFileTransfer] Assembling file: ${e.fileName}`);const t=[];for(let a=0;a<e.totalChunks;a++){const i=e.receivedChunks.get(a);if(!i){console.error(`[ServerFileTransfer] Missing chunk ${a}`),x(q("toast.fileAssemblyError"),3e3,{kind:"error"}),this.onProgressCallback?.(null),this.onDownloadPageStateChange?.(!1);return}t.push(i)}const s=new Blob(t,{type:e.fileType}),n=new File([s],e.fileName,{type:e.fileType});console.log("[ServerFileTransfer] File assembled successfully:",{name:n.name,size:n.size,type:n.type}),this.onFileReceivedCallback?.(n,e.fromUserId),this.receivingSessions.delete(e.transferId),setTimeout(()=>{this.onProgressCallback?.(null),this.onDownloadPageStateChange?.(!1)},1500),x(q("toast.fileReceived"),2e3,{kind:"success"})}cancelCurrentTransfer(){this.currentSendingTransferId&&this.sendingSessions.get(this.currentSendingTransferId)&&(this.connectionManager.send({type:O.CANCEL,data:{transfer_id:this.currentSendingTransferId,reason:"ç”¨æˆ·å–æ¶ˆ"}}),this.sendingSessions.delete(this.currentSendingTransferId),this.currentSendingTransferId=null,this.onProgressCallback?.(null))}generateTransferId(){return`transfer_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}isSending(){return this.currentSendingTransferId!==null}}const K={USER_CHECK_INTERVAL:5e3,CONNECTION_TIMEOUT:3e3,MAX_RETRY_ATTEMPTS:3,CONNECT_ATTEMPT_COOLDOWN:4e3,HEARTBEAT_INTERVAL:3e3,PEER_RESET_COOLDOWN:5e3,BACKGROUND_TIMEOUT:3e4,RETRY_SEND_DELAY:100,LEAVE_MESSAGE_DELAY:200,DISCOVER_REPLY_DELAY:500,TRANSFER_COMPLETE_DELAY:1500},U=de.t;class k{static instance=null;static isCreating=!1;static userId=null;static uniqId=null;static peers=new Map;emitter=Ne();activeChatUserId=null;constructor(){const e=this.getStatesMemorable();let t=e.memorable.userId,s=e.memorable.uniqId;this.peerManager=new Oe(this),t||(t=this.generateUUID(),this.changeStatesMemorable({memorable:{userId:t}})),s||(s=`${t}:${this.generateUUID()}`,this.changeStatesMemorable({memorable:{uniqId:s}})),k.userId=t,k.uniqId=s;const n={roomId:m.get("roomId")||"default-room",uniqId:s};this.connectionManager=new Ns(n),this.secureWrapper=new Ls,this.serverFileTransfer=new Os(this.connectionManager)}connectionManager;serverFileTransfer=null;secureWrapper;userPublicKeys=new Map;userList=new Map;dataChannels=new Map;receivingFiles=new Map;receivedFiles=new Map;lastPingTimes=new Map;lastPongTimes=new Map;heartbeatIntervals=new Map;timeoutHandles=new Set;connectionQueue=new Map;pendingOffers=new Set;negotiationMap=new Map;pingFailures=new Map;pongFailures=new Map;recentlyResetPeers=new Map;lastConnectAttempt=new Map;connectionTimeouts=new Map;isSendingFile=!1;fileMetaInfo={name:"default_received_file"};coolingTime=2e3;cleaningLock=!1;setFileTransferProgress=()=>{};setDownloadPageState=()=>{};setMsgFromSharing=()=>{};updateConnectedUsers=()=>{};setFileSendingTargetUser=()=>{};peerManager;transferConfig={chunkSize:32*1024,maxConcurrentReads:10,bufferThreshold:256*1024};aborted=!1;initTransferConfig(){const e=z();e==="apple"||e==="android"?this.transferConfig={chunkSize:4*32*1024,maxConcurrentReads:8,bufferThreshold:128*1024}:this.transferConfig={chunkSize:32*1024,maxConcurrentReads:8,bufferThreshold:256*1024}}async init(e,t,s,n=()=>{},a){this.setFileSendingTargetUser=e,this.setMsgFromSharing=t,this.setDownloadPageState=s,this.updateConnectedUsers=n,this.setFileTransferProgress=a,this.initTransferConfig(),this.setupVisibilityWatcher(),this.serverFileTransfer&&(this.serverFileTransfer.setProgressCallback(i=>{this.setFileTransferProgress(i)}),this.serverFileTransfer.setFileReceivedCallback((i,c)=>{console.log(`[ColabLib] File received from ${c}:`,i.name),this.receivedFiles.set(c,i),this.handleReceivedFile(i,c)}),this.serverFileTransfer.setDownloadPageStateCallback(i=>{this.setDownloadPageState(i)}),this.serverFileTransfer.setFileMetaInfoCallback(i=>{this.fileMetaInfo.name=i})),this.setupPageUnloadHandler();try{const i=this.getUniqId();if(i){const c=await this.secureWrapper.initialize(i);this.userPublicKeys.set(i,c),console.log("ğŸ” ç«¯åˆ°ç«¯åŠ å¯†åŠŸèƒ½å·²å¯ç”¨")}}catch(i){console.warn("âš ï¸ åŠ å¯†åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥ï¼Œå°†ä½¿ç”¨æ˜æ–‡é€šä¿¡:",i)}setInterval(async()=>{for(const[i,c]of this.userList.entries())if(c.status==="connecting"){const h=!this.connectionTimeouts.get(i);if(c.attempts>=K.MAX_RETRY_ATTEMPTS||h){console.warn(`[USER CHECK] ${i} è¿æ¥å°è¯•${c.attempts>=3?"è¿‡å¤š":"å¡ä½"}ï¼Œåˆ‡æ¢åˆ° text-only æ¨¡å¼`),c.status="text-only",this.userList.set(i,c),this.updateUI();continue}const d=k.peers.get(i),b=this.dataChannels.get(i);if(d?.connectionState==="connected"&&b?.readyState==="open"){console.log(`[USER CHECK] âœ… ${i} è¿æ¥å·²å»ºç«‹ï¼Œæ›´æ–°çŠ¶æ€`),c.status="connected",c.hadP2PConnection=!0,this.userList.set(i,c),this.updateUI();continue}d&&["failed","closed"].includes(d.connectionState)&&(console.warn(`[USER CHECK] ${i} è¿æ¥çŠ¶æ€å¼‚å¸¸ (${d.connectionState})ï¼Œé‡ç½®ä¸ºtext-only`),this.clearCache(i),c.status="text-only",c.attempts++,this.userList.set(i,c),this.updateUI())}},K.USER_CHECK_INTERVAL)}async connectToServer(){const e=m.get("roomId");if(!ee(e).isValid)return m.updateUnrmb("settingsPageState",!0),!1;this.connectionManager.onSignalReceived(this.handleSignal.bind(this)),this.connectionManager.onMessageReceived?(this.connectionManager.onMessageReceived(s=>{if(console.log("[ColabLib] æ”¶åˆ°æ¶ˆæ¯:",s.type||s,s),s.type&&s.type.startsWith("file:transfer:")){console.log("[ColabLib] å¤„ç†æ–‡ä»¶ä¼ è¾“æ¶ˆæ¯:",s.type,"æ•°æ®:",s.data);const n=s.data?.transfer_id?s.data:s;this.serverFileTransfer?.handleFileTransferMessage(s.type,n)}}),console.log("[ColabLib] âœ“ æ–‡ä»¶ä¼ è¾“æ¶ˆæ¯å›è°ƒå·²è®¾ç½®")):console.warn("[ColabLib] âš ï¸ ConnectionManager ä¸æ”¯æŒ onMessageReceived å›è°ƒ"),this.connectionManager.onBinaryReceived?(this.connectionManager.onBinaryReceived(s=>{console.log(`[ColabLib] æ”¶åˆ°äºŒè¿›åˆ¶æ•°æ®: ${s.byteLength} å­—èŠ‚`),this.serverFileTransfer?.handleBinaryData(s)}),console.log("[ColabLib] âœ“ äºŒè¿›åˆ¶æ•°æ®å›è°ƒå·²è®¾ç½®")):console.warn("[ColabLib] âš ï¸ ConnectionManager ä¸æ”¯æŒ onBinaryReceived å›è°ƒ");const t=await this.connectionManager.connect(e);if(t){m.updateUnrmb("isConnectedToServer",!0);const s=this.userPublicKeys.get(this.getUniqId());this.broadcastSignal({type:"discover",userType:z(),publicKeys:s})}else x(U("alert.serverConnectionFailed"),2e3,{kind:"error"});return t}async disconnect(e,t){t&&this.connectionManager.isConnected()&&(console.log("[LEAVE] ğŸ“¢ Broadcasting leave message before disconnect"),this.broadcastSignal({type:"leave",userType:z()}),await new Promise(s=>setTimeout(s,K.LEAVE_MESSAGE_DELAY))),this.connectionManager.disconnect(e),m.updateUnrmb("isConnectedToServer",!1),console.log("[DISCONNECT] ğŸ”Œ Connection status updated to disconnected")}async handleRename(){const e=m.get("roomId"),t=ee(e);if(!t.isValid){x(t.message||U("alert.invalidRoom"),2e3,{kind:"error"});return}try{if(this.connectionManager.isConnected())await this.connectionManager.switchRoom(e);else{if(console.log(`ğŸ”„ æ²¡æœ‰æ´»è·ƒè¿æ¥ï¼Œå»ºç«‹æ–°è¿æ¥åˆ°æˆ¿é—´: ${e}`),this.connectionManager.onSignalReceived(this.handleSignal.bind(this)),this.connectionManager.onMessageReceived&&this.connectionManager.onMessageReceived(n=>{console.log("[ColabLib] æ”¶åˆ°æ¶ˆæ¯:",n.type||n),n.type&&n.type.startsWith("file:transfer:")&&(console.log("[ColabLib] å¤„ç†æ–‡ä»¶ä¼ è¾“æ¶ˆæ¯:",n.type),this.serverFileTransfer?.handleFileTransferMessage(n.type,n.data||n))}),this.connectionManager.onBinaryReceived&&this.connectionManager.onBinaryReceived(n=>{console.log(`[ColabLib] æ”¶åˆ°äºŒè¿›åˆ¶æ•°æ®: ${n.byteLength} å­—èŠ‚`),this.serverFileTransfer?.handleBinaryData(n)}),!await this.connectionManager.connect(e)){x(U("alert.serverConnectionFailed"),2e3,{kind:"error"});return}m.updateUnrmb("isConnectedToServer",!0)}await new Promise(s=>setTimeout(s,K.DISCOVER_REPLY_DELAY)),this.broadcastSignal({type:"discover",userType:z()}),console.log("âœ… æˆ¿é—´åˆ‡æ¢/è¿æ¥å®Œæˆï¼Œå·²å¹¿æ’­discoverä¿¡å·")}catch(s){x(U("alert.roomSwitchFailed",{error:s.message}),2e3,{kind:"error"})}}broadcastSignal(e){this.connectionManager.broadcastSignal(e)}getStatesMemorable(){const e=localStorage.getItem("memorableState");if(!e)return{memorable:{userId:null,uniqId:null}};try{const t=JSON.parse(e);return{memorable:{userId:t.memorable?.userId??null,uniqId:t.memorable?.uniqId??null}}}catch{return console.warn("ğŸ§¹ è§£æ localStorage å¤±è´¥ï¼Œæ¸…ç†çŠ¶æ€"),localStorage.removeItem("memorableState"),{memorable:{userId:null,uniqId:null}}}}changeStatesMemorable(e){const t=this.getStatesMemorable().memorable,s={userId:e.memorable.userId??t.userId,uniqId:e.memorable.uniqId??t.uniqId};localStorage.setItem("memorableState",JSON.stringify({memorable:s}))}getUniqId(){return k.uniqId}getUserId(){return k.userId}setUserId(e){if(k.userId!=e){k.userId=e,this.changeStatesMemorable({memorable:{userId:e}});const t=`${e}:${this.generateUUID()}`;k.uniqId=t,this.changeStatesMemorable({memorable:{uniqId:t}})}}setUniqId(e){k.uniqId=e,this.changeStatesMemorable({memorable:{uniqId:e}})}static getInstance(){if(!k.instance){if(k.isCreating)return k.instance;k.isCreating=!0;try{k.instance||(k.instance=new k)}finally{k.isCreating=!1}}return k.instance}async handleSignal(e){try{const t=JSON.parse(e.data),s=t;if(!s||s.from===this.getUniqId())return;switch(t.type){case"discover":await this.handleDiscover(t);break;case"offer":await this.handleOffer(t);break;case"answer":await this.handleAnswer(t);break;case"candidate":await this.handleCandidate(t);break;case"text":await this.handleTextMessage(t);break;case"encrypted_text":await this.handleTextMessage(t);break;case"leave":this.handleUserLeave(t);break;default:console.warn("Unknown message type",t.type)}}catch(t){console.error("ğŸš¨ Failed to parse WebSocket message:",e.data,t)}}async handleDiscover(e){const t=e.from,s=e.isReply;if(!t||t===this.getUniqId())return;const n=Date.now();let a=this.userList.get(t);if(a?(a.lastSeen=n,a.status==="disconnected"&&(a.status="text-only",a.attempts=0,console.log(`[DISCOVER] ğŸ”„ User ${t} back online, status: disconnected -> text-only`)),a.hadP2PConnection&&a.status==="text-only"&&console.log(`[DISCOVER] ğŸ” User ${t} had P2P before, may retry connection`),this.userList.set(t,a)):(a={status:"text-only",attempts:0,lastSeen:n,userType:e.userType},this.userList.set(t,a),console.log(`[DISCOVER] ğŸ‘‹ New user ${t} joined, status: text-only`)),e.publicKeys&&this.secureWrapper.isReady())try{await this.secureWrapper.registerUserKeys(t,e.publicKeys),console.log(`ğŸ”‘ å·²æ³¨å†Œç”¨æˆ· ${t} çš„å…¬é’¥`)}catch(l){console.warn(`âš ï¸ æ³¨å†Œç”¨æˆ· ${t} å…¬é’¥å¤±è´¥:`,l)}if(!s){const l=this.userPublicKeys.get(this.getUniqId());this.broadcastSignal({type:"discover",to:t,isReply:!0,userType:z(),publicKeys:l})}const i=this.userList.get(t);if(this.shouldAttemptP2PConnection(t,i)){console.log(`[DISCOVER] ğŸš€ Attempting P2P connection with ${t}`);try{i.status="connecting",i.attempts=i.attempts||0,this.userList.set(t,i),await this.connectToUser(t)}catch(l){console.warn("[DISCOVER] âŒ P2P connection attempt failed:",l),i.attempts++,i.attempts>=K.MAX_RETRY_ATTEMPTS?(i.status="text-only",console.log(`[DISCOVER] ğŸ“± User ${t} P2P failed too many times, staying in text-only mode`),x(U("alert.p2pFailed",{name:t.split(":")[0]}),2e3,{kind:"warning"})):i.status="text-only",this.userList.set(t,i)}}this.updateUI()}shouldAttemptP2PConnection(e,t){if(t.status==="connecting"||t.status==="connected"||t.attempts>=K.MAX_RETRY_ATTEMPTS)return!1;const s=k.peers.get(e),n=this.dataChannels.get(e);if(s?.connectionState==="connected"&&n?.readyState==="open")return console.log(`[DISCOVER] âœ… ${e} already has valid P2P connection`),t.status="connected",this.userList.set(e,t),!1;const a=ut(this.getUniqId(),e),i=t.status==="text-only";return a&&i}async handleTextMessage(e){const t=e.from,s=e.message;if(console.log(`[RECV MSG] Received signal text message from ${t}: ${s}`),!t||t===this.getUniqId()||!s){console.warn("[RECV MSG] âŒ Invalid message, skipping processing");return}const n=this.userList.get(t);n?(n.lastSeen=Date.now(),n.status==="disconnected"&&(n.status="text-only",this.userList.set(t,n),console.log(`[RECV MSG] User ${t} status changed to text-only`))):(this.userList.set(t,{status:"text-only",attempts:0,lastSeen:Date.now(),userType:e.userType||"desktop"}),console.log(`[RECV MSG] Created new text-only user: ${t}`));let a=s;try{const i=await this.secureWrapper.unwrapIncomingMessage(t,e);i.message&&(a=i.message,i.error?console.error("[RECV MSG] ğŸ”’ åŠ å¯†æ¶ˆæ¯è§£å¯†å¤±è´¥"):console.log("[RECV MSG] ğŸ”“ æˆåŠŸè§£å¯†åŠ å¯†æ¶ˆæ¯"))}catch(i){console.warn("[RECV MSG] âš ï¸ æ¶ˆæ¯è§£å¯†å¤„ç†å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ¶ˆæ¯:",i)}this.isActiveChatUser(t)?console.log(`[RECV MSG] ğŸ“± User ${t} is in active chat, skipping global message notification`):(console.log("[RECV MSG] âœ… Calling setMsgFromSharing to display message (user not in active chat)"),this.setMsgFromSharing(a)),this.emitter.emit("message-received",{from:t,message:a}),this.updateUI()}handleUserLeave(e){const t=e.from;!t||t===this.getUniqId()||(this.clearCache(t),this.userList.delete(t),this.updateUI(),console.log(`[LEAVE] âœ… All data for user ${t} has been cleaned up`))}clearCache(e){console.warn(`ğŸ§¹ Cleaning up connection-related state for ${e}`);const t=k.peers.get(e);t&&(t.close(),k.peers.delete(e));const s=this.dataChannels.get(e);s&&(s.close(),this.dataChannels.delete(e)),this.negotiationMap.delete(e),this.pendingOffers.delete(e),this.connectionQueue.delete(e);const n=this.heartbeatIntervals.get(e);n&&(clearInterval(n),this.heartbeatIntervals.delete(e));const a=this.connectionTimeouts.get(e);a&&(clearTimeout(a),this.connectionTimeouts.delete(e)),this.lastPingTimes.delete(e),this.lastPongTimes.delete(e),this.pingFailures.delete(e),this.pongFailures.delete(e),this.recentlyResetPeers.delete(e),this.secureWrapper.clearUserData(e),this.userPublicKeys.delete(e)}async handleOffer(e){const t=e.from;k.peers.has(t)||this.peerManager.createPeerConnection(t),this.negotiationMap.get(t).queue.push({type:"offer",sdp:e.offer}),this.processNegotiationQueue(t)}async processNegotiationQueue(e){if(!k.peers.get(e))return;const s=this.negotiationMap.get(e);if(s&&!s.isNegotiating){s.isNegotiating=!0;try{for(;s.queue.length>0;){const n=s.queue.shift();n.type==="offer"?await this.doHandleOffer(e,n.sdp):n.type==="answer"&&await this.doHandleAnswer(e,n.sdp)}}finally{s.isNegotiating=!1}}}async doHandleOffer(e,t){const s=k.peers.get(e);if(!s)return;const n=this.getUniqId()>e;if(s.signalingState==="have-local-offer"||s.signalingState==="have-local-pranswer")if(n){const l=Date.now(),h=this.recentlyResetPeers.get(e)??0;if(l-h<K.PEER_RESET_COOLDOWN){console.warn(`[OFFER] Recently reset ${e}, skipping`);return}console.warn(`[OFFER] Polite peer, resetting connection with ${e}`),this.recentlyResetPeers.set(e,l),s.close(),k.peers.delete(e);const d=this.peerManager.createPeerConnection(e);k.peers.set(e,d);const b=this.negotiationMap.get(e);b&&(b.queue.unshift({type:"offer",sdp:t}),this.processNegotiationQueue(e));return}else{console.warn("[OFFER] Impolite peer, ignoring incoming offer");return}await s.setRemoteDescription(new RTCSessionDescription(t));const i=await s.createAnswer();await s.setLocalDescription(i),this.broadcastSignal({type:"answer",answer:s.localDescription,to:e});const c=this.candidateCache.get(e);c&&c.length>0&&(await this.handleCandidate({from:e,candidates:c}),this.candidateCache.delete(e))}async handleAnswer(e){const t=e.from;if(!k.peers.has(t))return;const s=this.negotiationMap.get(t);s&&(s.queue.push({type:"answer",sdp:e.answer}),this.processNegotiationQueue(t))}async doHandleAnswer(e,t){const s=k.peers.get(e);if(!s)return;if(s.signalingState!=="have-local-offer"){console.warn(`Ignore answer from ${e}, because local signalingState=${s.signalingState}`);return}await s.setRemoteDescription(new RTCSessionDescription(t));const n=this.candidateCache.get(e);n&&n.length>0&&(await this.handleCandidate({from:e,candidates:n}),this.candidateCache.delete(e))}candidateCache=new Map;processedCandidates=new Map;async handleCandidate(e){const t=k.peers.get(e.from),s=e.from;if(!t){console.warn(`[ICE] âŒ No peer, skipping ${s}`);return}if(!t.remoteDescription){console.warn("[ICE] âš ï¸ remoteDescription not set, caching candidates");const a=this.candidateCache.get(s)||[];this.candidateCache.set(s,a.concat(e.candidates||[]));return}const n=this.processedCandidates.get(s)||new Set;this.processedCandidates.set(s,n);for(const a of e.candidates||[]){const i=JSON.stringify(a);if(n.has(i)){console.log("[ICE] ğŸ” Skipping duplicate candidate");continue}try{await t.addIceCandidate(new RTCIceCandidate(a)),n.add(i)}catch(c){console.error("Error adding ICE candidate:",c)}}}getAllUsers(){return Array.from(this.userList.keys())}setupDataChannel(e,t){e.binaryType="arraybuffer",this.dataChannels.set(t,e),e.onopen=()=>{m.update("isNewUser",!1);const s=this.connectionTimeouts.get(t);s&&(clearTimeout(s),this.connectionTimeouts.delete(t));let n=this.userList.get(t);n?(n.status="connected",n.hadP2PConnection=!0,n.lastSeen=Date.now(),this.userList.set(t,n),console.log(`[DATACHANNEL] âœ… ${t} DataChannel opened, status updated to connected`)):(console.warn("âš ï¸ User not found, adding automatically when channel opens:",t),n={status:"connected",attempts:0,lastSeen:Date.now(),userType:"desktop",hadP2PConnection:!0},this.userList.set(t,n)),x(U("alert.newUser",{name:t.split(":")[0]}),2e3,{kind:"success"}),this.updateUI(),this.heartbeatIntervals.has(t)&&(clearInterval(this.heartbeatIntervals.get(t)),this.heartbeatIntervals.delete(t));const a=setInterval(()=>{e.readyState==="open"&&e.send(JSON.stringify({type:"ping"}))},K.HEARTBEAT_INTERVAL);this.heartbeatIntervals.set(t,a)},this.receivingFiles||(this.receivingFiles=new Map),e.onmessage=async s=>{if(typeof s.data=="string"){const n=JSON.parse(s.data);switch(n.type){case"file-meta":this.receivingFiles.set(t,{name:n.name,size:n.size,totalChunks:Math.ceil(n.size/n.chunkSize),chunks:new Array(Math.ceil(n.size/n.chunkSize)),chunkSize:n.chunkSize,receivedSize:0,receivedChunkCount:0}),S.fileMetaInfo.name=n.name,this.setDownloadPageState(!0);break;case"abort":S.abortFileTransferToUser?.(),this.setFileTransferProgress(null),this.setDownloadPageState(!1),x(U("alert.transferCancelled"),2e3,{kind:"error"});break;case"ping":this.lastPingTimes.set(t,Date.now()),this.pongFailures.set(t,0),e.readyState==="open"&&e.send(JSON.stringify({type:"pong"}));break;case"pong":this.lastPongTimes.set(t,Date.now());const a=this.userList.get(t);a&&(a.status="connected",this.userList.set(t,a)),this.pingFailures.set(t,0),this.updateUI();break;case"text":default:try{const i=await this.secureWrapper.unwrapIncomingMessage(t,n);let c;i.message?(c=i.message,this.isActiveChatUser(t)?console.log(`[P2P MSG] ğŸ“± User ${t} is in active chat, skipping global message notification`):this.setMsgFromSharing(c),i.error?console.error("[P2P MSG] ğŸ”’ åŠ å¯†æ¶ˆæ¯è§£å¯†å¤±è´¥"):i.type==="text"&&n.type==="encrypted_text"&&console.log("[P2P MSG] ğŸ”“ æˆåŠŸè§£å¯†P2PåŠ å¯†æ¶ˆæ¯")):(c=n.msg,this.isActiveChatUser(t)?console.log(`[P2P MSG] ğŸ“± User ${t} is in active chat, skipping global message notification`):this.setMsgFromSharing(c)),this.emitter.emit("message-received",{from:t,message:c})}catch(i){console.warn("[P2P MSG] âš ï¸ æ¶ˆæ¯è§£å¯†å¤„ç†å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ¶ˆæ¯:",i);const c=n.msg;this.isActiveChatUser(t)?console.log(`[P2P MSG] ğŸ“± User ${t} is in active chat, skipping global message notification for fallback`):this.setMsgFromSharing(c),c&&this.emitter.emit("message-received",{from:t,message:c})}break}}else{const n=s.data,a=8;if(n.byteLength<a){console.error("Received binary data is too small");return}const i=new DataView(n),c=i.getUint32(0),l=i.getUint32(4),h=n.slice(a);if(h.byteLength!==l){console.error(`Chunk ${c} length mismatch: should be ${l}, actual is ${h.byteLength}`);return}const d=this.receivingFiles.get(t);if(!d){console.error("File metadata not received, cannot process chunk");return}if(d.chunks[c]||(d.chunks[c]=h,d.receivedSize+=h.byteLength,d.receivedChunkCount++),d.receivedChunkCount===d.totalChunks){const b=[];for(let v=0;v<d.totalChunks;v++){if(!d.chunks[v]){x(U("alert.chunkMissing",{index:v}),1e3,{kind:"error"}),console.error(`Missing chunk ${v}`),this.receivingFiles.delete(t);return}b.push(d.chunks[v])}const g=new Blob(b),p=new File([g],d.name,{type:"application/octet-stream"});this.receivedFiles.set(t+"::"+p.name,p);const C=Array.from(this.receivedFiles.entries()).filter(([v,A])=>A.name.startsWith("LetShare_")&&A.name.endsWith(".zip"));C&&x(U("alert.unzipping"),2e3,{kind:"info"});for(const[v,A]of C)try{const M=await Se.loadAsync(A),[R]=v.split("::");for(const[F,_]of Object.entries(M.files))if(!_.dir){const Q=await _.async("blob"),I=new File([Q],F),T=`${R}::${F}`;this.receivedFiles.set(T,I)}this.receivedFiles.delete(v)}catch(M){console.error("Unzipping failed:",M)}x(U("alert.fileReceived",{name:t.split(":")[0]})),this.receivingFiles.delete(t)}}},e.onclose=()=>{console.warn(`ğŸ§¹ DataChannel closed for ${t}, setting user to text-only status`),this.clearCache(t);const s=this.userList.get(t);s?(s.status="text-only",s.lastSeen=Date.now(),this.userList.set(t,s),console.log(`ğŸ“± User ${t} switched to text-only mode, can continue text communication`),x(U("alert.p2pDisconnected",{name:t.split(":")[0]}),2e3,{kind:"warning"})):console.warn(`âš ï¸ User ${t} does not exist in user list, cleaning up directly`),this.updateUI()},e.onerror=()=>{this.cleanupDataChannel(t)}}cleanupDataChannel(e){const t=this.dataChannels.get(e);if(t){t.close(),this.heartbeatIntervals.has(e)&&(clearInterval(this.heartbeatIntervals.get(e)),this.heartbeatIntervals.delete(e)),this.dataChannels.delete(e);const s=this.userList.get(e);s&&(s.status="text-only",s.lastSeen=Date.now(),this.userList.set(e,s)),this.lastPongTimes.delete(e),this.updateUI()}}async connectToUser(e){const t=Date.now(),s=this.lastConnectAttempt.get(e)??0;if(t-s<K.CONNECT_ATTEMPT_COOLDOWN){console.warn(`[CONNECT] Connection attempt to ${e} too frequent, skipping`);return}if(this.lastConnectAttempt.set(e,t),this.connectionQueue.has(e)){console.warn(`[CONNECT] ${e} already in connection queue, skipping`);return}this.connectionQueue.set(e,!0);const n=this.userList.get(e);n&&n.status!=="connected"&&(n.status="connecting",this.userList.set(e,n),this.updateUI(),console.log(`[CONNECT] ğŸ”„ User ${e} status updated to connecting`));try{let a=k.peers.get(e);if(a){const h=a.connectionState,d=this.dataChannels.get(e),b=["connected","connecting"].includes(h),g=d?.readyState==="open";if(b&&g){console.log(`[CONNECT] ${e} connection normal (ICE: ${h}, Channel: open)`);return}console.warn(`[CONNECT] Cleaning up old connection for ${e}`,`ICE State: ${h}, Channel State: ${d?.readyState||"missing"}`),this.clearCache(e)}a=this.peerManager.createPeerConnection(e);const i=a.createDataChannel("chat");this.setupDataChannel(i,e);const c=await a.createOffer({iceRestart:!0});await a.setLocalDescription(c),console.log(`[CONNECT] âœ… Sending offer to ${e}`),this.broadcastSignal({type:"offer",offer:a.localDescription,to:e});const l=window.setTimeout(()=>{const h=k.peers.get(e),d=this.userList.get(e);d?.status!=="connected"&&h&&h.iceConnectionState!=="connected"&&h.iceConnectionState!=="checking"?(console.warn(`[CONNECT] â° ${e} P2P connection timed out, setting to text-only status`),this.clearCache(e),d&&(d.status="text-only",d.lastSeen=Date.now(),this.userList.set(e,d),console.log(`ğŸ“± User ${e} switched to text-only due to timeout`),x(U("alert.p2pTimeout",{name:e.split(":")[0]}),2e3,{kind:"warning"})),this.updateUI()):console.log(`[CONNECT] ${e} already in connection, extending wait status`),this.connectionTimeouts.delete(e)},K.CONNECTION_TIMEOUT);this.connectionTimeouts.set(e,l)}catch(a){console.error(`[CONNECT] âŒ Connection to ${e} failed:`,a)}finally{this.connectionQueue.delete(e),this.pendingOffers.delete(e)}}updateUI(){this.updateConnectedUsers(this.userList)}async sendMessageToUser(e,t){const s=this.dataChannels.get(e),n=this.userList.get(e);let a={msg:t,type:"text"};if(s?.readyState==="open")try{const i=await this.secureWrapper.wrapOutgoingMessage(e,a);i.type==="encrypted_text"&&console.log(`[SEND MSG] ğŸ” å‘é€åŠ å¯†P2Pæ¶ˆæ¯ç»™ ${e}`),s.send(JSON.stringify(i)),this.emitter.emit("message-sent",{to:e,message:t});return}catch(i){console.warn("[SEND MSG] âš ï¸ P2Pæ¶ˆæ¯åŠ å¯†å¤±è´¥ï¼Œä½¿ç”¨æ˜æ–‡:",i),s.send(JSON.stringify(a)),this.emitter.emit("message-sent",{to:e,message:t});return}if(n?.status==="text-only"||n?.status==="waiting"||n?.status==="connecting")try{const i=await this.secureWrapper.wrapOutgoingMessage(e,{type:"text",message:t});i.type==="encrypted_text"?(console.log(`[SEND MSG] ğŸ” å‘é€åŠ å¯†ä¿¡ä»¤æ¶ˆæ¯ç»™ ${e}`),this.broadcastSignal({type:"encrypted_text",encryptedMessage:i.encryptedMessage,to:e,userType:z()})):this.broadcastSignal({type:"text",message:t,to:e,userType:z()}),console.log(`[SEND MSG] âœ… Signal message sent successfully to ${e}`),this.emitter.emit("message-sent",{to:e,message:t});return}catch(i){console.warn("[SEND MSG] âš ï¸ ä¿¡ä»¤æ¶ˆæ¯åŠ å¯†å¤±è´¥ï¼Œä½¿ç”¨æ˜æ–‡:",i),this.broadcastSignal({type:"text",message:t,to:e,userType:z()}),console.log(`[SEND MSG] âœ… Fallback signal message sent successfully to ${e}`),this.emitter.emit("message-sent",{to:e,message:t});return}console.warn(`[SEND MSG] âŒ Channel not open with user ${e} and user is not in text sendable mode. User status: ${n?.status}`)}abortFileTransferToUser(){if(this.aborted=!0,this.isSendingFile=!1,this.timeoutHandles){for(const e of this.timeoutHandles)clearTimeout(e);this.timeoutHandles.clear()}this.serverFileTransfer?.cancelCurrentTransfer()}async handleReceivedFile(e,t){const s=`${t}::${e.name}`;if(this.receivedFiles.set(s,e),e.name.startsWith("LetShare_")&&e.name.endsWith(".zip"))try{x(U("alert.unzipping"),2e3,{kind:"info"});const n=await Se.loadAsync(e);for(const[a,i]of Object.entries(n.files))if(!i.dir){const c=await i.async("blob"),l=new File([c],a),h=`${t}::${a}`;this.receivedFiles.set(h,l)}this.receivedFiles.delete(s)}catch(n){console.error("Unzipping failed:",n)}x(U("alert.fileReceived",{name:t.split(":")[0]}),2e3,{kind:"success"}),this.setFileTransferProgress(null),this.setDownloadPageState(!1)}isConnectedToUser(e){const t=this.dataChannels.get(e);return!!t&&t.readyState==="open"}canSendFileToUser(e){return this.isConnectedToUser(e)}isTextOnlyUser(e){return this.userList.get(e)?.status==="text-only"}canSendMessageToUser(e){const t=this.isConnectedToUser(e),s=this.isTextOnlyUser(e),n=this.userList.get(e);return t||s||n?.status==="waiting"||n?.status==="connecting"}async sendFileViaServer(e,t){if(!this.serverFileTransfer){console.error("âŒ æœåŠ¡å™¨æ–‡ä»¶ä¼ è¾“æœªåˆå§‹åŒ–"),x(U("toast.serverTransferNotAvailable"),2e3,{kind:"error"});return}const s=m.get("roomId");if(!s){console.error("âŒ æœªåŠ å…¥æˆ¿é—´"),x(U("toast.notInRoom"),2e3,{kind:"error"});return}this.setFileSendingTargetUser(e),this.isSendingFile=!0,this.setDownloadPageState(!0);try{await this.serverFileTransfer.sendFileViaServer(e,t,s),console.log("âœ… æ–‡ä»¶é€šè¿‡æœåŠ¡å™¨å‘é€å®Œæˆ")}catch(n){console.error("âŒ æœåŠ¡å™¨æ–‡ä»¶ä¼ è¾“å¤±è´¥:",n),x(U("toast.fileTransferFailed"),3e3,{kind:"error"})}finally{this.isSendingFile=!1}}async sendFileToUser(e,t){const s=this.dataChannels.get(e);if(this.setFileSendingTargetUser(e),!s||s.readyState!=="open"){console.error(`Data channel with user ${e} is not available.`),console.log("ğŸ”„ P2Pä¸å¯ç”¨ï¼Œå°è¯•é€šè¿‡æœåŠ¡å™¨è½¬å‘æ–‡ä»¶"),await this.sendFileViaServer(e,t);return}const n=Math.ceil(t.size/this.transferConfig.chunkSize);let a=this.transferConfig.maxConcurrentReads,i=0,c=0;this.aborted=!1;const l=[],h={type:"file-meta",name:t.name,size:t.size,totalChunks:n,chunkSize:this.transferConfig.chunkSize};try{s.send(JSON.stringify(h)),console.log("ğŸ“¦ File metadata sent:",h)}catch(p){console.error("âŒ Failed to send file metadata:",p);return}const d=p=>new Promise((C,v)=>{if(this.aborted)return v(new Error("Reading aborted"));const A=p*this.transferConfig.chunkSize,M=t.slice(A,A+this.transferConfig.chunkSize),R=new FileReader;R.onload=()=>{if(this.aborted)return v(new Error("Reading aborted"));R.result instanceof ArrayBuffer?C(R.result):v(new Error("Reading result is not ArrayBuffer"))},R.onerror=F=>v(F),R.readAsArrayBuffer(M)}),b=async p=>{if(!this.aborted)try{const C=await d(p);if(this.aborted)return;const v=8,A=new ArrayBuffer(v+C.byteLength),M=new DataView(A);M.setUint32(0,p),M.setUint32(4,C.byteLength),new Uint8Array(A,v).set(new Uint8Array(C));const R=()=>{if(!this.aborted)if(s.bufferedAmount<this.transferConfig.bufferThreshold){s.send(A),i++;const F=Math.min(i/n*100,100);this.setFileTransferProgress(F),F>=100&&(setTimeout(()=>this.setFileTransferProgress(null),K.TRANSFER_COMPLETE_DELAY),this.setDownloadPageState(!1)),this.isSendingFile=F<100&&F>0}else{const F=setTimeout(R,K.RETRY_SEND_DELAY);this.timeoutHandles.add(F)}};R()}catch(C){this.aborted||console.error(`Chunk ${p} sending failed:`,C)}};await(async()=>{for(;c<n&&!this.aborted;){l.length>=a&&await Promise.race(l);const p=c++,C=b(p);l.push(C),C.finally(()=>{const v=l.indexOf(C);v>-1&&l.splice(v,1)})}})(),await Promise.allSettled(l),this.aborted?console.warn("ğŸš« File sending aborted"):console.log("âœ… File sending complete")}generateUUID(){return Math.random().toString(36).substring(2,8)}isConnected(){return this.connectionManager.isConnected()}getConnectedUserIds(){return Array.from(this.userList.entries()).filter(([e,t])=>t.status==="connected").map(([e])=>e)}setActiveChatUserId(e){console.log(`[ACTIVE CHAT] Setting active chat user: ${e}`),this.activeChatUserId=e}getActiveChatUserId(){return this.activeChatUserId}isActiveChatUser(e){return this.activeChatUserId===e}setupVisibilityWatcher(){let e=null,t=null;const s=K.BACKGROUND_TIMEOUT;document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?(e=Date.now(),t=setTimeout(()=>{const n=Date.now();e&&n-e>=s&&(x(U("background.timeout",{seconds:s/1e3}),3e3),this.disconnect())},s)):document.visibilityState==="visible"&&(t&&(clearTimeout(t),t=null),this.isConnected())})}setupPageUnloadHandler(){const e=()=>{this.connectionManager.isConnected()&&(console.log("[LEAVE] ğŸ“¢ Broadcasting leave message on page unload"),this.broadcastSignal({type:"leave",userType:z()}))};window.addEventListener("beforeunload",e),window.addEventListener("pagehide",e)}canEncryptWithUser(e){return this.secureWrapper.canEncryptForUser(e)}getEncryptionStatus(){return this.secureWrapper.getEncryptionStatus()}isEncryptionEnabled(){return this.secureWrapper.isReady()}getUserCommunicationMode(e){const t=this.userList.get(e);return!t||t.status==="disconnected"?"unavailable":this.canEncryptWithUser(e)?"encrypted":"plaintext"}}const S=k.getInstance(),ae=ks.isNativePlatform();async function zs(){try{if(ae){const{value:o}=await lt.read();return o||""}else{if(navigator.clipboard&&typeof navigator.clipboard.readText=="function")return await navigator.clipboard.readText()||"";x("å½“å‰ç¯å¢ƒä¸æ”¯æŒè¯»å–å‰ªè´´æ¿",3e3,{kind:"warning"})}}catch(o){console.error("è¯»å–å‰ªè´´æ¿å¤±è´¥: ",o),x("è¯»å–å‰ªè´´æ¿å†…å®¹å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™æˆ–æ‰‹åŠ¨ç²˜è´´ã€‚",3e3,{kind:"error"})}return""}async function Bs(o){try{if(ae)return await lt.write({string:o}),!0;if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function")if(await navigator.clipboard.writeText(o),typeof navigator.clipboard.readText=="function")try{const e=await navigator.clipboard.readText();if(e===o)return!0;console.warn("å‰ªè´´æ¿å†…å®¹éªŒè¯å¤±è´¥:",o,e)}catch(e){return console.warn("å‰ªè´´æ¿å†…å®¹éªŒè¯å¤±è´¥:",e),!0}else return!0;else x("å½“å‰ç¯å¢ƒä¸æ”¯æŒå¤åˆ¶åˆ°å‰ªè´´æ¿",3e3,{kind:"warning"})}catch(e){console.error("å¤åˆ¶å¤±è´¥:",e),x("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶æ–‡æœ¬ã€‚",3e3,{kind:"warning"})}return!1}const Ae={"&::-webkit-scrollbar":{width:"0px !important",height:"0px !important",background:"transparent"},"&::-webkit-scrollbar-thumb":{background:"transparent"},"&::-webkit-scrollbar-track":{background:"transparent"},"&::-webkit-scrollbar-corner":{background:"transparent"},scrollbarWidth:"none !important",msOverflowStyle:"none !important"},Ks=[{key:"light",color:"#f5f5f5",label:"äº®è‰²"},{key:"dark",color:"#212121",label:"æš—è‰²"},{key:"blue",color:"#1976d2",label:"è“è‰²"},{key:"green",color:"#388e3c",label:"ç»¿è‰²"},{key:"sunset",color:"#f57c00",label:"æ—¥è½æ©™"},{key:"coolGray",color:"#90a4ae",label:"å†·ç°"}],Hs=()=>{const o=m.get("userTheme")||"light",e=t=>{m.update("userTheme",t)};return r.jsx(f,{sx:{borderRadius:"50%",display:"flex",gap:1.3,justifyContent:"center",alignItems:"center",flexWrap:"wrap"},children:Ks.map(t=>{const s=o===t.key;return r.jsx(nt,{title:t.label,arrow:!0,children:r.jsx("div",{tabIndex:0,onClick:()=>e(t.key),style:{width:24,height:24,borderRadius:"50%",backgroundColor:t.color,cursor:"pointer",marginLeft:s?8:0,marginRight:s?8:0,transform:s?"scale(1.4)":"scale(1)",boxShadow:s?"0 0 0 3px rgba(0,0,0,0.3)":"0 0 0 1px rgba(0,0,0,0.2)",transition:"transform 0.2s ease, margin 0.2s ease, box-shadow 0.2s ease",outline:"none",WebkitTapHighlightColor:"transparent"},onMouseEnter:n=>{n.currentTarget.style.transform=s?"scale(1.4)":"scale(1.2)"},onMouseLeave:n=>{n.currentTarget.style.transform=s?"scale(1.4)":"scale(1)"}})},t.key)})})},Vs=()=>{const{t:o}=ue(),e=m.getAllSettings(),t=Y.useRef(null),[s,n]=Y.useState(!1),a=Y.useRef(m.get("roomId")),i=(g,p)=>{m.update(g,p)},c=()=>{b()},l=async g=>{const p=g.target.value,C=m.get("serverMode");if(C!==p)try{if(S.isConnected()&&(console.log(`ğŸ”„ æœåŠ¡å™¨æ¨¡å¼ä» ${C} åˆ‡æ¢åˆ° ${p}ï¼Œæ–­å¼€å½“å‰è¿æ¥...`),await S.disconnect(),m.updateUnrmb("isConnectedToServer",!1)),m.update("serverMode",p),await new Promise(A=>setTimeout(A,500)),console.log(`ğŸ”„ é‡æ–°è¿æ¥åˆ° ${p} æœåŠ¡å™¨...`),await S.connectToServer()){const A=o(p==="auto"?"settings.advanced.serverMode.auto":p==="ably"?"settings.advanced.serverMode.global":"settings.advanced.serverMode.china");x(`${o("settings.advanced.serverMode.switchSuccess",{mode:A})}`,2e3,{kind:"success"}),S.broadcastSignal({type:"discover",userType:z()})}else{const A=o(p==="auto"?"settings.advanced.serverMode.auto":p==="ably"?"settings.advanced.serverMode.global":"settings.advanced.serverMode.china");x(`${o("settings.advanced.serverMode.switchError",{mode:A})}`,2e3,{kind:"error"})}}catch(v){console.error("æœåŠ¡å™¨æ¨¡å¼åˆ‡æ¢å¤±è´¥:",v),x("æœåŠ¡å™¨æ¨¡å¼åˆ‡æ¢å¤±è´¥: "+v.message,2e3,{kind:"error"})}},h=()=>{window.confirm(o("settings.advanced.resetConfirm"))&&(m.reset(),window.location.reload())},d=g=>{const p=g.target.value;m.update("userLanguage",p);const v=(A=>{if(A==="system"){const M=navigator.language.toLowerCase();return M.startsWith("zh")?"zh":M.startsWith("ms")?"ms":M.startsWith("id")?"id":"en"}return A})(p);de.changeLanguage(v).then(()=>{document.title=de.t("meta.title")}),console.log("Language changed to:",p)},b=async()=>{const g=m.get("roomId");a.current!==g&&(console.log(`ğŸ”„ æˆ¿é—´å·å˜åŒ–: "${a.current}" â†’ "${g}"`),await S.handleRename(),x(`${o("settings.joinSuccess")}: "${g}"`),a.current=g);const p=m.get("roomId");let C=ee(p);C.isValid?m.updateUnrmb("settingsPageState",!1):x(C.message,2e3,{kind:"error"})};return Y.useEffect(()=>{const g=p=>{p.key==="Enter"&&m.getUnrmb("settingsPageState")&&(p.preventDefault(),c())};return window.addEventListener("keydown",g),()=>{window.removeEventListener("keydown",g)}},[]),r.jsx(xe,{onClose:b,open:m.getUnrmb("settingsPageState")??!1,PaperProps:{sx:{borderRadius:3,bgcolor:"background.paper",overflowY:"scroll",...Ae}},children:r.jsxs(f,{ref:t,sx:{maxWidth:310,mx:"auto",bgcolor:"background.paper",borderRadius:3,boxShadow:3,display:"flex",flexDirection:"column",position:"relative",maxHeight:"80vh",...Ae},children:[r.jsxs(f,{sx:{flex:1,overflowY:"auto",px:4.3,pt:4,pb:0,mb:0,display:"flex",flexDirection:"column",gap:3,...Ae},children:[r.jsxs(f,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[r.jsx(j,{variant:"h6",children:o("settings.title")}),r.jsx(nt,{title:o("settings.advanced.title"),children:r.jsx(X,{onClick:()=>n(!s),sx:{transition:"transform 0.3s ease",transform:s?"rotate(180deg)":"rotate(0deg)"},children:r.jsx(rt,{})})})]}),r.jsx(Hs,{}),r.jsxs(He,{fullWidth:!0,children:[r.jsx(At,{children:"è¯­è¨€/Language"}),r.jsxs(jt,{value:m.get("userLanguage"),onChange:d,label:"è¯­è¨€/Language",sx:{minWidth:140,mt:0},children:[r.jsx(re,{value:"system",children:"System"}),r.jsx(re,{value:"zh",children:"ç®€ä½“ä¸­æ–‡"}),r.jsx(re,{value:"en",children:"English"}),r.jsx(re,{value:"ms",children:"Bahasa Melayu"}),r.jsx(re,{value:"id",children:"Bahasa Indonesia"})]})]}),r.jsx(G,{required:!0,label:o("settings.roomId.label"),fullWidth:!0,autoFocus:m.get("roomId")=="",variant:"outlined",value:e.roomId||"",onChange:g=>i("roomId",g.target.value),error:!e.roomId,inputProps:{maxLength:12},helperText:e.roomId?o("settings.roomId.helper"):o("settings.roomId.required")}),r.jsx(Mt,{in:s,timeout:300,children:r.jsxs(f,{sx:{display:"flex",flexDirection:"column",gap:2},children:[r.jsxs(He,{children:[r.jsx(Ft,{id:"server-mode-label",children:o("settings.advanced.serverMode.label")}),r.jsxs(Dt,{row:!0,"aria-labelledby":"server-mode-label",name:"server-mode",value:m.get("serverMode"),onChange:l,children:[r.jsx(Te,{value:"auto",control:r.jsx(Pe,{}),label:o("settings.advanced.serverMode.auto")}),r.jsx(Te,{value:"ably",control:r.jsx(Pe,{}),label:o("settings.advanced.serverMode.global")}),r.jsx(Te,{value:"custom",control:r.jsx(Pe,{}),label:o("settings.advanced.serverMode.china")})]})]}),r.jsx(G,{label:o("settings.advanced.customServerUrl.label"),fullWidth:!0,variant:"outlined",value:m.get("customServerUrl")||"",onChange:g=>m.update("customServerUrl",g.target.value),disabled:m.get("serverMode")!=="custom",helperText:m.get("serverMode")!=="custom"?o("settings.advanced.customServerUrl.disabled"):""}),r.jsx(G,{label:o("settings.advanced.authToken.label"),fullWidth:!0,variant:"outlined",value:m.get("authToken")||"",onChange:g=>m.update("authToken",g.target.value),type:"password",disabled:m.get("serverMode")!=="custom",helperText:m.get("serverMode")!=="custom"?o("settings.advanced.authToken.disabled"):""}),r.jsx(G,{label:o("settings.advanced.ablyKey.label"),fullWidth:!0,variant:"outlined",value:m.get("ablyKey")||"",onChange:g=>m.update("ablyKey",g.target.value),type:"password",disabled:m.get("serverMode")!=="ably",helperText:m.get("serverMode")!=="ably"?o("settings.advanced.ablyKey.disabled"):""}),r.jsx(L,{onClick:h,variant:"outlined",color:"error",startIcon:r.jsx(Rt,{}),sx:{mt:1},children:o("settings.advanced.resetAll")})]})})]}),r.jsx(f,{sx:{px:4.3,pb:3,pt:s?2:0,backgroundColor:"background.paper"},children:r.jsx(L,{onClick:c,variant:"contained",size:"large",fullWidth:!0,children:o("settings.saveButton")})})]})})},Ws=Le(Vs);class $s{constructor(e){this.rtc=e}offerQRCodeString=null;localOffer=null;targetUserId=null;async generateOfferQr(e){this.targetUserId=e;let t=k.peers.get(e);if(!t){t=this.rtc.peerManager.createPeerConnection(e);const a=t.createDataChannel("chat");this.rtc.setupDataChannel(a,e)}const s=await t.createOffer();await t.setLocalDescription(s),this.localOffer=s;const n={from:this.rtc.getUniqId(),to:e,offer:s};this.offerQRCodeString=btoa(JSON.stringify(n))}async handleScannedOffer(e){const t=JSON.parse(atob(e)),{from:s,to:n,offer:a}=t;this.targetUserId=s;let i=k.peers.get(s);i||(i=this.rtc.peerManager.createPeerConnection(s),this.rtc.setupDataChannel(i.createDataChannel("chat"),s)),await i.setRemoteDescription(new RTCSessionDescription(a));const c=await i.createAnswer();return await i.setLocalDescription(c),btoa(JSON.stringify({from:n,to:s,answer:c}))}async handleScannedAnswer(e){const t=JSON.parse(atob(e)),{from:s,answer:n}=t;await this.rtc.doHandleAnswer(s,n)}}const Js=()=>{const{t:o}=ue(),[e,t]=y.useState(!1),s=()=>t(!0),n=()=>t(!1),a=fe(),i="https://bigonion.cn/shortlink",c="https://github.com/LiWeny16/LetShare",[l,h]=y.useState("share"),[d]=y.useState(()=>new $s(S));return y.useEffect(()=>{l==="connect"&&d.generateOfferQr("ä½ è¦è¿æ¥çš„ç”¨æˆ·id")},[l]),r.jsxs(r.Fragment,{children:[r.jsxs(f,{component:"footer",sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:1,borderTop:"1px solid #e0e0e0",borderBottom:"1px solid #e0e0e0",mb:"20px",mt:"auto"},children:[r.jsx(j,{variant:"body2",color:"text.secondary",children:"Â© 2025 LetShare Copyright Author Onion"}),r.jsxs(f,{sx:{display:"flex",alignItems:"center"},children:[r.jsx(X,{"aria-label":"GitHub",component:"a",href:c,target:"_blank",rel:"noopener noreferrer",children:r.jsx(Ut,{})}),r.jsx(X,{"aria-label":"QR Code",onClick:s,children:r.jsx(Nt,{})}),r.jsx(X,{onClick:()=>{m.updateUnrmb("settingsPageState",!0)},children:r.jsx(rt,{})})]})]}),r.jsx(xe,{open:e,onClose:n,PaperProps:{sx:{borderRadius:2,bgcolor:"background.paper",overflow:"hidden"}},children:r.jsxs(f,{sx:{minHeight:400,padding:1,bgcolor:"background.paper",borderRadius:2},children:[r.jsx(at,{children:o("footer.shareTitle")}),r.jsx(it,{}),r.jsx(je,{sx:{display:"flex",justifyContent:"center",alignItems:"center",p:1.4,width:"300px",maxWidth:"100%"},children:l==="share"?r.jsxs(f,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[r.jsxs(j,{variant:"body1",color:"text.secondary",sx:{mb:1},children:[o("footer.qrPrompt"),r.jsx("br",{}),r.jsx("strong",{children:m.get("roomId")})]}),r.jsx(De,{value:i,eyeRadius:1,size:150,bgColor:a.palette.background.paper,fgColor:a.palette.text.primary,ecLevel:"H",quietZone:10}),r.jsx(j,{variant:"body2",color:"primary",component:"a",href:i,target:"_blank",rel:"noopener noreferrer",sx:{mt:1,wordBreak:"break-word",textDecoration:"none"},children:"https://letshare.fun"})]}):r.jsxs(f,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[r.jsx(j,{variant:"body2",color:"text.secondary",sx:{mb:1},children:o("footer.qrScanPrompt")}),d.offerQRCodeString?r.jsx(De,{value:d.offerQRCodeString,size:150,eyeRadius:1,bgColor:a.palette.background.paper,fgColor:a.palette.text.primary,ecLevel:"H",quietZone:10}):r.jsx(j,{variant:"caption",color:"text.disabled",children:"æ­£åœ¨ç”ŸæˆäºŒç»´ç ..."})]})})]})}),r.jsx(Ws,{})]})},Gs=({onEditDone:o})=>{const{t:e}=ue(),[t,s]=y.useState(!1),[n,a]=y.useState(""),[i,c]=y.useState(!1),l=y.useRef("");y.useEffect(()=>{const g=S.getUserId();g&&(a(g),l.current=g)},[]);const h=/^[\u4e00-\u9fa5a-zA-Z0-9\u{1F000}-\u{1FFFF}]*$/u,d=g=>{const p=g.target.value;a(p),c(!h.test(p))},b=async()=>{const g=n.trim();if(!h.test(g)||!g){a(l.current),c(!0),s(!1);return}else S.isConnected()&&(console.log(`[USER RENAME] ğŸ“¢ Broadcasting leave message before changing name from ${l.current} to ${g}`),S.broadcastSignal({type:"leave",userType:z()}),await new Promise(p=>setTimeout(p,300))),S.setUserId(g),l.current=g,c(!1),s(!1),o&&o(g),window.location.reload()};return r.jsx(r.Fragment,{children:t?r.jsx(G,{value:n,onChange:d,onBlur:b,onKeyDown:g=>{g.key==="Enter"&&b()},autoFocus:!0,variant:"standard",error:i,helperText:i?e("userId.inputError"):"",inputProps:{style:{textAlign:"center"},maxLength:12},sx:{mt:2,display:"block",mx:"auto"}}):r.jsxs(j,{variant:"body2",color:"textSecondary",align:"center",sx:{mt:2,cursor:"pointer"},onClick:()=>s(!0),children:[e("userId.display"),": ",n]})})},qs=({open:o})=>{const[e,t]=y.useState(!1);return r.jsx(Me,{in:o,timeout:600,unmountOnExit:!0,children:r.jsx(f,{sx:{width:"100vw",minHeight:"100vh",position:"fixed",top:0,left:0,display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",backgroundColor:s=>s.palette.background.default,color:"white",textAlign:"center",p:2,boxSizing:"border-box",zIndex:9999},children:r.jsxs(f,{sx:{mb:"200px",display:"flex",flexDirection:"column",alignItems:"center"},children:[r.jsx(f,{sx:{width:{xs:120,sm:160,md:200},height:{xs:120,sm:160,md:200},mb:3,display:"flex",justifyContent:"center",alignItems:"center"},children:r.jsx(Me,{in:e,timeout:600,children:r.jsx(f,{component:"img",src:"/icons/512x512_trans.png",alt:"Logo",onLoad:()=>t(!0),sx:{width:"100%",height:"100%",objectFit:"contain"}})})}),r.jsx(j,{variant:"h6",sx:{fontWeight:300,color:s=>s.palette.getContrastText(s.palette.background.default)},children:"Connect To The World"}),r.jsx(j,{variant:"subtitle1",sx:{opacity:.85,color:s=>s.palette.getContrastText(s.palette.background.default)},children:"è½»è§¦ï¼Œå¼€å¯é€šå¾€ä¸–ç•Œçš„å¤§é—¨"}),r.jsx(f,{mt:4,children:r.jsx(Fe,{sx:{opacity:.85,color:s=>s.palette.getContrastText(s.palette.background.default)},color:"inherit"})})]})})})},Ys=Ts("BinarySaver");async function tt(o){const e=await o.arrayBuffer(),t=new Uint8Array(e);await Ys.saveBytes({fileName:o.name,mimeType:o.type,data:Array.from(t)})}function Qs({open:o,progress:e,setProgress:t,onClose:s,targetUserId:n}){const{t:a}=ue(),i=fe(),[c,l]=Y.useState(o),[h,d]=Y.useReducer(I=>I+1,0);Y.useEffect(()=>{o&&l(!0)},[o]),Y.useEffect(()=>{const I=setInterval(()=>{d()},350);return()=>clearInterval(I)},[]);const b=()=>{l(!1),s()},g=S.receivingFiles,p=S.receivedFiles,C=Array.from(g.entries()),v=Array.from(p.entries()),A=async()=>{if(v.length===0)return;const I=new Se;v.forEach(([T,D])=>{I.file(D.name,D)});try{const T=await I.generateAsync({type:"blob"}),D=`Received_${Date.now()}.zip`,V=new File([T],D,{type:"application/zip"});if(ae)await tt(V),x(`${D} å·²æˆåŠŸä¿å­˜åˆ°è·¯å¾„: /Download/letshare/`,3e3,{kind:"success"});else{const w=URL.createObjectURL(V),P=document.createElement("a");P.href=w,P.download=D,document.body.appendChild(P),P.click(),document.body.removeChild(P),URL.revokeObjectURL(w)}}catch(T){console.error("æ‰“åŒ…ä¸‹è½½å¤±è´¥:",T),x("æ‰“åŒ…ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•ï¼",2e3,{kind:"error"})}},M=I=>{const T=S.dataChannels.get(I);T&&T.send(JSON.stringify({type:"abort"})),s(),x(`ç»ˆæ­¢æ¥è‡ª ${I.split(":")[0]} çš„æ¥æ”¶`,2e3,{kind:"error"}),g.delete(I),d(),g.size===0&&e===null&&l(!1)},R=()=>{s(),x("ç»ˆæ­¢å‘é€",2e3,{kind:"error"}),S.abortFileTransferToUser?.(),t(0),g.size===0&&l(!1)},F=I=>{const T=I.split(".").pop()?.toLowerCase();return T?["png","jpg","jpeg","gif","bmp","webp","svg"].includes(T)?r.jsx(Lt,{fontSize:"medium"}):["mp4","mov","avi","mkv","webm"].includes(T)?r.jsx(Ot,{fontSize:"medium"}):["zip","rar","7z","tar","gz","xz","bz2"].includes(T)?r.jsx(zt,{fontSize:"medium"}):T==="pdf"?r.jsx(Bt,{fontSize:"medium"}):["doc","docx"].includes(T)?r.jsx(Kt,{fontSize:"medium"}):["xls","xlsx","csv"].includes(T)?r.jsx(Ht,{fontSize:"medium"}):["ppt","pptx"].includes(T)?r.jsx(Vt,{fontSize:"medium"}):["txt","md","rtf"].includes(T)?r.jsx(Wt,{fontSize:"medium"}):["js","ts","jsx","tsx","html","css","scss","py","java","c","cpp","cs","json","xml","yml","yaml","sh","bat","go","rs"].includes(T)?r.jsx($t,{fontSize:"medium"}):r.jsx(We,{fontSize:"medium"}):r.jsx(We,{fontSize:"medium"})},_=async I=>{if(ae){await tt(I);const D=/\.(png|jpe?g|webp)$/i.test(I.name)?"/Pictures/letshare/":"/Download/letshare/";x(`${I.name} å·²æˆåŠŸä¿å­˜åˆ°è·¯å¾„: ${D}`,3e3,{kind:"success"})}else{const T=new Blob([I]),D=URL.createObjectURL(T),V=document.createElement("a");V.href=D,V.download=I.name,V.click(),URL.revokeObjectURL(D)}},Q=e!==null||C.length>0||v.length>0;return!c&&!o?null:r.jsxs(r.Fragment,{children:[r.jsx(Ue,{open:o,onClick:s,sx:{zIndex:i.zIndex.modal,backgroundColor:"rgba(0, 0, 0, 0.4)"}}),r.jsx(ot,{style:{userSelect:"none"},in:o,direction:"down",mountOnEnter:!0,unmountOnExit:!0,onExited:b,children:r.jsx(f,{onClick:I=>{I.target===I.currentTarget&&l(!1)},sx:{position:"fixed",top:0,left:0,width:"100%",display:"flex",justifyContent:"center",zIndex:i.zIndex.modal},children:r.jsxs(f,{className:"uniformed-scroller",sx:{width:{xs:"88%",sm:"80%",md:"60%",lg:"50%"},maxHeight:400,overflowY:"auto",backgroundColor:i.palette.background.paper,boxShadow:3,px:2,py:2,borderBottomLeftRadius:19,borderBottomRightRadius:19,display:"flex",flexDirection:"column",gap:2},children:[Q&&r.jsxs(r.Fragment,{children:[e!==null&&r.jsxs(f,{sx:{display:"flex",flexDirection:"column",gap:1},children:[r.jsx(j,{variant:"body2",color:"text.secondary",children:r.jsx(we,{i18nKey:"transfer.sending",values:{name:n?.split(":")[0]??"æœªçŸ¥ç”¨æˆ·"},components:{strong:r.jsx("strong",{})}})}),r.jsxs(f,{sx:{display:"flex",alignItems:"center",gap:2},children:[r.jsxs(f,{sx:{flex:1},children:[r.jsxs(j,{variant:"caption",color:"text.secondary",children:[e.toFixed(1),"%"]}),r.jsx(Ve,{variant:"determinate",value:e,sx:{height:8,borderRadius:5,mt:.5}})]}),r.jsx(L,{variant:"contained",color:"error",size:"small",onClick:R,sx:{whiteSpace:"nowrap",minWidth:64,...le},children:"å–æ¶ˆ"})]})]},"sending"),C.map(([I,T])=>{const D=T.size?T.receivedSize/T.size*100:0;return r.jsxs(f,{sx:{display:"flex",flexDirection:"column",gap:1},children:[r.jsx(j,{variant:"body2",color:"text.secondary",children:r.jsx(we,{i18nKey:"transfer.receiving",values:{name:I.split(":")[0],filename:T.name},components:{strong:r.jsx("strong",{})}})}),r.jsxs(f,{sx:{display:"flex",alignItems:"center",gap:2},children:[r.jsxs(f,{sx:{flex:1},children:[r.jsxs(j,{variant:"caption",color:"text.secondary",children:[D.toFixed(1),"%ï¼ˆ",T.receivedSize," / ",T.size,"   ",a("transfer.byte"),"ï¼‰"]}),r.jsx(Ve,{variant:"determinate",value:D,sx:{height:8,borderRadius:5,mt:.5}})]}),r.jsx(L,{variant:"contained",color:"error",size:"small",onClick:()=>M(I),sx:{whiteSpace:"nowrap",minWidth:64,...le},children:"å–æ¶ˆ"})]})]},I)}),v.length>0&&r.jsxs(f,{children:[r.jsxs(f,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mt:2,mb:1},children:[r.jsx(j,{variant:"subtitle2",children:a("transfer.receivedFiles")}),r.jsx(L,{onClick:A,endIcon:r.jsx(ct,{}),children:a("button.downloadAll")})]}),r.jsx(f,{sx:{display:"flex",flexDirection:"column",gap:1},children:v.map(([I,T])=>r.jsxs(f,{onClick:()=>_(T),sx:{display:"flex",alignItems:"center",gap:1.5,px:2,py:1.5,borderRadius:2,boxShadow:1,cursor:"pointer",transition:"0.2s","&:hover":{boxShadow:3,backgroundColor:i.palette.action.hover}},children:[F(T.name),r.jsx(j,{variant:"body2",noWrap:!0,children:T.name})]},I))})]})]}),c&&!Q&&r.jsx(f,{sx:{textAlign:"center",color:"gray",py:2},children:a("transfer.noTasks")})]})})})]})}class ${static instance=null;static isCreating=!1;dbName="letshare_chat_db";dbVersion=1;storeName="chat_histories";db=null;userIdProvider=null;constructor(){this.initDB()}static getInstance(){if(!$.instance){if($.isCreating)return $.instance;$.isCreating=!0;try{$.instance||($.instance=new $)}finally{$.isCreating=!1}}return $.instance}setUserIdProvider(e){this.userIdProvider=e}async initDB(){return new Promise((e,t)=>{const s=indexedDB.open(this.dbName,this.dbVersion);s.onerror=()=>{console.error("Failed to open IndexedDB:",s.error),t(s.error)},s.onsuccess=()=>{this.db=s.result,console.log("IndexedDB initialized successfully"),e()},s.onupgradeneeded=n=>{const a=n.target.result;a.objectStoreNames.contains(this.storeName)||(a.createObjectStore(this.storeName,{keyPath:"userId"}).createIndex("lastMessageTime","lastMessageTime",{unique:!1}),console.log("Created chat histories object store"))}})}async ensureDB(){if(this.db||await this.initDB(),!this.db)throw new Error("Failed to initialize database");return this.db}async addMessage(e,t,s,n,a="text"){try{const l=(await this.ensureDB()).transaction([this.storeName],"readwrite").objectStore(this.storeName);let h=await this.getChatHistoryFromStore(l,e);h||(h={userId:e,userName:t,messages:[],lastMessageTime:Date.now(),unreadCount:0});const d={id:`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,senderId:n,receiverId:e,content:s,timestamp:Date.now(),type:a,isRead:n===this.getCurrentUserId()};return h.messages.push(d),h.lastMessageTime=d.timestamp,n!==this.getCurrentUserId()&&h.unreadCount++,h.userName=t,await new Promise((b,g)=>{const p=l.put(h);p.onsuccess=()=>b(),p.onerror=()=>g(p.error)}),console.log(`[CHAT DB] Message saved for user ${e}`),{success:!0}}catch(i){const c=i instanceof Error?i.message:"Unknown error";return console.error("Failed to add message to IndexedDB:",i),{success:!1,error:c}}}async getChatHistoryFromStore(e,t){return new Promise((s,n)=>{const a=e.get(t);a.onsuccess=()=>{s(a.result||null)},a.onerror=()=>n(a.error)})}async getChatHistory(e){try{const n=(await this.ensureDB()).transaction([this.storeName],"readonly").objectStore(this.storeName);return await this.getChatHistoryFromStore(n,e)}catch(t){return console.error("Failed to get chat history from IndexedDB:",t),null}}async getAllChatHistories(){try{const s=(await this.ensureDB()).transaction([this.storeName],"readonly").objectStore(this.storeName);return new Promise((n,a)=>{const i=s.getAll();i.onsuccess=()=>{const c=i.result;c.sort((l,h)=>h.lastMessageTime-l.lastMessageTime),n(c)},i.onerror=()=>a(i.error)})}catch(e){return console.error("Failed to get all chat histories from IndexedDB:",e),[]}}async markMessagesAsRead(e){try{const n=(await this.ensureDB()).transaction([this.storeName],"readwrite").objectStore(this.storeName),a=await this.getChatHistoryFromStore(n,e);if(a){const i=this.getCurrentUserId();return a.messages.forEach(c=>{c.senderId!==i&&(c.isRead=!0)}),a.unreadCount=0,await new Promise((c,l)=>{const h=n.put(a);h.onsuccess=()=>c(),h.onerror=()=>l(h.error)}),console.log(`[CHAT DB] Messages marked as read for user ${e}`),{success:!0}}return{success:!1,error:"Chat history not found"}}catch(t){const s=t instanceof Error?t.message:"Unknown error";return console.error("Failed to mark messages as read in IndexedDB:",t),{success:!1,error:s}}}async deleteChatHistory(e){try{const n=(await this.ensureDB()).transaction([this.storeName],"readwrite").objectStore(this.storeName);return await new Promise((a,i)=>{const c=n.delete(e);c.onsuccess=()=>a(),c.onerror=()=>i(c.error)}),console.log(`[CHAT DB] Chat history deleted for user ${e}`),{success:!0}}catch(t){const s=t instanceof Error?t.message:"Unknown error";return console.error("Failed to delete chat history from IndexedDB:",t),{success:!1,error:s}}}async clearAllChatHistories(){try{const s=(await this.ensureDB()).transaction([this.storeName],"readwrite").objectStore(this.storeName);await new Promise((n,a)=>{const i=s.clear();i.onsuccess=()=>n(),i.onerror=()=>a(i.error)}),console.log("[CHAT DB] All chat histories cleared")}catch(e){console.error("Failed to clear all chat histories from IndexedDB:",e)}}getCurrentUserId(){return this.userIdProvider?this.userIdProvider.getCurrentUserId():(console.warn("UserIdProvider not set, using fallback"),"unknown")}async getTotalUnreadCount(){try{return(await this.getAllChatHistories()).reduce((t,s)=>t+s.unreadCount,0)}catch(e){return console.error("Failed to get total unread count:",e),0}}async searchChatHistories(e){try{return(await this.getAllChatHistories()).filter(s=>s.userName.toLowerCase().includes(e.toLowerCase())||s.userId.toLowerCase().includes(e.toLowerCase())||s.messages.some(n=>n.content.toLowerCase().includes(e.toLowerCase())))}catch(t){return console.error("Failed to search chat histories:",t),[]}}async getStats(){try{const e=await this.getAllChatHistories(),t=e.reduce((n,a)=>n+a.messages.length,0),s=JSON.stringify(e).length;return{totalHistories:e.length,totalMessages:t,dbSize:s}}catch(e){return console.error("Failed to get database stats:",e),{totalHistories:0,totalMessages:0,dbSize:0}}}}const Z=$.getInstance();class Zs{getCurrentUserId(){return S.getUniqId()||"unknown"}}class J{static instance=null;static isCreating=!1;isListening=!1;emitter=Ne();constructor(){Z.setUserIdProvider(new Zs)}static getInstance(){if(!J.instance){if(J.isCreating)return J.instance;J.isCreating=!0;try{J.instance||(J.instance=new J)}finally{J.isCreating=!1}}return J.instance}init(){this.isListening||(this.isListening=!0,this.setupEventListeners())}setupEventListeners(){S.emitter.on("message-sent",async({to:e,message:t})=>{console.log(`[CHAT INTEGRATION] Event 'message-sent' received for ${e}`),await this.handleSentMessage(e,t)}),S.emitter.on("message-received",async({from:e,message:t})=>{console.log(`[CHAT INTEGRATION] Event 'message-received' received from ${e}`),await this.handleReceivedMessage(e,t)}),console.log("Chat integration event listeners initialized")}async handleSentMessage(e,t){try{const s=S.getUniqId()||"unknown",n=e.split(":")[0]||"Unknown User",a=await Z.addMessage(e,n,t,s,"text");a.success?(console.log(`[CHAT INTEGRATION] Sent message to ${e} saved to history`),this.emitter.emit("history-updated",{userId:e})):console.error(`[CHAT INTEGRATION] Failed to save sent message: ${a.error}`)}catch(s){console.error("[CHAT INTEGRATION] Failed to handle sent message:",s)}}async handleReceivedMessage(e,t){if(e!==S.getUniqId())try{const s=e.split(":")[0]||"Unknown User",n=await Z.addMessage(e,s,t,e,"text");n.success?(console.log(`[CHAT INTEGRATION] Received message from ${e} saved to history`),this.emitter.emit("history-updated",{userId:e})):console.error(`[CHAT INTEGRATION] Failed to save received message: ${n.error}`)}catch(s){console.error("[CHAT INTEGRATION] Failed to handle received message:",s)}}async sendMessage(e,t){try{await S.sendMessageToUser(e,t),console.log(`[CHAT INTEGRATION] sendMessage called for ${e}`)}catch(s){throw console.error("[CHAT INTEGRATION] Failed to send message:",s),s}}async getChatHistory(e){return await Z.getChatHistory(e)}async markAsRead(e){try{return await Z.markMessagesAsRead(e)}catch(t){const s=t instanceof Error?t.message:"Unknown error";return console.error("[CHAT INTEGRATION] Failed to mark messages as read:",t),{success:!1,error:s}}}async deleteChatHistory(e){try{return await Z.deleteChatHistory(e)}catch(t){const s=t instanceof Error?t.message:"Unknown error";return console.error("[CHAT INTEGRATION] Failed to delete chat history:",t),{success:!1,error:s}}}}const be=J.getInstance(),Xs=["ğŸ˜€","ğŸ˜","ğŸ¤”","ğŸ‘","â¤ï¸","ğŸ˜‚","ğŸ˜¢","ğŸ˜®","ğŸ‰","ğŸ”¥"],_s=({open:o,onClose:e,targetUserId:t,targetUserName:s})=>{const{t:n}=ue(),a=fe(),[i,c]=y.useState(o),[l,h]=y.useState(""),[d,b]=y.useState(null),[g,p]=y.useState(null),C=y.useRef(null),v=y.useRef(null),A=()=>S.getUniqId()||"unknown",M=async()=>{try{console.log(`[CHAT PANEL] Loading chat history for ${t}`);const w=await Z.getChatHistory(t);if(console.log("[CHAT PANEL] Loaded history:",w),b(w),w&&w.messages.length>0){const P=await Z.markMessagesAsRead(t);P.success||console.warn(`[CHAT PANEL] Failed to mark messages as read: ${P.error}`)}}catch(w){console.error("[CHAT PANEL] Failed to load chat history:",w)}};y.useEffect(()=>(o?(c(!0),M(),S.setActiveChatUserId&&S.setActiveChatUserId(t)):S.setActiveChatUserId&&S.setActiveChatUserId(null),()=>{S.setActiveChatUserId&&S.setActiveChatUserId(null)}),[o,t]),y.useEffect(()=>{if(!o)return;const w=P=>{P.userId===t&&(console.log(`[CHAT PANEL] ğŸ“¨ Received history update event for ${t}`),M())};return be.emitter.on("history-updated",w),console.log(`[CHAT PANEL] ğŸ”Š Subscribed to history-updated events for ${t}`),()=>{be.emitter.off("history-updated",w),console.log(`[CHAT PANEL] ğŸ”‡ Unsubscribed from history-updated events for ${t}`)}},[o,t]),y.useEffect(()=>{C.current&&d?.messages&&setTimeout(()=>{C.current?.scrollIntoView({behavior:"smooth",block:"end"})},100)},[d?.messages]),y.useEffect(()=>{o&&C.current&&d?.messages&&d.messages.length>0&&setTimeout(()=>{C.current?.scrollIntoView({behavior:"auto",block:"end"})},300)},[o,d?.messages]);const R=()=>{c(!1),e()},F=async()=>{if(l.trim()){console.log(`[CHAT PANEL] Sending message to ${t}: ${l.trim()}`);try{await be.sendMessage(t,l.trim()),console.log("[CHAT PANEL] Message sent successfully"),h("")}catch(w){console.error("[CHAT PANEL] Failed to send message:",w)}}},_=w=>{h(P=>P+w),p(null)},Q=w=>{const P=w.target.files;P&&P.length>0&&console.log("Selected file:",P[0])},I=async()=>{if(window.confirm(`ç¡®å®šè¦åˆ é™¤ä¸ ${s} çš„æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`))try{console.log(`[CHAT PANEL] Deleting chat history for ${t}`);const P=await Z.deleteChatHistory(t);P.success?(b(null),e()):console.error(`[CHAT PANEL] Failed to delete chat history: ${P.error}`)}catch(P){console.error("[CHAT PANEL] Failed to delete chat history:",P)}},T=w=>{const P=new Date(w),H=new Date;return P.toDateString()===H.toDateString()?P.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):P.toLocaleDateString("zh-CN",{month:"short",day:"numeric"})+" "+P.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})},D=w=>{const P=A(),H=w.senderId===P,ie=H?"Me":s.charAt(0).toUpperCase();return console.log("[CHAT PANEL] Rendering message:",w,`isMyMessage: ${H}, currentUserId: ${P}`),r.jsxs(f,{sx:{display:"flex",flexDirection:H?"row-reverse":"row",alignItems:"flex-start",gap:1,mb:2},children:[r.jsx($e,{sx:{width:32,height:32,bgcolor:H?a.palette.primary.main:a.palette.secondary.main,fontSize:"0.875rem"},children:ie}),r.jsxs(f,{sx:{maxWidth:"70%",display:"flex",flexDirection:"column",alignItems:H?"flex-end":"flex-start"},children:[r.jsx(f,{sx:{px:2,py:1,borderRadius:3,backgroundColor:H?a.palette.primary.main:a.palette.grey[100],color:H?a.palette.primary.contrastText:a.palette.text.primary,wordBreak:"break-word"},children:r.jsx(j,{variant:"body2",children:w.content})}),r.jsx(j,{variant:"caption",color:"text.secondary",sx:{mt:.5,fontSize:"0.7rem"},children:T(w.timestamp)})]})]},w.id)};if(!i&&!o)return null;const V=d?.messages&&d.messages.length>0;return r.jsxs(r.Fragment,{children:[r.jsx(Ue,{open:o,onClick:e,sx:{zIndex:1300,backgroundColor:"rgba(0, 0, 0, 0.4)",position:"fixed",top:0,left:0,right:0,bottom:0,width:"100vw",height:"100vh"},children:r.jsx(ot,{in:o,direction:"up",mountOnEnter:!0,unmountOnExit:!0,onExited:R,children:r.jsx(f,{onClick:w=>{w.target===w.currentTarget&&e()},sx:{position:"fixed",bottom:0,left:0,width:"100%",display:"flex",justifyContent:"center",zIndex:1301},children:r.jsxs(f,{onClick:w=>w.stopPropagation(),sx:{width:{xs:"88%",sm:"80%",md:"60%",lg:"50%"},height:"70vh",backgroundColor:a.palette.background.paper,borderTopLeftRadius:19,borderTopRightRadius:19,boxShadow:3,display:"flex",flexDirection:"column",position:"relative"},children:[r.jsxs(f,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:3,py:2,borderBottom:`1px solid ${a.palette.divider}`,borderTopLeftRadius:19,borderTopRightRadius:19},children:[r.jsxs(f,{sx:{display:"flex",alignItems:"center",gap:2},children:[r.jsx($e,{sx:{bgcolor:a.palette.secondary.main},children:s.charAt(0).toUpperCase()}),r.jsxs(f,{children:[r.jsx(j,{variant:"h6",fontWeight:"bold",children:s}),r.jsx(j,{variant:"caption",color:"text.secondary",children:V?`${d.messages.length} æ¡æ¶ˆæ¯`:"å¼€å§‹èŠå¤©"})]})]}),r.jsx(X,{onClick:I,color:"error",size:"small",children:r.jsx(Jt,{})})]}),r.jsx(f,{className:"uniformed-scroller",sx:{flex:1,overflowY:"auto",px:3,py:2,display:"flex",flexDirection:"column"},children:V?r.jsxs(r.Fragment,{children:[d.messages.map(D),r.jsx("div",{ref:C})]}):r.jsx(f,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",color:"text.secondary"},children:r.jsx(j,{variant:"body2",children:n("chat.noMessages","æš‚æ— èŠå¤©è®°å½•")})})}),r.jsxs(f,{sx:{px:3,py:2,borderTop:`1px solid ${a.palette.divider}`,display:"flex",alignItems:"flex-end",gap:1},children:[r.jsx(f,{sx:{flex:1},children:r.jsx(G,{fullWidth:!0,multiline:!0,maxRows:4,value:l,onChange:w=>h(w.target.value),placeholder:n("chat.inputPlaceholder","è¾“å…¥æ¶ˆæ¯..."),variant:"outlined",size:"small",onKeyDown:w=>{w.key==="Enter"&&!w.shiftKey&&(w.preventDefault(),F())},sx:{"& .MuiOutlinedInput-root":{borderRadius:3}}})}),r.jsxs(f,{sx:{display:"flex",gap:.5},children:[r.jsx(X,{onClick:w=>p(w.currentTarget),size:"small",children:r.jsx(Gt,{})}),r.jsx("input",{type:"file",ref:v,style:{display:"none"},onChange:Q}),r.jsx(X,{onClick:()=>v.current?.click(),size:"small",children:r.jsx(qt,{})}),r.jsx(X,{onClick:F,disabled:!l.trim(),color:"primary",size:"small",children:r.jsx(Yt,{})})]})]})]})})})}),r.jsx(Qt,{open:!!g,anchorEl:g,onClose:()=>p(null),anchorOrigin:{vertical:"top",horizontal:"center"},transformOrigin:{vertical:"bottom",horizontal:"center"},disableScrollLock:!0,disableEnforceFocus:!0,disableAutoFocus:!0,container:document.body,sx:{zIndex:1400},slotProps:{paper:{sx:{overflow:"visible",boxShadow:3}}},children:r.jsx(f,{sx:{p:2,maxWidth:200},children:r.jsx(Je,{container:!0,spacing:1,children:Xs.map((w,P)=>r.jsx(Je,{item:!0,xs:2.4,children:r.jsx(L,{onClick:()=>_(w),sx:{minWidth:"auto",width:"100%",aspectRatio:1,fontSize:"1.2rem"},children:w})},P))})})})]})},en={position:"relative",padding:"10px",borderRadius:"8px",display:"flex",flexDirection:"column",mt:"10px",mb:"5px",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.1)",overflow:"hidden",cursor:"pointer"},ye={"& .MuiBadge-badge":{top:4,right:4}},le={borderRadius:"5px",borderColor:"#e0e0e0"},tn=Le(()=>{const{t:o}=ue(),e=fe(),[t,s]=y.useState(null),[n,a]=y.useState(!1),[i,c]=y.useState([]),[l,h]=y.useState(!1),[d,b]=y.useState("clip"),[g,p]=y.useState(null),[C,v]=y.useState(null),[A,M]=y.useState(!1),[R,F]=y.useState(""),[_,Q]=y.useState(null),[I,T]=y.useState(!0),[D,V]=y.useState(!0),[w,P]=y.useState(!1),[H,ie]=Y.useState(!1),[ht,gt]=Y.useState(""),[Ce,ve]=y.useState(!1),[te,ze]=y.useState(null),ft=y.useRef(null),Be=y.useRef(null);y.useEffect(()=>{if(!Ce||!te)return;const u=i.find(E=>E.uniqId===te);(!u||u.status==="disconnected")&&(console.log(`[CHAT UI] Target user ${te} disconnected, closing chat panel`),ve(!1),ze(null))},[i,Ce,te]);const Ke=i.some(u=>u.status!=="disconnected"),pt=u=>{switch(u){case"apple":return r.jsx(hs,{sx:{transition:"color 0.3s ease"}});case"android":return r.jsx(us,{sx:{transition:"color 0.3s ease"}});case"desktop":return r.jsx(qe,{sx:{transition:"color 0.3s ease"}});default:return r.jsx(qe,{sx:{transition:"color 0.3s ease"}})}},mt=()=>{F(""),M(!0)},yt=u=>{const E=Array.from(u.entries()).map(([N,B])=>{const[W,se]=N.split(":");return{uniqId:se?`${W}:${se}`:N,name:W||N,status:B.status,userType:B.userType}});c(E)},bt=async()=>{h(!0);try{S.isConnected()?(m.updateUnrmb("isConnectedToServer",!0),S.broadcastSignal({type:"discover",userType:z()})):await S.connectToServer()?(m.updateUnrmb("isConnectedToServer",!0),S.broadcastSignal({type:"discover",userType:z()})):m.updateUnrmb("isConnectedToServer",!1),await new Promise(u=>setTimeout(u,1e3))}catch(u){console.error("Search error:",u),m.updateUnrmb("isConnectedToServer",!1)}finally{h(!1)}},xt=async u=>{b("image"),ke(u,!0)},ke=async(u,E)=>{const N=u.target.files;if(!(!N||N.length===0)){if(b(E?"image":"file"),N.length===1){const B=u.target.files?.[0]||null;B&&p(B);return}try{const B=new Se;Array.from(N).forEach(he=>{B.file(he.name,he)});const W=await B.generateAsync({type:"blob"}),se=new File([W],`LetShare_${Date.now()}.zip`,{type:"application/zip"});p(se)}catch{x(o("toast.zipFailed"),2e3,{kind:"error"})}}},St=async(u,E)=>{try{const N=S.canSendFileToUser(E),B=S.canSendMessageToUser(E);if((d==="text"||d==="clip")&&!B){x(o("toast.connectingUser"),2e3,{kind:"warning"}),S.connectToUser(E);return}if((d==="file"||d==="image")&&g){if(S.isSendingFile){x(o("toast.taskInProgress"),2e3,{kind:"info"}),P(!0);return}P(!0),N?(console.log("ğŸ“¡ ä½¿ç”¨P2Pæ–¹å¼å‘é€æ–‡ä»¶"),await S.sendFileToUser(E,g)):(console.log("ğŸŒ P2Pä¸å¯ç”¨ï¼Œä½¿ç”¨æœåŠ¡å™¨è½¬å‘æ–‡ä»¶"),x(o("toast.serverTransferMode"),2e3,{kind:"info"}),await S.sendFileViaServer(E,g))}else if(d==="text"&&C)await S.sendMessageToUser(E,C);else if(d==="clip"){let W=await zs();W!=""?await S.sendMessageToUser(E,W??"è¯»å–å‰ªåˆ‡æ¿å¤±è´¥"):x(o("toast.clipboardEmpty"),2e3,{kind:"info"})}else x(o("toast.noContentSelected"),2e3,{kind:"info"})}catch(N){console.error("å‘é€å¤±è´¥ï¼š",N)}};y.useEffect(()=>(S.connectToServer().then(u=>{u&&S.broadcastSignal({type:"discover",userType:z()})}),S.init(gt,u=>{s(u),a(!0)},P,yt,Q),be.init(),setTimeout(()=>{V(!1)},1e3),()=>{S.disconnect()}),[]),y.useEffect(()=>{const u=async E=>{if(A||n)return;const N=E.clipboardData;if(!N)return;const B=N.items;for(const se of B)if(se.kind==="file"){const he=se.getAsFile();if(he){p(he),b("file");return}}const W=N.getData("text/plain");W&&W.trim().length>0&&(v(W),b("text"))};return window.addEventListener("paste",u),T(!1),()=>{window.removeEventListener("paste",u)}},[A,n]);const wt=()=>{try{t&&(Bs(t),x(o("toast.copiedToClipboard"),2e3,{kind:"success"}))}catch(u){console.error("å¤„ç†æ¥å—å¤±è´¥",u)}finally{a(!1),setTimeout(()=>{s(null)},500)}},Ct=u=>{u.preventDefault(),u.stopPropagation()},vt=u=>{u.preventDefault(),u.stopPropagation(),ie(!0)},kt=u=>{u.preventDefault(),u.stopPropagation();const E=Be.current?.getBoundingClientRect();E&&(u.clientX<E.left||u.clientX>E.right||u.clientY<E.top||u.clientY>E.bottom)&&ie(!1)},Tt=u=>{u.preventDefault(),u.stopPropagation(),ie(!1);const E=u.dataTransfer.files;E.length>0&&ke({target:{files:E}},!1)};return r.jsxs(r.Fragment,{children:[!D&&r.jsxs(f,{ref:Be,onDragEnter:vt,onDragLeave:kt,onDragOver:Ct,onDrop:Tt,sx:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:{xs:"89%",sm:"80%",md:"60%"},height:ae?"85svh":"75vh",p:3,m:"auto",boxShadow:8,borderRadius:2,backgroundColor:"background.paper",zIndex:u=>u.zIndex.modal,display:"flex",flexDirection:"column",justifyContent:"space-between"},children:[H&&r.jsx(Me,{in:H,timeout:400,unmountOnExit:!0,children:r.jsx(f,{sx:{position:"absolute",top:0,left:0,width:"100%",height:"100%",zIndex:1e3,backgroundColor:"rgba(0, 0, 0, 0.4)",borderRadius:2,display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"none"},children:r.jsx(j,{variant:"h6",color:"white",children:o("prompt.dropToUpload")})})}),r.jsx(Js,{}),r.jsxs(f,{sx:{display:"flex",gap:2,flexWrap:"wrap"},children:[r.jsx(pe,{color:"primary",badgeContent:d==="file"?1:0,overlap:"circular",sx:ye,children:r.jsx(L,{variant:"outlined",sx:le,startIcon:r.jsx(Zt,{}),disabled:!Ke,onClick:()=>{const u=document.getElementById("multi-file-input");u&&(u.value="",u.click())},children:o("button.file")})}),r.jsx("input",{id:"multi-file-input",type:"file",hidden:!0,multiple:!0,onChange:u=>{ke(u,!1)}}),r.jsx(pe,{color:"primary",badgeContent:d==="image"?1:0,overlap:"circular",sx:ye,children:r.jsx(L,{variant:"outlined",sx:le,startIcon:r.jsx(Xt,{}),disabled:!Ke,onClick:()=>{const u=document.getElementById("image-input");u&&(u.value="",u.click())},children:o("button.image")})}),r.jsx("input",{id:"image-input",type:"file",hidden:!0,accept:"image/*",multiple:!0,onChange:xt}),r.jsx(pe,{color:"primary",badgeContent:d==="text"?1:0,overlap:"circular",sx:ye,children:r.jsx(L,{onClick:mt,variant:"outlined",startIcon:r.jsx(_t,{}),sx:le,children:o("button.text")})}),r.jsx(pe,{color:"primary",badgeContent:d==="clip"?1:0,overlap:"circular",sx:ye,children:r.jsx(L,{onClick:()=>b("clip"),variant:"outlined",startIcon:r.jsx(es,{}),sx:le,children:o("button.clipboard")})})]}),r.jsx(f,{sx:{display:"flex",justifyContent:"space-between",mt:2},children:r.jsx(L,{ref:ft,onClick:bt,variant:"contained",color:m.getUnrmb("isConnectedToServer")?"primary":"error",endIcon:l?r.jsx(Fe,{size:20,color:"inherit"}):m.getUnrmb("isConnectedToServer")?r.jsx(ts,{}):r.jsx(ss,{}),disabled:l,children:o("button.searchUsers")})}),r.jsx(it,{sx:{mb:.5,mt:2}}),r.jsxs(f,{className:"uniformed-scroller",sx:{mt:0,p:0,flexGrow:1,overflowY:"auto"},children:[i.length==0&&m.get("isNewUser")?r.jsx(r.Fragment,{children:r.jsx(f,{sx:{display:"flex",alignItems:"center",justifyContent:"center",textAlign:"left",height:"100%",px:2},children:r.jsxs(f,{children:["  ",r.jsxs(j,{variant:"body2",color:"text.secondary",sx:{whiteSpace:"pre-line"},children:[o("guide.title"),`
`,r.jsx(we,{i18nKey:"guide.step1",components:{strong:r.jsx("strong",{})}}),`
`,r.jsx(we,{i18nKey:"guide.step2",components:{strong:r.jsx("strong",{})}})]})]})})}):r.jsx(r.Fragment,{}),[...i].sort((u,E)=>u.status==="connected"&&E.status==="connected"?ut(u.uniqId,E.uniqId)?-1:1:0).map(u=>r.jsx(f,{children:r.jsx(ns,{onClick:E=>{d==="video"?S.isConnectedToUser(u.uniqId)||S.connectToUser(u.uniqId):St(E,u.uniqId)},sx:{...en,width:"96%",textAlign:"inherit",backgroundColor:u.status==="connected"?"rgba(76, 175, 80, 0.1)":u.status==="connecting"?e.palette.action.hover:e.palette.background.paper,opacity:u.status==="connecting"?.7:1,transition:"all 0.3s ease-in-out","&:hover":{boxShadow:u.status==="connected"?2:1,bgcolor:u.status==="connected"?"rgba(76, 175, 80, 0.15)":u.status==="connecting"?"rgba(0, 0, 0, 0.12)":"background.default"},padding:1.5,borderRadius:2,display:"block"},children:r.jsxs(f,{sx:{display:"flex",alignItems:"flex-start",textAlign:"left",gap:1,width:"100%",transition:"opacity 0.3s ease",opacity:u.status==="connecting"?.8:1},children:[pt(u.userType),r.jsx(j,{variant:"body1",sx:{width:"100%",textAlign:"left",color:u.status==="connected"?"text.primary":"text.secondary",transition:"color 0.3s ease"},children:u.name}),r.jsxs(f,{sx:{display:"flex",alignItems:"center",mr:"5px"},children:[u.status==="connected"&&r.jsx(rs,{sx:{color:"success.main",fontSize:27}}),u.status==="connecting"&&r.jsx(as,{sx:{color:"text.secondary",fontSize:27}}),(u.status==="text-only"||u.status==="waiting")&&r.jsxs(f,{sx:{display:"flex",flexDirection:"row",alignItems:"center"},children:[r.jsx(is,{label:o("status.textOnly"),size:"small",sx:{backgroundColor:"text.secondary",color:"background.paper",fontSize:"0.75rem",fontWeight:"bold",borderRadius:"4px",px:.5,mr:"10px",py:.25,"& .MuiChip-label":{padding:0}}}),r.jsx(os,{sx:{color:"text.secondary",fontSize:27,mr:"5px"}})]})]}),r.jsx(f,{onClick:E=>{E.stopPropagation(),ze(u.uniqId),ve(!0)},sx:{mr:1,opacity:.7,"&:hover":{opacity:1}},children:r.jsx(X,{size:"small",children:r.jsx(cs,{sx:{fontSize:20}})})})]})},u.uniqId)}))]}),r.jsx(ls,{color:"primary",onClick:()=>{P(!0)},sx:{position:"absolute",bottom:65,right:35,zIndex:u=>u.zIndex.modal+1},children:r.jsx(ct,{})}),r.jsx(Gs,{})]}),r.jsxs(xe,{open:n,onClose:()=>{a(!1),setTimeout(()=>{s(null)},300)},children:[r.jsx(at,{children:o("dialog.newShare")}),r.jsxs(je,{sx:{width:{sx:200,sm:300,md:400,lg:400}},children:[r.jsx(ds,{children:o("dialog.incomingMessage")}),t&&r.jsx(G,{value:t??"",multiline:!0,fullWidth:!0,InputProps:{readOnly:!0},variant:"outlined",sx:{border:"none",maxHeight:300,overflowY:"auto",borderRadius:1,mt:1,fontSize:{xs:"14px",sm:"15px"},"& .MuiInputBase-input":{whiteSpace:"pre-wrap"}}})]}),r.jsxs(Ge,{children:[r.jsx(L,{onClick:()=>{a(!1),s(null)},color:"secondary",children:o("button.reject")}),r.jsx(L,{onClick:wt,color:"primary",autoFocus:!0,children:o("button.accept")})]})]}),r.jsx(xe,{open:A,onClose:()=>M(!1),fullWidth:!0,maxWidth:"sm",PaperProps:{sx:{borderRadius:2,maxWidth:500,mx:{xs:1,sm:"auto"}}},children:r.jsxs(f,{sx:{padding:"20px"},children:[r.jsxs(Ge,{sx:{justifyContent:"space-between"},children:[r.jsx(j,{variant:"h6",sx:{flexGrow:1},children:o("dialog.inputText")}),r.jsx(L,{onClick:()=>M(!1),color:"secondary",children:o("button.cancel")}),r.jsx(L,{onClick:()=>{R?(v(R),b("text")):x(o("toast.emptyInput"),1e3,{kind:"info"}),M(!1)},color:"primary",variant:"contained",children:o("button.confirm")})]}),r.jsx(je,{children:r.jsx(G,{autoFocus:!0,value:R,onChange:u=>F(u.target.value),multiline:!0,rows:5,fullWidth:!0,variant:"outlined",placeholder:`${o("placeholder.inputText")}...`,sx:{px:0,fontSize:{xs:"14px",sm:"16px"}}})})]})}),r.jsx(Qs,{targetUserId:ht,onClose:()=>{P(!1)},open:w,progress:_,setProgress:Q}),r.jsx(Ue,{sx:{color:"#fff",zIndex:u=>u.zIndex.drawer+9999},open:I,children:r.jsx(Fe,{color:"inherit"})}),r.jsx(qs,{open:D}),r.jsx(Es,{}),te&&r.jsx(_s,{open:Ce,onClose:()=>ve(!1),targetUserId:te,targetUserName:te.split(":")[0]||"Unknown User"})]})}),st={light:oe({palette:{mode:"light"}}),dark:oe({palette:{mode:"dark"}}),blue:oe({palette:{mode:"light",primary:{main:"#1976d2"},secondary:{main:"#90caf9"},background:{default:"#e3f2fd",paper:"#ffffff"}}}),green:oe({palette:{mode:"light",primary:{main:"#388e3c"},secondary:{main:"#a5d6a7"},background:{default:"#f1f8e9",paper:"#ffffff"}}}),sunset:oe({palette:{mode:"light",primary:{main:"#f57c00"},secondary:{main:"#ffcc80"},background:{default:"#fff3e0",paper:"#ffffff"}}}),coolGray:oe({palette:{mode:"dark",primary:{main:"#90a4ae"},secondary:{main:"#cfd8dc"},background:{default:"#263238",paper:"#37474f"}}})},sn=Le(()=>{const o=m.get("userTheme")||"system",e=window.matchMedia?.("(prefers-color-scheme: dark)").matches,t=o==="system"?e?"dark":"light":o,s=st[t]??st.light,[n,a]=y.useState(s);return y.useEffect(()=>{a(s);const i=s.palette.background.default,c=document.querySelector('meta[name="theme-color"]');c&&i&&c.setAttribute("content",i),ae&&Et(async()=>{const{NavigationBar:l}=await import("./@hugotomazi-vendor-BCKjIbph.js").then(h=>h.i);return{NavigationBar:l}},__vite__mapDeps([0,1]),import.meta.url).then(({NavigationBar:l})=>{l.setColor({color:i,darkButtons:t!=="dark"})})},[m.get("userTheme")]),r.jsxs(gs,{theme:n,children:[r.jsx(fs,{}),r.jsx(ps,{styles:i=>({"::selection":{backgroundColor:i.palette.primary.light,color:i.palette.getContrastText(i.palette.primary.light)}})}),r.jsx(tn,{})]})}),nn="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANMAAACECAYAAAAKjB6WAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NjdFMjg1MUU1MEJGMTFFN0IxNEZDN0U5MzZCREMyQjMiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NjdFMjg1MUY1MEJGMTFFN0IxNEZDN0U5MzZCREMyQjMiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo2N0UyODUxQzUwQkYxMUU3QjE0RkM3RTkzNkJEQzJCMyIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo2N0UyODUxRDUwQkYxMUU3QjE0RkM3RTkzNkJEQzJCMyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PrGIRRAAABbASURBVHja7F1/cFzFfd9VnHSSP8qN5KEJgnIax1HtOOZMXPqDaX3u7yRNdAKatDSp7igBG9nWHcaOHZKRNGmwMQHdGQOG0Nxp0naYlEHnDAmdtBM9t5PAOIAO4+AYx6NzsBnGtZSbTjuZ/uBed9/tCel80r39fnf3vZP3O35zZ937sW/3+9nv9/vZ3e/SbNe9I4SQYWJOHHaU2XGUHcX0zFcrBp9N2PuOsY+0zCWsjBnJZ7iIIvK62aCiXlg5Iuxjih1RxG16WFnKxEpL6TAMJC5xdiTZkWfHz1mD59kRNQSkpCSQuKTZdXHJa4qIYvK6GFP0ymkkkIoWSHJgClq4gk8LUEU0P2sIeJ1sh5NiB8ayJLEdjKjLIcQtePkzFiLtBab5oJpiShDTZJX4faH3jssot3DRcgrqA2uVMJ1Tzlql9gVT3cWZEu6YahkwadWYIo6I+Af8PKSlxlglXu6shUd7g6ku3OVLaLB8pq/HuEkRQHw3PzbEAHHUNDFkwaQfUEpcPgXK5Sm3rMVkCsmJCCcA64QhlRxW7oKFxvICU0QASgUpMaCoTJD7pExaJwF4DHkxamGx/MBEBGGQxtxAEAdxReWJy7JsIojPGgQwxioVWHkdC4vlCSZPOZA08ZDi8kBiJ97bQ2OQqF/3UoyHQevKUuGXAZiwvW1ScVmkXT0RzI8aeH9MPeUs6YATipj6Uiatqd8IgY/tNPaaPbKNLRjBCQ311i/IBVmXcxphOVJLEQPCKk1C25Ldu8fCAScrENeOi7GUVgpUD6IxvSa/BwdGISDiodl9IVOGUgiFH27x/pj6te5dO7h53JoI0KWQt9oEIB4Sml4rAYnjRHAPDfCji80RRJIsDsTKWgkwZhIuCiZukFWWpOZXgt4f06kMW6tkwTTXiRIEqxUSFw91fyRVHm+0TsIqQYHNqfCShUEbgkkQCA4YiT6XQgjiIar5daKIKU8YqnxYkVWyVHibWyYurxh4Rh8kdjD0HCxVPmedBLkDtUqWCl8GYNLrR8IVDBLLJKHTnZgic1evjHQxobNDyn6YWCvhB9N1ISQGCiKWKRp6HpaMSIpJwNDZHda9a3cwiV48jriFn2AZomBHGj5lBDxdCUmV8/EqiFW0VPgysUyY1Z+VVj4+cG5aZZ5yQZQsCsgRocI6QevRWqV2B5NQONQ6G4lYQkaKDcQABFBgGl7BrHJZd9ZS4e0KJu7aiXRik8hbHfXhQkKo6iMt/q+ViBCCocp9W2BrlfQKZm7eAFOgVlN8VE109XrVFr8nAK5PpUn8wP+fB5QPMndwziKyuuSAGtPY1pYKD7FligoyYalDGZB8KAKECHCaKTbQ1UOtmxJUuS4XzFLhy5CAgMp4CxcPmsbriOTfl5KYgpwVutww695ZMM1ZpVbkA9QqFCX/rts6OQSXDbap9bVUuAWTTNAMIR4WzXOOcPUSChLAqLYiKavmFkxc+n2MLSUJbMzlCPL3ZgJlFOcDuUzUZQjK2qysFkxej+ozUw50jKeI/F2Lq1cHAcFT5RVi03ZZMJEW+Q7mWaUogU1ParmVjfi9ALg3mogQz8a6ezYr62UOJt74myUyikKtwLgiV1C1tZwPKF4HUBetLKh2K5cpmLjy9EgmQUxCAOuX3RLnQXr3pKI6KRu+zgpCVoQERDnZOWOY/OHs2knN7+TlJbc5uy2YdItD1GzD2QdVdKIuXXIrV8+CyYLJd4A7EkShNafxUiVeXnJLTduYKeySbJNyDlkVs2AKuwxY0FuxYMK7eCbSeKmSiIYdEK1YMF12Vqldy2vlcgATYjVtkJJA7i9lxYLJxiA2drJgCrO0KztmXT0LplC5eHHSPsRDo0QtEWHBZHt3W34rPmVFOxQSmaCer+lxFBaHW0hI/r+EnRFhwRQGgbpIFdVTnhggSgSeTJO/h10aYd28QEV1whSwIBYNYt7DigWTEksATePFJaepWNBFg9i85FYsmAKxSmVdebXFokFo7GOJCAumwIgHaLyU01y8ceB1SQXpwKxYMIECdqjiFTSXDXP/pFW95SdhZ/PAxIPuzDyc4mYWxiENq3bf9663yS+z4z0dLnkffZt0UELeS6uk6lLvd5cfVTL2/aszY9539nf2WWEfJfa9Uq3t+cu+E+f1/7YK2m5gKgEDfBP7/EQB15jMFzf6Sx3VeOe7/5dcseJtEnn3/xFS5YChddCw/9IagpaW+UvpEzXQURJ9z/+Q/6y+i/yiSsl/VaWciKNWtc0LFbFJHBDcl3UXTsQWsbCV7eXewQgDSoIpPLecsWq1VpXexyJgarBMxKXiHFd80tr3qnjGO+dT7/y32fdfVDvK7Mj9h9uxVEdWsRuaBQgmKz5Nce9glCn+EDuSTMEjrqg+E2CqnTt3vsO+j9/07wcKtlUsmNpKjq+5iwGHjDGlTs4HUIBgqn8v3HzxfpuYPyTSYatgaXl1zdYRprbTJJwMXPLplV+I2VYKDwFhpYmcWLs1xoxCnlkFq6xWrGWCyo/XbhlhTtYUIaEHUumWi/dbssFapvDJyXVbOHs4UXVJ3AedHbRUmPvZ3/jHp7r2xljReYxXuXVmnwWatUzm5Sfr7uRWiOcgj7dFgSlJ3XzxQHkhkPakSc2i8veY+vvOvSO2ZS2YjMqp9TUgUdI28VH2pgsHFiwv+Vbnnjgr/1jDecPf7Nybty1sqn+7zOX19Xcwt4hOui6JEEE7VwVX7dHVdVp6jqKWosZLVUJL7D9nqy7lVqTchBqPi8dtYt9jVTEXcQlqvJS4cGBDA5D4NdPsksjcs8X5HjVPSeFzM/dZCt3GTPrktAckzyJFFIVI9Y2l+Xon58azB/3MD3Tm/+e57p28TNzVHGhCgPD7pZp0iRPEXXJCcHK864tkwAJKr2XKdt3L/ephoOLkVC4LFxl8uFsSkSxHyu8GZnX5aYwBqUomXe9Z9B1rBLNMDBB0/IYzDxdUNs53rronyizRELMwHGDMqtHRvrcWxklPr9wzwn4f9qwWnWcVF1qm2jsRUhiYXRxQrP6hDCbvEPp1TS5m5eLuaxp4eb9f3RALUScIbE5oZgWB5zPgCj/McyLIKvISMkTkl1xExHW+y3Am9nluifJMySJI1o4r0egNZw45OpToE29+jQNn0b1tawO27rCEt54sdN17NLn4JmxRYFHjQtlHNAApgQASlz4J3ZhA1MEmFQTEWBsudssjyQbeA/dvPH1oMzucIF7gmZW7I6LxpYR3IvnFN7DGdIq6VhD3Ia8/4hO0MYLLy3hEBZiiCOtmXJhV4r0cJiEkV7iej55+pBjoi1CvQ4A2/sQ3Opt2gJjVyVHsLvOLCKatKhJe0wDyOQVV1HhaU0UqlenrPx+j9BL6WEZSG0490s+OSpDv8cyVu7EdQtStxaYLG7G2dKMcFusklgZhvB6ZDi+JfY7KcaZ2GM+AAomDZ0Ps1KOFoF+geOXuGCWoDmGux3+y+To2jHVSnQIa6+KN+wRtAgnanGowxQQzGEopX397ksBmN3Agbb7u5KOl4IG0K6K003Jps3thOgzVrh4GnHyRqGMAtKX6YkzVMyCGwrgXEQNSBGSV3BqQ1p98LBxz3Gouakzh/aJPdn1ppMHVq4SBiFBACPilwzGptxdYctVgUttzKtMZj1qFmPH+j4QESN9+/64k1bGmyiVDT3R+KQJxjzS7elhQjhso74KOR8fcvDhDezIsQPrZRmaVKCTLkZtZ99pjTkiAFCNq4qTFOsB0g3XCJNlU5erFEdfKJCDFgHZBFixdE13DNPaUBFgl58OvHQ5Tgv08wQXILd1zRM+u3KqIUAEDyJzEc+KqnqMLTCFy91xZq1ShlIRmDtuzH9g1ZmA2e4S5ekmFRATWM8G6ikUDz3EarZ/OJRiJoJPU/2zjX8cBQWxu7YnDvlycF1dvS/5o9baxY6u2pY+t2q7ccjx71T0J5qKmTdSVS+lQg6vH6wDq5kaQOyViLFtJItUb5jmXWG7d65nyQbp7VLqy3PKaE4dH/Jz50upBruR5QW6MqbbEfJIrNWvdY493fTmq0NUD0c0KXDy/Y0uY3VW8GQ+mwcQrJsipRrK9o69MsC/3DjYjBBIvrNqukiSYQMZJ/QASIdFgnbjCVAzVvQriQcY9HVD9DBMrbdNBuHtvbLwtLqmMlV878XjLhpjqHVxqgmn6hZ7t2HiBfPeqnbjxJJdkb53ZV5S1LK7bVMGgY05QVw8zgCqTYx7jhuaCAhMh+mhdlY3it0drNcE0/3zPdjAQnuveGae4OKn0F7P7MjVMSW/5GTvc+eWIH8XR0QbILYS4+J0hniDwAWFnsZjMFJjMTzWicj07U+CWvXipdzDpr7Hp5A97dkg31j917wQtq5hvXcm8lbifnd0Hmc0Qb3D1OGMFHbhOaD6/8d2LOkDut3MxmVBl2ORUIyrne5d7jz++pMK8suYuvhDPr4X1QPGDa3dEJMuMjZMyf35pei/ZLUNj0KBegaun3cVDWr/yUks6TGcnMsJOnb/hNlk3y1nqR55rnMgPnMZk3vd73XePIIPvwmdm9hdk362JbEK4wFiAYN7fb6eBmSG+ZKdiGkx8qpGJcRNJC+ge9dEAkDgo8W/XDrW0Zt+7+u44M0sY1pNbo6bL2z83ex/PiFTG1B1yh3lfVgC7DEJiESDG+mV1gQlKmZpw92IAZVQIzoXtzACVXOzHf+6+O0JdlMWu8ISUn57dX0G8n5931e3qodYu+ZkPiHTxCq3cSAyYoCwPbDmEnFwhc/KHjj/RStnKqNIwsPzrNenYInFSHgnW0T+7uL9V+V+RueFjlzJ6RKwNgtaDnzEd7BQiP89IIu7fsjMBg0mk+AKzPMjpJiotU8t3WH/SW2FbwuGJTB69Jr1ASf+lO4POR3HLxfuzKt7RZ/2NI9o70sKqYGfKJBQBbjHiwdEGJiEZDBkRkpnlft3VzQjXtm6RJx0BqO9fncHmo2BWwk0pfseWro4mZVexoHDJpR/IaUq+ZsagwCTQmkUoV9tkNbru5KMVl1AsoLxpSAxI2PEk7h/233zxgNHELmKwEjojok+ji+cHlEPAe/oev1LB5o0iFCwd9MxyGdlw6pES0hp7fjt13SlknJS56cKBoFYAK3X1FCxP9wtKKGB9T1FCg0k8COXukTYSBqiC69PsL+WSIK51+i8cCGzhoqCgVU5+VRk7R5vF4qLDhta577buUFTB3Jd2EBUw0k6Auv7UIyPI+AET3/WHoAqg794n6f6pegY0JnMk1kYpHbTFrE4dDjCJJbTH4tbYrKvF4qTEBVCcFFVcEuiwyAJXT8HaJd3WT8qlVQYmgWCM+6Ny7OmobkX76Gkvq+tm1yWmSIDRvrcecEx0GFtnv+L4aGtHgbLrGB5ZMEiMmFnRdAGgKctUH3sqAy+Pk4C2wOQbnkGu23j6kAcoQrQDyvnUWw9gXOHrQkRE9Clwv0w8Q9r66pibF4ZkJKoGKVvKr//0kAqGr1WchK1Tmffza3GgRITn6gl3T5drnxBWCTV9KHAwibGnQsBgkrSOdBPmYTecOVRw4eNtLTunT771ANTak292fjEquVtG2Wc7YzK/JjW5ePNdPcwzijLEg07LVA/OA9spovvYN2QtE9q9/I0zD2cILq1wM8n+6ZsPYO8pq1Ay8/igRMQAUc/iNXP1oAO1IBdWC5gUjD2hxZULkKNix3Wk0JSrjOFzS59482sq6lA2ZihJtDN0FW5Ms2WqdyKQNi1Dd8LUtp4JOfakAk1HpU53wb3YnPzmmYP1cSCsVa5QBeNJf9e5NyqrUFtaMHkKiYiwCjjnhe7FgUFaJ9neJfGTdXeiJ97+1vTDfDHeZpyBI6mPv/lgGVsWKt9BQHrkwjIDUyGUYBJuwGgQNXLNi17cJGMhLklgD5Xfnj5YYpYOysAVPnbuQXTs9Q9de/mGBUkp8FHpfBHYVbhS1toEkDA7xptYts5ZrjIJRmSVcujkui1KloXcWD5YIPIMX4mqs+aQbXSgID5ioC1NDLmMu6wXhB7awSSQHsjYkyvt/1Kly0JuPHtQhuGr8PVJf3L+QXQPzKwSj5WkXbw7Z75SAbYxZgsaP+KIZ+icviWz02Bglqk+9mR8d/JfffFvIWxT+rUPb1E5mOiX4cv88fmHVCnLmKxVoq6LJRJ0EhHjBp6BDkdMZicKaOyJSrMzrsJlIb9zNlchtfhpqXcv/tG5h5TEHU917uU7DMrSzuU7Zv8G29npipvmz5HT9gwVnb0xMCmYCAu0Tk8WAC5I7MdrtygD1O++keMWZzGqu6zKDX6qa0+MwJbCjypqX0dDExYNkB1FDPEQhGXilZElppctEG8MCaAsNHli7dakqjJseiPrNAeN2/+H5x9CN+S3OvdAEmXWrZIqBdXhhuUMkB05FTcxnYTSFCuzQKIvg6wTH+/Jv7pGKaAKzOXLiLJ41uoPzo+VFAFpErTDIFXnLSC3oFmMFChpJjtKEvvfhgtMouBBLLuGUs754woBFT+XzW4+n+35vXNjG37/3BjaT//HlXv4eNIkgQDJJaXbZ5RZJR2xU86ABcypulEQlqnuoxslI5h1KiKCzPwra+5KkpDJ0yu/EKHEnQTveUtdHV7CuAFgqgKsEuIhUDAFOPaUQoA4X+q9aywsQHpm5W4OoGkCBBID4OjtitybJp6HivsuSgooJDuUEA9BW6a67+uYfGbPy1+vIKb5eMWe6h2cYkc0SCBNXLl7hKFhisKzoJZum/VWResSFa7TOPJ3oy5eoGAKioxYVfp6ERmzcUsw9dLqwRHTZS/+yq548crdPOceZpaGiQxHWNep0moZhAKyQxnxEAowBTX2xACVcXFW0Zt29OLqbdPs0B5Lffv9u6Ls4Nt/woiGBWESSaUAq0gBbnzBABgxoFVO4wdtmbBJWDDSz9ksLK/BY6ljq7ZNH1u1feSFVduVun/fueqexLMf2DVBa7GRCtCmkrNfNTWtC6OsOcXn6SQxwgOmoNy9D5aeUJlZKCpcr+kXerZPPd+zI/3Dnh1x2ZvwPW2f696Z+G73zjwD0s95eMRiIyUrUiklmYHZ+wqm6lfMx4RYf8ev+4UgOwoqiYe6rBAvLNvwJdUVn+26l8cx0PVEoPKsPv5E5fX1d2x2a+6Tqh05YnVX7AfX7iBVQh1mAStVl3q5FVx+VNnBtNv77tIr2GeMHVFxcKbN+02hjP7VzH1Bje1NScZzsuOBo0RuE4SKrtCCtxsBJM8v6UA2cJ+eCjaQPLX+zghTcAYoypWaVD0tp/xfTfE95abiu1dlpNrwnVel9yH+XgdNlZ/j8nvWzm0CJiIe532vijK9cz59pwzuvPMXfKe1/9N5z66fw6z+Z2f3FUhAIrK2RnXqlcpn8HVJKDBZIYQvWWeK6AX4ywRMFfb3zF8adO2Wg1gwKZST67aMMTCl2xpMLimz7/23zuwr2RY1B6YOW30LZc2JwxmmkSoyDAUlnK3bYIFkXqxlWkROrN3KJ5DmmVVItIllqrCP1Gdm9hdt61k3L5Ty6pqtHExjTKmjIQZTlq/Z+vTs/optMQum0AufNc6UepiDKkRg8nYxvOXi/WXbQhZMbSdTvYNJVt3DTMGjAYGpwj6K7O+jN12wILJgWgby0urBGFPoIVb3CXZEDICJJ7bMsXOKwN0DregGE+ZiKzX50Qe3x5nS97l8JkmVz2ZQASbOJlKH3esIO9/BbCtjxYKpbYTShQb++Z4dcQaGGENJpMr3fqqBydvcqwFMfGC1JMBUZt/PVvnUKEpKHzv3oAVPm4Hp/wUYAEb2qJoDg7CRAAAAAElFTkSuQmCC";function Re(o,e,t){return e<String(o).length?o.toString():Array(e-String(o).length+1).join("0")+o}function rn(o){const e=[0,4129,8258,12387,16516,20645,24774,28903,33032,37161,41290,45419,49548,53677,57806,61935,4657,528,12915,8786,21173,17044,29431,25302,37689,33560,45947,41818,54205,50076,62463,58334,9314,13379,1056,5121,25830,29895,17572,21637,42346,46411,34088,38153,58862,62927,50604,54669,13907,9842,5649,1584,30423,26358,22165,18100,46939,42874,38681,34616,63455,59390,55197,51132,18628,22757,26758,30887,2112,6241,10242,14371,51660,55789,59790,63919,35144,39273,43274,47403,23285,19156,31415,27286,6769,2640,14899,10770,56317,52188,64447,60318,39801,35672,47931,43802,27814,31879,19684,23749,11298,15363,3168,7233,60846,64911,52716,56781,44330,48395,36200,40265,32407,28342,24277,20212,15891,11826,7761,3696,65439,61374,57309,53244,48923,44858,40793,36728,37256,33193,45514,41451,53516,49453,61774,57711,4224,161,12482,8419,20484,16421,28742,24679,33721,37784,41979,46042,49981,54044,58239,62302,689,4752,8947,13010,16949,21012,25207,29270,46570,42443,38312,34185,62830,58703,54572,50445,13538,9411,5280,1153,29798,25671,21540,17413,42971,47098,34713,38840,59231,63358,50973,55100,9939,14066,1681,5808,26199,30326,17941,22068,55628,51565,63758,59695,39368,35305,47498,43435,22596,18533,30726,26663,6336,2273,14466,10403,52093,56156,60223,64286,35833,39896,43963,48026,19061,23124,27191,31254,2801,6864,10931,14994,64814,60687,56684,52557,48554,44427,40424,36297,31782,27655,23652,19525,15522,11395,7392,3265,61215,65342,53085,57212,44955,49082,36825,40952,28183,32310,20053,24180,11923,16050,3793,7920];let t=65535,s,n;for(n=0;n<o.length;n++){const a=o.charCodeAt(n);if(a>255)throw new RangeError;s=(a^t>>8)&255,t=e[s]^t<<8}return Re(((t^0)&65535).toString(16).toUpperCase(),4)}function an(o){let t=[{id:"00",value:"01"},{id:"01",value:"11"},{id:"26",value:[{id:"00",value:"SG.PAYNOW"},{id:"01",value:"0"},{id:"02",value:o.uen},{id:"03",value:o.editable.toString()},{id:"04",value:o.expiry}]},{id:"52",value:"0000"},{id:"53",value:"702"},{id:"54",value:o.amount.toString()},{id:"58",value:"SG"},{id:"59",value:o.name},{id:"60",value:"Singapore"},{id:"62",value:[{id:"01",value:"Blank is fine..."}]}].reduce((s,n)=>(Array.isArray(n.value)&&(n.value=n.value.reduce((a,i)=>(a+=i.id+Re(i.value.length.toString(),2)+i.value,a),"")),s+=n.id+Re(n.value.length.toString(),2)+n.value,s),"");return t+="6304"+rn(t+"6304"),t}const on=()=>{const[o,e]=y.useState(localStorage.getItem("countryCode")||"+65"),[t,s]=y.useState(localStorage.getItem("phoneNumber")||""),[n,a]=y.useState(localStorage.getItem("payNowName")||"");y.useEffect(()=>{localStorage.setItem("countryCode",o)},[o]),y.useEffect(()=>{localStorage.setItem("phoneNumber",t)},[t]),y.useEffect(()=>{localStorage.setItem("payNowName",n)},[n]);const i=C=>{e(C.target.value)},c=C=>{s(C.target.value)},l=C=>{a(C.target.value)},d={uen:`${o}${t}`,name:n||"Payee",editable:1,expiry:"20990106",amount:0},b=an(d),[g,p]=y.useState(!1);return y.useEffect(()=>{const C=()=>{window.innerHeight<document.documentElement.clientHeight?p(!0):p(!1)};return window.addEventListener("resize",C),()=>{window.removeEventListener("resize",C)}},[]),r.jsxs(ms,{maxWidth:"xs",sx:{height:g?"calc(100vh - 50px)":"100vh",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",paddingBottom:g?"50px":"0"},children:[r.jsxs(f,{sx:{width:"100%",mb:4},children:[r.jsxs(G,{select:!0,label:"å›½å®¶ä»£ç ",value:o,onChange:i,variant:"outlined",sx:{width:"30%",mr:1},children:[r.jsx(re,{value:"+65",children:"+65 æ–°åŠ å¡"}),r.jsx(re,{value:"+86",children:"+86 ä¸­å›½"})]}),r.jsx(G,{label:"æ‰‹æœºå·",variant:"outlined",value:t,onChange:c,sx:{width:"65%"}})]}),r.jsx(f,{sx:{width:"100%",mb:4},children:r.jsx(G,{label:"PayNow åå­—",variant:"outlined",fullWidth:!0,value:n,onChange:l})}),r.jsx(f,{sx:{width:"100%",display:"flex",justifyContent:"center",alignItems:"center",flexDirection:"column"},children:r.jsxs(f,{sx:{width:"80%",display:"flex",justifyContent:"center",alignItems:"center",flexDirection:"column",boxShadow:"0px 4px 12px rgba(0, 0, 0, 0.1)",padding:"16px",borderRadius:"8px",backgroundColor:"#fff"},children:[r.jsxs(f,{sx:{height:"8svh"},children:[r.jsx(f,{sx:{height:"4.4svh"},children:r.jsx("p",{style:{textAlign:"center",fontSize:"25px",margin:"0"},children:r.jsx("b",{children:n})})}),r.jsx(f,{sx:{height:"3svh"},children:r.jsx("p",{style:{textAlign:"center",color:"#645f60",fontSize:"20px",margin:"0"},children:o+" "+t})})]}),r.jsx(De,{style:{marginBottom:"10px"},value:b,size:250,fgColor:"#771976",logoImage:nn,logoHeight:60,logoWidth:90,quietZone:10,logoOpacity:1,removeQrCodeBehindLogo:!0,eyeRadius:[{outer:0,inner:0},{outer:0,inner:0},{outer:0,inner:0}]}),r.jsx(L,{variant:"contained",color:"secondary",sx:{backgroundColor:"#771976"},children:"SCAN TO PAY"})]})})]})};function cn(){return r.jsx(Ps,{children:r.jsxs(Is,{children:[r.jsx(Ze,{path:"/",element:r.jsx(sn,{})}),r.jsx(Ze,{path:"/paynow",element:r.jsx(on,{})})]})})}It.createRoot(document.getElementById("root")).render(r.jsx(cn,{}));
