import{r as p,j as n,a as L}from"./react-B4V_vTrs.js";import{R as He,c as Qe}from"./react-dom-CqEOeDN_.js";import{B as h,T as Ye,D as ee,a as A,F as Ze,I as qe,S as Ge,M as q,b as W,c as z,u as de,d as $,e as Xe,f as $e,g as _e,h as Ce,i as ve,j as ae,k as ie,C as oe,l as je,m as et,L as pe,n as Ie,o as fe,p as tt,q as nt,r as st,P as rt,s as at,t as it,v as ot,w as lt,x as ct,y as K,z as dt,A as ut,G as ht,E as G,H as gt,J as pt,K as ft,N as mt,O as xt,Q as yt,R as bt,U as wt,V as me,W as xe,X as St,Y as Ct,Z as vt}from"./@mui-CkTl4LCC.js";import{m as jt}from"./mitt-DJ65BbbF.js";import{v as It}from"./uuid-ChpN7rDH.js";import{i as ye,o as be}from"./react-device-detect-Bibxsb49.js";import{A as kt}from"./ably-CH9VZXa5.js";import{a as Tt,r as At,b as se}from"./mobx-DqfxVlHi.js";import{J as ue}from"./jszip-GG0MNtfG.js";import{k as Dt}from"./bigonion-kit-CY3QLVqN.js";import{Q as ke}from"./react-qrcode-logo-BeSdvrP5.js";import{o as Te}from"./mobx-react-lite-B14XViqH.js";import{C as Ut,r as Et}from"./@capacitor-CsmO9VlH.js";import{H as Ft}from"./react-router-dom-BTLnAETc.js";import{a as Pt,b as we}from"./react-router-eewwE4pT.js";import"./@babel-LAXhhp6N.js";import"./scheduler-CzFDRTuY.js";import"./clsx-B-dksMZM.js";import"./@emotion-ECN7D5cP.js";import"./hoist-non-react-statics-DQogQWOa.js";import"./stylis-YPZU7XtI.js";import"./react-is-DUDD-a5e.js";import"./react-transition-group-1FEYgZ6o.js";import"./@popperjs-DXqTHVUr.js";import"./ua-parser-js-4RjAY7Bl.js";import"./lodash.isequal-CFHbgcyd.js";import"./qrcode-generator-B7rwAJ2l.js";import"./use-sync-external-store-Dtqq8cPN.js";import"./@remix-run-DspApiwr.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function t(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(r){if(r.ep)return;r.ep=!0;const a=t(r);fetch(r.href,a)}})();const Ae=jt(),zt=()=>{const[i,e]=p.useState([]),t=p.useRef(null),s=p.useRef(null);return p.useEffect(()=>{Ae.on("show",r=>{const a=Date.now(),l=s.current;if(l&&l.message===r.message&&a-l.timestamp<200)return;s.current={message:r.message,timestamp:a};const c=It(),d={id:c,message:r.message,duration:r.duration||2500,zIndex:r.zIndex||9999};e(g=>[...g,d]),setTimeout(()=>{e(g=>g.map(u=>u.id===c?{...u,isExiting:!0}:u)),setTimeout(()=>{e(g=>g.filter(u=>u.id!==c))},300)},d.duration)})},[]),He.createPortal(n.jsxs("div",{ref:t,style:{position:"fixed",bottom:"10%",left:"50%",transform:"translateX(-50%)",zIndex:Math.max(...i.map(r=>r.zIndex),9999)},children:[n.jsx("div",{style:{position:"relative"},children:i.map((r,a)=>n.jsx("div",{className:`toast ${r.isExiting?"toast-exit":"toast-enter"}`,style:{backgroundColor:"rgba(0, 0, 0, 0.85)",color:"#fff",padding:"10px 20px",borderRadius:"8px",fontSize:"14px",maxWidth:"80vw",textAlign:"center",whiteSpace:"pre-wrap",wordBreak:"break-word",boxShadow:"0 4px 8px rgba(0,0,0,0.3)",position:"relative",marginBottom:"10px",transition:"transform 300ms ease, opacity 300ms ease, margin 300ms ease",opacity:r.isExiting?0:1,transform:r.isExiting?"translateY(10px)":"translateY(0)"},children:r.message},r.id))}),n.jsx("style",{children:`
        .toast-enter {
          animation: fadeInUp 200ms ease-out;
        }

        .toast-exit {
          animation: fadeOutDown 300ms ease-in;
        }

        @keyframes fadeInUp {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        @keyframes fadeOutDown {
          from {
            opacity: 1;
            transform: translateY(0);
          }
          to {
            opacity: 0;
            transform: translateY(10px);
          }
        }
      `})]}),document.body)},C=(i,e,t)=>{Ae.emit("show",{message:i,severity:t?.kind??"success",duration:e??2500,zIndex:t?.zIndex??9999})};class Nt{rtc;rtcServers=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.counterpath.net"},{urls:"stun:stun.internetcalls.com"},{urls:"stun:stun.voip.aebc.com"},{urls:"stun:stun.voipbuster.com"},{urls:"stun:stun.xten.com"},{urls:"stun:global.stun.twilio.com:3478"}];constructor(e){this.rtc=e}createPeerConnection(e){const t=new RTCPeerConnection({iceServers:this.rtcServers,iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});this.rtc.negotiationMap.set(e,{isNegotiating:!1,queue:[]}),t.onnegotiationneeded=async()=>{};let s=[],r=!1;return t.onicecandidate=a=>{if(a.candidate){s.push(a.candidate);const d=a.candidate.candidate.split(" "),g=d[4];d[7]==="host"&&this.isPrivateIP(g),r||(r=!0,setTimeout(()=>{this.rtc.broadcastSignal({type:"candidate",candidates:s,to:e}),s=[],r=!1},400))}},t.ondatachannel=a=>{this.rtc.setupDataChannel(a.channel,e)},t.oniceconnectionstatechange=()=>{if(console.log(`[CONNECT] ${e} ICE 状态:`,t.iceConnectionState),t.iceConnectionState==="connected"){console.log(`[CONNECT] ✅ ${e} 连接成功，取消超时`);const a=this.rtc.userList.get(e);a&&this.rtc.userList.set(e,{...a,status:"connected"}),clearTimeout(this.rtc.connectionTimeouts.get(e))}(t.iceConnectionState==="failed"||t.iceConnectionState==="disconnected")&&(console.warn(`[CONNECT] ❌ ${e} ICE 连接失败，立即关闭`),t.close(),b.peers.delete(e),this.rtc.updateConnectedUsers(this.rtc.userList))},e&&b.peers.set(e,t),t}removePeer(e){const t=b.peers.get(e);t&&(t.close(),b.peers.delete(e)),this.rtc.dataChannels.delete(e),this.rtc.negotiationMap.delete(e),this.rtc.lastConnectAttempt.delete(e),this.rtc.userList.delete(e),console.log(`🧹 已清除与 ${e} 的连接资源`)}isPrivateIP(e){return e.startsWith("10.")||e.startsWith("192.168.")||e.match(/^172\.(1[6-9]|2\d|3[0-1])\./)}}const J=()=>ye&&be==="iOS"?"apple":ye&&be==="Android"?"android":"desktop";function De(i,e){const[t,s]=i.split(":"),[r,a]=e.split(":");if(!s||!a)return!1;const l=s.localeCompare(a);if(l>0)return!0;if(l<0)return!1;const c=t.localeCompare(r);return c>0?!0:c<0?!1:i>e}function _(i){return i?i.length<2?{isValid:!1,message:"房间名太短啦，至少两个字符"}:i.length>12?{isValid:!1,message:"房间名最多 12 个字符"}:/^[\u4e00-\u9fa5a-zA-Z0-9 _-]+$/.test(i)?{isValid:!0,message:"房间名合法"}:{isValid:!1,message:"只能使用中文、字母、数字、空格、下划线或中划线"}:{isValid:!1,message:"房间名不能为空"}}const Z="user_settings",V={roomId:"",userTheme:"light",userLanguage:"system",backupBackWsUrl:"wss://md-server-md-server-bndnqhexdf.cn-hangzhou.fcapp.run",ablyKey:"4TtssQ.e9OvDA:wYBGdtWQNgicbeIKNtgeV_s5XEKmfLKD_Gue5XQrWuw",version:"3.3.0",isNewUser:!0},re={settingsPageState:!1};class Mt{settings={...V};unrmb={...re};constructor(){Tt(this),this.loadFromLocalStorage(),At(()=>this.settings,e=>{localStorage.setItem(Z,JSON.stringify(e))})}update(e,t){if(!(e in V))throw new Error(`❌ update() 不允许的设置项: ${e}`);const s=this.settings[e];typeof t=="object"&&t!==null&&typeof s=="object"&&!Array.isArray(s)?this.settings[e]={...s,...t}:this.settings[e]=t,localStorage.setItem(Z,JSON.stringify(this.settings))}get(e){if(!(e in V))throw new Error(`❌ get() 不允许的设置项: ${e}`);return this.settings[e]}getUnrmb(e){if(!(e in re))throw new Error(`❌ getUnrmb() 不允许的字段: ${e}`);return this.unrmb[e]}updateUnrmb(e,t){if(!(e in re))throw new Error(`❌ updateUnrmb() 不允许的字段: ${e}`);this.unrmb[e]=t}getAllSettings(){return{...this.settings}}reset(){se(()=>{this.settings={...V}}),localStorage.setItem(Z,JSON.stringify(this.settings))}loadFromLocalStorage(){const e=localStorage.getItem(Z);try{const t=e?JSON.parse(e):null;if(t&&typeof t=="object"&&Object.keys(V).every(r=>r in t))se(()=>{this.settings={...V,...t}});else throw new Error("无效配置或字段缺失，已重置为默认值")}catch(t){console.warn("⚠️ 加载配置失败，使用默认设置:",t),se(()=>{this.settings={...V}}),localStorage.setItem(Z,JSON.stringify(this.settings))}}}const j=new Mt;class b{static instance=null;static userId=null;static uniqId=null;static peers=new Map;constructor(){const e=this.getStatesMemorable();let t=e.memorable.userId,s=e.memorable.uniqId;this.peerManager=new Nt(this),t||(t=this.generateUUID(),this.changeStatesMemorable({memorable:{userId:t}})),s||(s=`${t}:${this.generateUUID()}`,this.changeStatesMemorable({memorable:{uniqId:s}})),b.userId=t,b.uniqId=s}ably=null;ablyChannel=null;ws=null;userList=new Map;dataChannels=new Map;receivingFiles=new Map;receivedFiles=new Map;lastPingTimes=new Map;lastPongTimes=new Map;heartbeatIntervals=new Map;timeoutHandles=new Set;connectionQueue=new Map;pendingOffers=new Set;negotiationMap=new Map;pingFailures=new Map;pongFailures=new Map;recentlyResetPeers=new Map;lastConnectAttempt=new Map;connectionTimeouts=new Map;currentRoomId=null;isSendingFile=!1;fileMetaInfo={name:"default_received_file"};coolingTime=2e3;cleaningLock=!1;setFileTransferProgress=()=>{};setDownloadPageState=()=>{};setMsgFromSharing=()=>{};updateConnectedUsers=()=>{};setFileSendingTargetUser=()=>{};peerManager;transferConfig={chunkSize:32*1024,maxConcurrentReads:10,bufferThreshold:256*1024};aborted=!1;initTransferConfig(){const e=J();e==="apple"||e==="android"?this.transferConfig={chunkSize:4*32*1024,maxConcurrentReads:8,bufferThreshold:128*1024}:this.transferConfig={chunkSize:32*1024,maxConcurrentReads:8,bufferThreshold:256*1024}}async init(e,t,s,r=()=>{},a){this.setFileSendingTargetUser=e,this.setMsgFromSharing=t,this.setDownloadPageState=s,this.updateConnectedUsers=r,this.setFileTransferProgress=a,this.initTransferConfig(),setInterval(async()=>{for(const[l,c]of this.userList.entries())if(c.status==="waiting"){if(c.attempts>=3){console.warn(`[USER CHECK] ${l} 重试次数过多，标记为 disconnected`),c.status="disconnected",this.userList.set(l,c),this.updateUI();continue}try{await this.connectToUser(l),c.status="connecting",c.attempts+=1,this.userList.set(l,c)}catch(d){console.error(`[USER CHECK] 连接 ${l} 失败:`,d)}}},5e3)}async connectToServer(){const e=j.get("roomId");if(!_(e).isValid)return j.updateUnrmb("settingsPageState",!0),!1;if(this.ably?.connection?.state==="connected")return!1;try{return this.ably=new kt.Realtime({key:j.get("ablyKey")}),await new Promise((t,s)=>{this.ably.connection.once("connected",t),this.ably.connection.once("failed",s)}),this.subscribeToRoom(e),!0}catch{return C("Ably 连接失败，切换为备用 WebSocket 模式",2e3,{kind:"error"}),await this.connectToBackupWs(),!1}}subscribeToRoom(e){if(!_(e).isValid)return j.updateUnrmb("settingsPageState",!0),!1;if(!this.ably)return;this.ablyChannel&&(this.ablyChannel.unsubscribe(),console.log(`[A]离开旧房间: ${this.currentRoomId}`)),this.ablyChannel=this.ably.channels.get(e),this.currentRoomId=e;const t=this.getUniqId();this.ablyChannel.subscribe(`signal:${t}`,s=>{this.handleSignal({data:JSON.stringify(s.data)})}),this.ablyChannel.subscribe("signal:all",s=>{this.handleSignal({data:JSON.stringify(s.data)})})}async handleRename(){const e=j.get("roomId"),t=_(e);if(!t.isValid){C(t.message||"房间名不合法",2e3,{kind:"error"});return}if((!this.ably||this.ably.connection.state!=="connected")&&(console.log("未连接 Ably 尝试连接..."),await this.connectToServer()),!this.ably||this.ably.connection.state!=="connected"){C("无法连接服务器，你丫在地球吗",2e3,{kind:"error"});return}this.subscribeToRoom(e),this.broadcastSignal({type:"discover",userType:J()})}async connectToBackupWs(){const e=j.get("backupBackWsUrl");try{this.ws=new WebSocket(e),this.ws.onopen=async()=>{console.log("✅ 已连接备用 WebSocket"),await this.waitForUnlock(this.cleaningLock),setTimeout(()=>{this.broadcastSignal({type:"discover",userType:J()})},2500)},this.ws.onmessage=t=>this.handleSignal(t),this.ws.onclose=()=>{this.cleanUpConnections()},this.ws.onerror=t=>console.error("WebSocket error:",t),window.addEventListener("beforeunload",()=>{}),window.addEventListener("pagehide",()=>{})}catch(t){console.error("❌ 备用 WebSocket 连接失败:",t)}}broadcastSignal(e){const t={...e,from:this.getUniqId()};this.ablyChannel?e.to?this.ablyChannel.publish(`signal:${e.to}`,t):this.ablyChannel.publish("signal:all",t):this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify(t))}getStatesMemorable(){const e=localStorage.getItem("memorableState");if(!e)return{memorable:{userId:null,uniqId:null}};try{const t=JSON.parse(e);return{memorable:{userId:t.memorable?.userId??null,uniqId:t.memorable?.uniqId??null}}}catch{return console.warn("🧹 解析 localStorage 失败，清理状态"),localStorage.removeItem("memorableState"),{memorable:{userId:null,uniqId:null}}}}changeStatesMemorable(e){const t=this.getStatesMemorable().memorable,s={userId:e.memorable.userId??t.userId,uniqId:e.memorable.uniqId??t.uniqId};localStorage.setItem("memorableState",JSON.stringify({memorable:s}))}getUniqId(){return b.uniqId}getUserId(){return b.userId}setUserId(e){if(b.userId!=e){b.userId=e,this.changeStatesMemorable({memorable:{userId:e}});const t=`${e}:${this.generateUUID()}`;b.uniqId=t,this.changeStatesMemorable({memorable:{uniqId:t}})}}setUniqId(e){b.uniqId=e,this.changeStatesMemorable({memorable:{uniqId:e}})}static getInstance(){return b.instance||(b.instance=new b),b.instance}async disconnect(){this.ablyChannel?.unsubscribe(),this.ably?.close(),this.ably=null,this.ablyChannel=null}cleanUpConnections(){console.warn("🔌 Ably disconnected, cleaning up."),this.ablyChannel?.unsubscribe(),this.ably=null,this.ablyChannel=null}async connect(e){try{this.ws=new WebSocket(e),this.ws.onopen=async()=>{await this.waitForUnlock(this.cleaningLock),setTimeout(()=>{this.broadcastSignal({type:"discover",userType:J()})},2500)},this.ws.onmessage=t=>this.handleSignal(t),this.ws.onclose=()=>this.cleanUpConnections(),this.ws.onerror=t=>console.error("WebSocket error:",t),window.addEventListener("beforeunload",()=>{}),window.addEventListener("pagehide",()=>{})}catch(t){console.log(t)}}async handleSignal(e){try{const t=JSON.parse(e.data);if(!t)return;switch(t.type){case"discover":await this.handleDiscover(t);break;case"offer":await this.handleOffer(t);break;case"answer":await this.handleAnswer(t);break;case"candidate":await this.handleCandidate(t);break;default:console.warn("Unknown message type",t.type)}}catch(t){console.error("🚨 Failed to parse WebSocket message:",e.data,t)}}async handleDiscover(e){const t=e.from,s=e.isReply;if(!t||t===this.getUniqId())return;const r=Date.now(),a=this.userList.get(t);if(!a)this.userList.set(t,{status:"waiting",attempts:0,lastSeen:r,userType:e.userType});else if(a.lastSeen=r,a.status==="disconnected"&&(a.attempts=0,a.status="waiting"),a.status==="waiting"||a.status==="connecting"||a.status==="connected")return;if(s||this.broadcastSignal({type:"discover",to:t,isReply:!0,userType:J()}),De(this.getUniqId(),t)){const l=this.userList.get(t);if(l.status==="waiting")try{await this.connectToUser(t),l.attempts=0}catch{console.warn("发送错误"),l.attempts++,l.attempts>=10&&(l.status="disconnected")}else if(l.status==="connecting")return}this.updateUI()}clearCache(e){console.warn(`🧹 清理连接相关状态：${e}`);const t=b.peers.get(e);t&&(t.close(),b.peers.delete(e));const s=this.dataChannels.get(e);s&&(s.close(),this.dataChannels.delete(e)),this.negotiationMap.delete(e),this.pendingOffers.delete(e),this.connectionQueue.delete(e);const r=this.heartbeatIntervals.get(e);r&&(clearInterval(r),this.heartbeatIntervals.delete(e));const a=this.connectionTimeouts.get(e);a&&(clearTimeout(a),this.connectionTimeouts.delete(e)),this.lastPingTimes.delete(e),this.lastPongTimes.delete(e),this.pingFailures.delete(e),this.pongFailures.delete(e),this.recentlyResetPeers.delete(e)}async handleOffer(e){const t=e.from;b.peers.has(t)||this.peerManager.createPeerConnection(t),this.negotiationMap.get(t).queue.push({type:"offer",sdp:e.offer}),this.processNegotiationQueue(t)}async processNegotiationQueue(e){if(!b.peers.get(e))return;const s=this.negotiationMap.get(e);if(s&&!s.isNegotiating){s.isNegotiating=!0;try{for(;s.queue.length>0;){const r=s.queue.shift();r.type==="offer"?await this.doHandleOffer(e,r.sdp):r.type==="answer"&&await this.doHandleAnswer(e,r.sdp)}}finally{s.isNegotiating=!1}}}async doHandleOffer(e,t){const s=b.peers.get(e);if(!s)return;const r=this.getUniqId()>e;if(s.signalingState==="have-local-offer"||s.signalingState==="have-local-pranswer")if(r){const c=Date.now(),d=this.recentlyResetPeers.get(e)??0;if(c-d<5e3){console.warn(`[OFFER] 最近刚 reset 过 ${e}，跳过`);return}console.warn(`[OFFER] Polite peer, resetting connection with ${e}`),this.recentlyResetPeers.set(e,c),s.close(),b.peers.delete(e);const g=this.peerManager.createPeerConnection(e);b.peers.set(e,g);const u=this.negotiationMap.get(e);u&&(u.queue.unshift({type:"offer",sdp:t}),this.processNegotiationQueue(e));return}else{console.warn("[OFFER] Impolite peer, ignoring incoming offer");return}await s.setRemoteDescription(new RTCSessionDescription(t));const l=await s.createAnswer();await s.setLocalDescription(l),this.broadcastSignal({type:"answer",answer:s.localDescription,to:e})}async handleAnswer(e){const t=e.from;if(!b.peers.has(t))return;const s=this.negotiationMap.get(t);s&&(s.queue.push({type:"answer",sdp:e.answer}),this.processNegotiationQueue(t))}async doHandleAnswer(e,t){const s=b.peers.get(e);if(s){if(s.signalingState!=="have-local-offer"){console.warn(`Ignore answer from ${e}, because local signalingState=${s.signalingState}`);return}await s.setRemoteDescription(new RTCSessionDescription(t))}}async handleCandidate(e){const t=b.peers.get(e.from);if(!t||!t.remoteDescription){console.warn("[ICE] ❌ 跳过 ICE，因 remoteDescription 尚未设置");return}if(t&&e.candidates)for(const s of e.candidates)try{await t.addIceCandidate(new RTCIceCandidate(s))}catch(r){console.error("Error adding ICE candidate:",r)}}getAllUsers(){return Array.from(this.userList.keys())}setupDataChannel(e,t){e.binaryType="arraybuffer",this.dataChannels.set(t,e),e.onopen=()=>{j.update("isNewUser",!1);const s=this.connectionTimeouts.get(t);s&&(clearTimeout(s),this.connectionTimeouts.delete(t));let r=this.userList.get(t);r||(console.warn("⚠️ user 不存在，在通道打开时自动添加:",t),r={status:"connected",attempts:0,lastSeen:Date.now(),userType:"desktop"},this.userList.set(t,r)),C("新用户已连接: "+t.split(":")[0],2e3,{kind:"success"}),this.updateUI(),this.heartbeatIntervals.has(t)&&(clearInterval(this.heartbeatIntervals.get(t)),this.heartbeatIntervals.delete(t));const a=setInterval(()=>{e.readyState==="open"&&e.send(JSON.stringify({type:"ping"}))},3e3);this.heartbeatIntervals.set(t,a)},this.receivingFiles||(this.receivingFiles=new Map),e.onmessage=async s=>{if(typeof s.data=="string"){const r=JSON.parse(s.data);switch(r.type){case"file-meta":this.receivingFiles.set(t,{name:r.name,size:r.size,totalChunks:Math.ceil(r.size/r.chunkSize),chunks:new Array(Math.ceil(r.size/r.chunkSize)),chunkSize:r.chunkSize,receivedSize:0,receivedChunkCount:0}),v.fileMetaInfo.name=r.name,this.setDownloadPageState(!0);break;case"abort":v.abortFileTransferToUser?.(),this.setFileTransferProgress(null),this.setDownloadPageState(!1),C("对方取消了传输！",2e3,{kind:"error"});break;case"ping":this.lastPingTimes.set(t,Date.now()),this.pongFailures.set(t,0),e.readyState==="open"&&e.send(JSON.stringify({type:"pong"}));break;case"pong":this.lastPongTimes.set(t,Date.now());const a=this.userList.get(t);a&&(a.status="connected",this.userList.set(t,a)),this.pingFailures.set(t,0),this.updateUI();break;case"text":default:this.setMsgFromSharing(r.msg);break}}else{const r=s.data,a=8;if(r.byteLength<a){console.error("接收到的二进制数据太小");return}const l=new DataView(r),c=l.getUint32(0),d=l.getUint32(4),g=r.slice(a);if(g.byteLength!==d){console.error(`切片 ${c} 长度不匹配：应为 ${d}，实际为 ${g.byteLength}`);return}const u=this.receivingFiles.get(t);if(!u){console.error("尚未收到文件元数据，无法处理切片");return}if(u.chunks[c]||(u.chunks[c]=g,u.receivedSize+=g.byteLength,u.receivedChunkCount++),u.receivedChunkCount===u.totalChunks){const x=[];for(let w=0;w<u.totalChunks;w++){if(!u.chunks[w]){C(`文件传输缺少切片 ${w}，请重新传输！`,1e3,{kind:"error"}),console.error(`缺少切片 ${w}`),this.receivingFiles.delete(t);return}x.push(u.chunks[w])}const F=new Blob(x),I=new File([F],u.name,{type:"application/octet-stream"});this.receivedFiles.set(t+"::"+I.name,I);const m=Array.from(this.receivedFiles.entries()).filter(([w,k])=>k.name.startsWith("LetShare_")&&k.name.endsWith(".zip"));m&&C("解压中，请耐心等待...",2e3,{kind:"info"});for(const[w,k]of m)try{const P=await ue.loadAsync(k),[U]=w.split("::");for(const[E,R]of Object.entries(P.files))if(!R.dir){const y=await R.async("blob"),f=new File([y],E),D=`${U}::${E}`;this.receivedFiles.set(D,f)}this.receivedFiles.delete(w)}catch(P){console.error("解压失败:",P)}C("成功接受来自"+t.split(":")[0]+"的文件！"),this.receivingFiles.delete(t)}}},e.onclose=()=>{console.warn(`🧹 DataChannel closed for ${t}，执行 clearCache(${t})`),this.clearCache(t),this.userList.delete(t),this.updateUI(),C("与对方断开连接，请等待或刷新页面",2e3,{kind:"error"})},e.onerror=()=>{this.cleanupDataChannel(t)}}cleanupDataChannel(e){const t=this.dataChannels.get(e);t&&(t.close(),this.heartbeatIntervals.has(e)&&(clearInterval(this.heartbeatIntervals.get(e)),this.heartbeatIntervals.delete(e)),this.dataChannels.delete(e),this.userList.delete(e),this.lastPongTimes.delete(e),this.updateUI())}async connectToUser(e){const t=Date.now(),s=this.lastConnectAttempt.get(e)??0;if(t-s<4e3){console.warn(`[CONNECT] 与 ${e} 的连接尝试太频繁，跳过`);return}if(this.lastConnectAttempt.set(e,t),this.connectionQueue.has(e)){console.warn(`[CONNECT] ${e} 正在连接中，跳过`);return}this.connectionQueue.set(e,!0);try{let r=b.peers.get(e);if(r){const d=r.connectionState,g=this.dataChannels.get(e),u=["connected","connecting"].includes(d),x=g?.readyState==="open";if(u&&x){console.log(`[CONNECT] ${e} 连接正常 (ICE: ${d}, Channel: open)`);return}console.warn(`[CONNECT] 清理 ${e} 的旧连接`,`ICE 状态: ${d}, 通道状态: ${g?.readyState||"missing"}`),this.clearCache(e)}r=this.peerManager.createPeerConnection(e);const a=r.createDataChannel("chat");this.setupDataChannel(a,e);const l=await r.createOffer({iceRestart:!0});await r.setLocalDescription(l),console.log(`[CONNECT] ✅ 向 ${e} 发送 offer`),this.broadcastSignal({type:"offer",offer:r.localDescription,to:e});const c=window.setTimeout(()=>{const d=b.peers.get(e);this.userList.get(e)?.status!="connected"&&d&&d.iceConnectionState!=="connected"&&d.iceConnectionState!=="checking"?(console.warn(`[CONNECT] ⏰ ${e} 连接长时间未建立，强制关闭`),this.clearCache(e),this.userList.delete(e),this.updateUI()):console.log(`[CONNECT] ${e} 正在连接中，延长等待 状态`),this.connectionTimeouts.delete(e)},5e3);this.connectionTimeouts.set(e,c)}catch(r){console.error(`[CONNECT] ❌ 连接 ${e} 失败:`,r)}finally{this.connectionQueue.delete(e),this.pendingOffers.delete(e)}}updateUI(){this.updateConnectedUsers(this.userList)}async sendMessageToUser(e,t){const s=this.dataChannels.get(e);if(s?.readyState==="open"){s.send(JSON.stringify({msg:t,type:"text"}));return}console.warn(`Channel not open with user ${e}. Attempting reconnection...`)}abortFileTransferToUser(){if(this.aborted=!0,this.isSendingFile=!1,this.timeoutHandles){for(const e of this.timeoutHandles)clearTimeout(e);this.timeoutHandles.clear()}}isConnectedToUser(e){const t=this.dataChannels.get(e);return!!t&&t.readyState==="open"}async sendFileToUser(e,t){const s=this.dataChannels.get(e);if(this.setFileSendingTargetUser(e),!s||s.readyState!=="open"){console.error(`Data channel with user ${e} is not available.`);return}const r=Math.ceil(t.size/this.transferConfig.chunkSize);let a=this.transferConfig.maxConcurrentReads,l=0,c=0;this.aborted=!1;const d=[],g={type:"file-meta",name:t.name,size:t.size,totalChunks:r,chunkSize:this.transferConfig.chunkSize};try{s.send(JSON.stringify(g)),console.log("📦 已发送文件元数据:",g)}catch(I){console.error("❌ 无法发送文件元数据：",I);return}const u=I=>new Promise((m,w)=>{if(this.aborted)return w(new Error("读取中止"));const k=I*this.transferConfig.chunkSize,P=t.slice(k,k+this.transferConfig.chunkSize),U=new FileReader;U.onload=()=>{if(this.aborted)return w(new Error("读取中止"));U.result instanceof ArrayBuffer?m(U.result):w(new Error("读取结果不是 ArrayBuffer"))},U.onerror=E=>w(E),U.readAsArrayBuffer(P)}),x=async I=>{if(!this.aborted)try{const m=await u(I);if(this.aborted)return;const w=8,k=new ArrayBuffer(w+m.byteLength),P=new DataView(k);P.setUint32(0,I),P.setUint32(4,m.byteLength),new Uint8Array(k,w).set(new Uint8Array(m));const U=()=>{if(!this.aborted)if(s.bufferedAmount<this.transferConfig.bufferThreshold){s.send(k),l++;const E=Math.min(l/r*100,100);this.setFileTransferProgress(E),E>=100&&(setTimeout(()=>this.setFileTransferProgress(null),1500),this.setDownloadPageState(!1)),this.isSendingFile=E<100&&E>0}else{const E=setTimeout(U,100);this.timeoutHandles.add(E)}};U()}catch(m){this.aborted||console.error(`切片 ${I} 发送失败:`,m)}};await(async()=>{for(;c<r&&!this.aborted;){d.length>=a&&await Promise.race(d);const I=c++,m=x(I);d.push(m),m.finally(()=>{const w=d.indexOf(m);w>-1&&d.splice(w,1)})}})(),await Promise.allSettled(d),this.aborted?console.warn("🚫 文件发送被中止"):console.log("✅ 文件发送完成")}generateUUID(){return Math.random().toString(36).substring(2,8)}isConnected(){return this.ws!==null&&this.ws.readyState===WebSocket.OPEN}getConnectedUserIds(){return Array.from(this.userList.entries()).filter(([e,t])=>t.status==="connected").map(([e])=>e)}async waitForUnlock(e){const r=Date.now();for(;e;){if(Date.now()-r>1e4){console.warn("⚠️ 等待 cleaningLock 解锁超时，放弃 discover");return}await new Promise(a=>setTimeout(a,200))}}}const v=b.getInstance();async function Lt(){if(navigator.clipboard&&typeof navigator.clipboard.readText=="function")try{return await navigator.clipboard.readText()||""}catch(i){console.error("Failed to read clipboard contents via clipboard API: ",i),C("读取剪贴板内容失败，请检查权限或手动粘贴。",3e3,{kind:"error"})}return C("当前浏览器不支持读取剪贴板",3e3,{kind:"warning"}),""}async function Rt(i){if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function")try{if(await navigator.clipboard.writeText(i),typeof navigator.clipboard.readText=="function")try{const e=await navigator.clipboard.readText();if(e===i)return!0;console.warn("Clipboard text mismatch. Written vs Read:",i,e)}catch(e){console.warn("Could not verify clipboard content:",e)}else return!0}catch(e){console.error("Failed to write clipboard via Clipboard API:",e)}try{const e=document.createElement("textarea");e.value=i,e.style.position="fixed",e.style.top="-1000px",document.body.appendChild(e),e.focus(),e.select();const t=document.execCommand("copy");if(document.body.removeChild(e),t)return!0;console.warn("execCommand copy returned false.")}catch(e){console.error("Failed to write clipboard via execCommand:",e)}return C("复制失败，请手动复制文本。",3e3,{kind:"warning"}),!1}const Bt=[{key:"light",color:"#f5f5f5",label:"亮色"},{key:"dark",color:"#212121",label:"暗色"},{key:"blue",color:"#1976d2",label:"蓝色"},{key:"green",color:"#388e3c",label:"绿色"},{key:"sunset",color:"#f57c00",label:"日落橙"},{key:"coolGray",color:"#90a4ae",label:"冷灰"}],Ot=()=>{const i=j.get("userTheme")||"light",e=t=>{j.update("userTheme",t)};return n.jsx(h,{sx:{borderRadius:"50%",display:"flex",gap:1.3,justifyContent:"center",alignItems:"center",flexWrap:"wrap"},children:Bt.map(t=>{const s=i===t.key;return n.jsx(Ye,{title:t.label,arrow:!0,children:n.jsx("div",{tabIndex:0,onClick:()=>e(t.key),style:{width:24,height:24,borderRadius:"50%",backgroundColor:t.color,cursor:"pointer",marginLeft:s?8:0,marginRight:s?8:0,transform:s?"scale(1.4)":"scale(1)",boxShadow:s?"0 0 0 3px rgba(0,0,0,0.3)":"0 0 0 1px rgba(0,0,0,0.2)",transition:"transform 0.2s ease, margin 0.2s ease, box-shadow 0.2s ease",outline:"none",WebkitTapHighlightColor:"transparent"},onMouseEnter:r=>{r.currentTarget.style.transform=s?"scale(1.4)":"scale(1.2)"},onMouseLeave:r=>{r.currentTarget.style.transform=s?"scale(1.4)":"scale(1)"}})},t.key)})})},Vt=()=>{const i=j.getAllSettings(),e=L.useRef(null),t=L.useRef(j.get("roomId")),s=(c,d)=>{j.update(c,d)},r=()=>{l()},a=()=>{},l=async()=>{const c=j.get("roomId");t.current!==c&&(await v.handleRename(),C(`成功加入房间："${c}"`),t.current=c);const d=j.get("roomId");let g=_(d);g.isValid?j.updateUnrmb("settingsPageState",!1):C(g.message,2e3,{kind:"error"})};return L.useEffect(()=>{const c=d=>{d.key==="Enter"&&j.getUnrmb("settingsPageState")&&(d.preventDefault(),r())};return window.addEventListener("keydown",c),()=>{window.removeEventListener("keydown",c)}},[]),n.jsx(ee,{onClose:l,open:j.getUnrmb("settingsPageState")??!1,PaperProps:{sx:{borderRadius:3,bgcolor:"background.paper",overflow:"hidden"}},children:n.jsxs(h,{ref:e,sx:{maxWidth:1e3,mx:"auto",px:4.3,py:4,bgcolor:"background.paper",borderRadius:3,boxShadow:3,display:"flex",flexDirection:"column",gap:3},children:[n.jsx(A,{variant:"h6",gutterBottom:!0,children:"设置"}),n.jsx(Ot,{}),n.jsxs(Ze,{disabled:!0,fullWidth:!0,children:[n.jsx(qe,{children:"语言"}),n.jsxs(Ge,{value:i.userLanguage||"system",label:"语言",onChange:()=>a(),children:[n.jsx(q,{value:"system",children:"跟随系统"}),n.jsx(q,{value:"zh",children:"简体中文"}),n.jsx(q,{value:"en",children:"English"})]})]}),n.jsx(W,{required:!0,label:"房间号",fullWidth:!0,autoFocus:j.get("roomId")=="",variant:"outlined",value:i.roomId||"",onChange:c=>s("roomId",c.target.value),error:!i.roomId,inputProps:{maxLength:12},helperText:i.roomId?"只有同一房间号才能互相连接哦":"房间号必填啦"}),n.jsx(z,{onClick:r,variant:"contained",size:"large",sx:{mt:0},children:"保存设置"})]})})},Jt=Te(Vt),Wt=()=>{const[i,e]=p.useState(!1),t=()=>e(!0),s=()=>e(!1),r=de(),a="https://bigonion.cn/shortlink";return n.jsxs(n.Fragment,{children:[n.jsxs(h,{component:"footer",sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:1,borderTop:"1px solid #e0e0e0",borderBottom:"1px solid #e0e0e0",mb:"20px",mt:"auto"},children:[n.jsx(A,{variant:"body2",color:"text.secondary",children:"© 2025 LetShare Copyright Author Onion"}),n.jsxs(h,{sx:{display:"flex",alignItems:"center"},children:[n.jsx($,{"aria-label":"GitHub",component:"a",href:"https://github.com/LiWeny16/LetShare",target:"_blank",rel:"noopener noreferrer",children:n.jsx(Xe,{})}),n.jsx($,{"aria-label":"QR Code",onClick:t,children:n.jsx($e,{})}),n.jsx($,{onClick:()=>{j.updateUnrmb("settingsPageState",!0)},children:n.jsx(_e,{})})]})]}),n.jsx(ee,{open:i,onClose:s,PaperProps:{sx:{borderRadius:2,bgcolor:"background.paper",overflow:"hidden"}},children:n.jsxs(h,{sx:{padding:1,bgcolor:"background.paper",borderRadius:2},children:[n.jsx(Ce,{children:"分享·一触即发"}),n.jsx(ve,{}),n.jsx(ae,{sx:{display:"flex",justifyContent:"center",alignItems:"center",p:1.4,width:"280px",maxWidth:"100%"},children:n.jsxs(h,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"},children:[n.jsxs(A,{variant:"body1",color:"text.secondary",sx:{mb:0,wordBreak:"break-word",whiteSpace:"pre-wrap"},children:["扫描二维码以加入房间: ",n.jsx("br",{}),n.jsx("strong",{children:j.get("roomId")})]}),n.jsx(ke,{value:a,eyeRadius:1,style:{borderRadius:5},size:150,bgColor:r.palette.background.paper,fgColor:r.palette.text.primary,ecLevel:"H",quietZone:10}),n.jsx(A,{variant:"body2",color:"primary",component:"a",href:a,target:"_blank",rel:"noopener noreferrer",sx:{mb:0,wordBreak:"break-word",textDecoration:"none",whiteSpace:"pre-wrap"},children:"https://letshare.fun"})]})})]})}),n.jsx(Jt,{})]})},Kt=({onEditDone:i})=>{const[e,t]=p.useState(!1),[s,r]=p.useState(""),[a,l]=p.useState(!1),c=p.useRef("");p.useEffect(()=>{const x=v.getUserId();x&&(r(x),c.current=x)},[]);const d=/^[\u4e00-\u9fa5a-zA-Z0-9\u{1F000}-\u{1FFFF}]*$/u,g=x=>{const F=x.target.value;r(F),l(!d.test(F))},u=()=>{const x=s.trim();if(!d.test(x)||!x){r(c.current),l(!0),t(!1);return}v.setUserId(x),c.current=x,l(!1),t(!1),i&&i(x)};return n.jsx(n.Fragment,{children:e?n.jsx(W,{value:s,onChange:g,onBlur:u,onKeyDown:x=>{x.key==="Enter"&&u()},autoFocus:!0,variant:"standard",error:a,helperText:a?"只允许12字符以内的字母、数字和汉字":" ",inputProps:{style:{textAlign:"center"},maxLength:12},sx:{mt:2,display:"block",mx:"auto"}}):n.jsxs(A,{variant:"body2",color:"textSecondary",align:"center",sx:{mt:2,cursor:"pointer"},onClick:()=>t(!0),children:["你的ID: ",s]})})},Ht=({open:i})=>{const[e,t]=p.useState(!1);return n.jsx(ie,{in:i,timeout:600,unmountOnExit:!0,children:n.jsx(h,{sx:{width:"100vw",minHeight:"100vh",position:"fixed",top:0,left:0,display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",backgroundColor:s=>s.palette.background.default,color:"white",textAlign:"center",p:2,boxSizing:"border-box",zIndex:9999},children:n.jsxs(h,{sx:{mb:"200px",display:"flex",flexDirection:"column",alignItems:"center"},children:[n.jsx(h,{sx:{width:{xs:120,sm:160,md:200},height:{xs:120,sm:160,md:200},mb:3,display:"flex",justifyContent:"center",alignItems:"center"},children:n.jsx(ie,{in:e,timeout:600,children:n.jsx(h,{component:"img",src:"/icons/512x512.png",alt:"Logo",onLoad:()=>t(!0),sx:{width:"100%",height:"100%",objectFit:"contain"}})})}),n.jsx(A,{variant:"h6",sx:{fontWeight:300,color:s=>s.palette.getContrastText(s.palette.background.default)},children:"Connect To The World"}),n.jsx(A,{variant:"subtitle1",sx:{opacity:.85,color:s=>s.palette.getContrastText(s.palette.background.default)},children:"轻触，开启通往世界的大门"}),n.jsx(h,{mt:4,children:n.jsx(oe,{sx:{opacity:.85,color:s=>s.palette.getContrastText(s.palette.background.default)},color:"inherit"})})]})})})},le=Ut.isNativePlatform(),Qt=Et("BinarySaver");async function Yt(i){const e=await i.arrayBuffer(),t=new Uint8Array(e);await Qt.saveBytes({fileName:i.name,mimeType:i.type,data:Array.from(t)})}function Zt({open:i,progress:e,setProgress:t,onClose:s,targetUserId:r}){const a=de(),[l,c]=L.useState(i),[d,g]=L.useReducer(y=>y+1,0);L.useEffect(()=>{i&&c(!0)},[i]),L.useEffect(()=>{const y=setInterval(()=>{g()},300);return()=>clearInterval(y)},[]);const u=()=>{c(!1),s()},x=v.receivingFiles,F=v.receivedFiles,I=Array.from(x.entries()),m=Array.from(F.entries()),w=async()=>{if(m.length===0)return;const y=new ue;m.forEach(([f,D])=>{y.file(D.name,D)});try{const f=await y.generateAsync({type:"blob"}),D=URL.createObjectURL(f),M=document.createElement("a");M.href=D,M.download=`Received_${Date.now()}.zip`,document.body.appendChild(M),M.click(),document.body.removeChild(M),URL.revokeObjectURL(D)}catch(f){console.error("打包下载失败:",f),C("打包下载失败，请重试！",2e3,{kind:"error"})}},k=y=>{const f=v.dataChannels.get(y);f&&f.send(JSON.stringify({type:"abort"})),s(),C(`终止来自 ${y.split(":")[0]} 的接收`,2e3,{kind:"error"}),x.delete(y),g(),x.size===0&&e===null&&c(!1)},P=()=>{s(),C("终止发送",2e3,{kind:"error"}),v.abortFileTransferToUser?.(),t(0),x.size===0&&c(!1)},U=y=>{const f=y.split(".").pop()?.toLowerCase();return f?["png","jpg","jpeg","gif","bmp","webp","svg"].includes(f)?n.jsx(tt,{fontSize:"medium"}):["mp4","mov","avi","mkv","webm"].includes(f)?n.jsx(nt,{fontSize:"medium"}):["zip","rar","7z","tar","gz","xz","bz2"].includes(f)?n.jsx(st,{fontSize:"medium"}):f==="pdf"?n.jsx(rt,{fontSize:"medium"}):["doc","docx"].includes(f)?n.jsx(at,{fontSize:"medium"}):["xls","xlsx","csv"].includes(f)?n.jsx(it,{fontSize:"medium"}):["ppt","pptx"].includes(f)?n.jsx(ot,{fontSize:"medium"}):["txt","md","rtf"].includes(f)?n.jsx(lt,{fontSize:"medium"}):["js","ts","jsx","tsx","html","css","scss","py","java","c","cpp","cs","json","xml","yml","yaml","sh","bat","go","rs"].includes(f)?n.jsx(ct,{fontSize:"medium"}):n.jsx(fe,{fontSize:"medium"}):n.jsx(fe,{fontSize:"medium"})},E=async y=>{if(le)await Yt(y),C(y.name+"成功保存到路径:/Download");else{const f=new Blob([y]),D=URL.createObjectURL(f),M=document.createElement("a");M.href=D,M.download=y.name,M.click(),URL.revokeObjectURL(D)}},R=e!==null||I.length>0||m.length>0;return!l&&!i?null:n.jsxs(n.Fragment,{children:[n.jsx(je,{open:i,onClick:s,sx:{zIndex:a.zIndex.modal,backgroundColor:"rgba(0, 0, 0, 0.4)"}}),n.jsx(et,{style:{userSelect:"none"},in:i,direction:"down",mountOnEnter:!0,unmountOnExit:!0,onExited:u,children:n.jsx(h,{onClick:y=>{y.target===y.currentTarget&&c(!1)},sx:{position:"fixed",top:0,left:0,width:"100%",display:"flex",justifyContent:"center",zIndex:a.zIndex.modal},children:n.jsxs(h,{className:"uniformed-scroller",sx:{width:{xs:"88%",sm:"80%",md:"60%",lg:"50%"},maxHeight:400,overflowY:"auto",backgroundColor:a.palette.background.paper,boxShadow:3,px:2,py:2,borderBottomLeftRadius:19,borderBottomRightRadius:19,display:"flex",flexDirection:"column",gap:2},children:[R&&n.jsxs(n.Fragment,{children:[e!==null&&n.jsxs(h,{sx:{display:"flex",flexDirection:"column",gap:1},children:[n.jsxs(A,{variant:"body2",color:"text.secondary",children:["📤 正在发送文件给 ",n.jsx("strong",{children:r?.split(":")[0]??"未知用户"})]}),n.jsxs(h,{sx:{display:"flex",alignItems:"center",gap:2},children:[n.jsxs(h,{sx:{flex:1},children:[n.jsxs(A,{variant:"caption",color:"text.secondary",children:[e.toFixed(1),"%"]}),n.jsx(pe,{variant:"determinate",value:e,sx:{height:8,borderRadius:5,mt:.5}})]}),n.jsx(z,{variant:"contained",color:"error",size:"small",onClick:P,sx:{whiteSpace:"nowrap",minWidth:64,...H},children:"取消"})]})]},"sending"),I.map(([y,f])=>{const D=f.size?f.receivedSize/f.size*100:0;return n.jsxs(h,{sx:{display:"flex",flexDirection:"column",gap:1},children:[n.jsxs(A,{variant:"body2",color:"text.secondary",children:["📥 正在接收来自 ",n.jsx("strong",{children:y.split(":")[0]})," 的文件：",f.name]}),n.jsxs(h,{sx:{display:"flex",alignItems:"center",gap:2},children:[n.jsxs(h,{sx:{flex:1},children:[n.jsxs(A,{variant:"caption",color:"text.secondary",children:[D.toFixed(1),"%（",f.receivedSize," / ",f.size," 字节）"]}),n.jsx(pe,{variant:"determinate",value:D,sx:{height:8,borderRadius:5,mt:.5}})]}),n.jsx(z,{variant:"contained",color:"error",size:"small",onClick:()=>k(y),sx:{whiteSpace:"nowrap",minWidth:64,...H},children:"取消"})]})]},y)}),m.length>0&&n.jsxs(h,{children:[n.jsxs(h,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mt:2,mb:1},children:[n.jsx(A,{variant:"subtitle2",children:"📁 已接收的文件"}),n.jsx($,{onClick:w,size:"small",children:n.jsx(Ie,{fontSize:"small"})})]}),n.jsx(h,{sx:{display:"flex",flexDirection:"column",gap:1},children:m.map(([y,f])=>n.jsxs(h,{onClick:()=>E(f),sx:{display:"flex",alignItems:"center",gap:1.5,px:2,py:1.5,borderRadius:2,boxShadow:1,cursor:"pointer",transition:"0.2s","&:hover":{boxShadow:3,backgroundColor:a.palette.action.hover}},children:[U(f.name),n.jsx(A,{variant:"body2",noWrap:!0,children:f.name})]},y))})]})]}),l&&!R&&n.jsx(h,{sx:{textAlign:"center",color:"gray",py:2},children:"没有进行中的任务"})]})})})]})}const qt={position:"relative",padding:"10px",borderRadius:"8px",display:"flex",flexDirection:"column",mt:"10px",mb:"5px",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.1)",overflow:"hidden",cursor:"pointer"},X={"& .MuiBadge-badge":{top:4,right:4}},H={borderRadius:"5px",borderColor:"#e0e0e0"};function Gt(){const i=de(),[e,t]=p.useState(null),[s,r]=p.useState(!1),[a,l]=p.useState([]),[c,d]=p.useState(!1),[g,u]=p.useState("clip"),[x,F]=p.useState(null),[I,m]=p.useState(null),[w,k]=p.useState(!1),[P,U]=p.useState(""),[E,R]=p.useState(null),[y,f]=p.useState(!0),[D,M]=p.useState(!0),[Ue,Q]=p.useState(!1),[he,te]=L.useState(!1),[Ee,Fe]=L.useState(""),Pe=p.useRef(null),ge=p.useRef(null),ze=o=>{switch(o){case"apple":return n.jsx(Ct,{sx:{transition:"color 0.3s ease"}});case"android":return n.jsx(St,{sx:{transition:"color 0.3s ease"}});case"desktop":return n.jsx(xe,{sx:{transition:"color 0.3s ease"}});default:return n.jsx(xe,{sx:{transition:"color 0.3s ease"}})}},Ne=()=>{U(""),k(!0)},Me=o=>{const S=Array.from(o.entries()).map(([T,N])=>{const[B,O]=T.split(":");return{uniqId:O?`${B}:${O}`:T,name:B||T,status:N.status,userType:N.userType}});l(S)},Le=async()=>{d(!0);try{!v.ablyChannel&&!v.isConnected()?await v.connectToServer():v.broadcastSignal({type:"discover",userType:J()}),await Dt.sleep(1e3)}catch(o){console.error("Search error:",o)}finally{d(!1)}},Re=async o=>{u("image"),ne(o,!0)},ne=async(o,S)=>{const T=o.target.files;if(!(!T||T.length===0)){if(u(S?"image":"file"),T.length===1){const N=o.target.files?.[0]||null;N&&F(N);return}try{const N=new ue;Array.from(T).forEach(Y=>{N.file(Y.name,Y)});const B=await N.generateAsync({type:"blob"}),O=new File([B],`LetShare_${Date.now()}.zip`,{type:"application/zip"});F(O)}catch(N){console.error("压缩失败:",N),C("文件压缩失败，请重试！",2e3,{kind:"error"})}}},Be=async(o,S)=>{try{if(!v.isConnectedToUser(S)){C("正在连接目标用户，请等待连接建立",2e3,{kind:"warning"}),v.connectToUser(S);return}if((g==="file"||g==="image")&&x){if(v.isSendingFile){C("有任务正在进行中！",2e3,{kind:"info"}),Q(!0);return}Q(!0),await v.sendFileToUser(S,x)}else if(g==="text"&&I)await v.sendMessageToUser(S,I);else if(g==="clip"){let T=await Lt();T!=""?await v.sendMessageToUser(S,T??"读取剪切板失败"):C("剪切板为空, 或浏览器不支持",2e3,{kind:"info"})}else C("未选择发送内容",2e3,{kind:"info"})}catch(T){console.error("发送失败：",T)}};p.useEffect(()=>(v.connectToServer().then(o=>{o&&v.broadcastSignal({type:"discover",userType:J()})}),v.init(Fe,o=>{t(o),r(!0)},Q,Me,R),setTimeout(()=>{M(!1)},1e3),()=>{v.disconnect()}),[]),p.useEffect(()=>{const o=async S=>{if(w||s)return;const T=S.clipboardData;if(!T)return;const N=T.items;for(const O of N)if(O.kind==="file"){const Y=O.getAsFile();if(Y){F(Y),u("file");return}}const B=T.getData("text/plain");B&&B.trim().length>0&&(m(B),u("text"))};return window.addEventListener("paste",o),f(!1),()=>{window.removeEventListener("paste",o)}},[w,s]);const Oe=()=>{try{e&&(Rt(e),C("成功写入剪贴板",2e3,{kind:"success"}))}catch(o){console.error("处理接受失败",o)}finally{r(!1),setTimeout(()=>{t(null)},500)}},Ve=o=>{o.preventDefault(),o.stopPropagation()},Je=o=>{o.preventDefault(),o.stopPropagation(),te(!0)},We=o=>{o.preventDefault(),o.stopPropagation();const S=ge.current?.getBoundingClientRect();S&&(o.clientX<S.left||o.clientX>S.right||o.clientY<S.top||o.clientY>S.bottom)&&te(!1)},Ke=o=>{o.preventDefault(),o.stopPropagation(),te(!1);const S=o.dataTransfer.files;S.length>0&&ne({target:{files:S}},!1)};return n.jsxs(n.Fragment,{children:[!D&&n.jsxs(h,{ref:ge,onDragEnter:Je,onDragLeave:We,onDragOver:Ve,onDrop:Ke,sx:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:{xs:"89%",sm:"80%",md:"60%"},maxWidth:"900px",height:le?"90svh":"75vh",p:3,m:"auto",boxShadow:8,borderRadius:2,backgroundColor:"background.paper",zIndex:o=>o.zIndex.modal,display:"flex",flexDirection:"column",justifyContent:"space-between"},children:[he&&n.jsx(ie,{in:he,timeout:400,unmountOnExit:!0,children:n.jsx(h,{sx:{position:"absolute",top:0,left:0,width:"100%",height:"100%",zIndex:1e3,backgroundColor:"rgba(0, 0, 0, 0.4)",borderRadius:2,display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"none"},children:n.jsx(A,{variant:"h6",color:"white",children:"松手上传文件"})})}),n.jsx(Wt,{}),n.jsxs(h,{sx:{display:"flex",gap:2,flexWrap:"wrap"},children:[n.jsx(G,{color:"primary",badgeContent:g==="file"?1:0,overlap:"circular",sx:X,children:n.jsx(z,{variant:"outlined",sx:H,startIcon:n.jsx(gt,{}),onClick:()=>{const o=document.getElementById("multi-file-input");o&&(o.value="",o.click())},children:"文件"})}),n.jsx("input",{id:"multi-file-input",type:"file",hidden:!0,multiple:!0,onChange:o=>{ne(o,!1)}}),n.jsx(G,{color:"primary",badgeContent:g==="image"?1:0,overlap:"circular",sx:X,children:n.jsx(z,{variant:"outlined",sx:H,startIcon:n.jsx(pt,{}),onClick:()=>{const o=document.getElementById("image-input");o&&(o.value="",o.click())},children:"图片"})}),n.jsx("input",{id:"image-input",type:"file",hidden:!0,accept:"image/*",multiple:!0,onChange:Re}),n.jsx(G,{color:"primary",badgeContent:g==="text"?1:0,overlap:"circular",sx:X,children:n.jsx(z,{onClick:Ne,variant:"outlined",startIcon:n.jsx(ft,{}),sx:H,children:"文本"})}),n.jsx(G,{color:"primary",badgeContent:g==="clip"?1:0,overlap:"circular",sx:X,children:n.jsx(z,{onClick:()=>u("clip"),variant:"outlined",startIcon:n.jsx(mt,{}),sx:H,children:"剪贴板"})})]}),n.jsx(h,{sx:{display:"flex",justifyContent:"space-between",mt:2},children:n.jsx(z,{ref:Pe,onClick:Le,variant:"contained",endIcon:c?n.jsx(oe,{size:20,color:"inherit"}):n.jsx(xt,{}),disabled:c,children:"搜索同WIFI下用户"})}),n.jsx(ve,{sx:{mb:.5,mt:2}}),n.jsxs(h,{className:"uniformed-scroller",sx:{mt:0,p:0,flexGrow:1,overflowY:"auto"},children:[a.length==0&&j.get("isNewUser")?n.jsx(n.Fragment,{children:n.jsx(h,{sx:{display:"flex",alignItems:"center",justifyContent:"center",textAlign:"left",height:"100%",px:2},children:n.jsxs(h,{children:["  ",n.jsxs(A,{variant:"body2",color:"text.secondary",sx:{whiteSpace:"pre-line"},children:["使用指南🎉：",`
`,"1. 两个设备连接到",n.jsx("strong",{children:"同一个"}),"局域网（部分公共 WiFi 不可用）",`
`,"2. 两个设备房间号",n.jsx("strong",{children:"必须相同"}),"！"]})]})})}):n.jsx(n.Fragment,{}),[...a].sort((o,S)=>o.status==="connected"&&S.status==="connected"?De(o.uniqId,S.uniqId)?-1:1:0).map(o=>n.jsx(yt,{onClick:S=>Be(S,o.uniqId),sx:{...qt,width:"96%",textAlign:"inherit",backgroundColor:o.status==="waiting"?i.palette.action.hover:i.palette.background.paper,opacity:o.status==="waiting"?.7:1,transition:"all 0.3s ease-in-out","&:hover":{boxShadow:o.status==="connected"?2:1,bgcolor:o.status==="waiting"?"rgba(0, 0, 0, 0.12)":"background.default"},padding:1.5,borderRadius:2,display:"block"},children:n.jsxs(h,{sx:{display:"flex",alignItems:"flex-start",textAlign:"left",gap:1,width:"100%",transition:"opacity 0.3s ease",opacity:o.status==="waiting"?.8:1},children:[ze(o.userType),n.jsx(A,{variant:"body1",sx:{width:"100%",textAlign:"left",color:o.status==="connected"?"text.primary":"text.secondary",transition:"color 0.3s ease"},children:o.name})]})},o.uniqId))]}),n.jsx(bt,{color:"primary",onClick:()=>{Q(!0)},sx:{position:"absolute",bottom:65,right:35,zIndex:o=>o.zIndex.modal+1},children:n.jsx(Ie,{})}),n.jsx(Kt,{})]}),n.jsxs(ee,{open:s,onClose:()=>{r(!1),setTimeout(()=>{t(null)},300)},children:[n.jsx(Ce,{children:"✨ 新分享"}),n.jsxs(ae,{sx:{width:{sx:200,sm:200,md:400,lg:400}},children:[n.jsx(wt,{children:"您有来自外部的消息，是否接受？"}),e&&n.jsx(W,{value:e??"",multiline:!0,fullWidth:!0,InputProps:{readOnly:!0},variant:"outlined",sx:{border:"none",maxHeight:300,overflowY:"auto",borderRadius:1,mt:1,fontSize:{xs:"14px",sm:"15px"},"& .MuiInputBase-input":{whiteSpace:"pre-wrap"}}})]}),n.jsxs(me,{children:[n.jsx(z,{onClick:()=>{r(!1),t(null)},color:"secondary",children:"拒绝"}),n.jsx(z,{onClick:Oe,color:"primary",autoFocus:!0,children:"接受"})]})]}),n.jsxs(ee,{open:w,onClose:()=>k(!1),fullWidth:!0,maxWidth:"sm",PaperProps:{sx:{borderRadius:2,px:{xs:1,sm:4},py:2,mx:{xs:1,sm:"auto"}}},children:[n.jsxs(me,{sx:{px:{xs:2,sm:3},pb:{xs:1,sm:2},justifyContent:"flex-end"},children:[n.jsx(A,{variant:"h6",sx:{flexGrow:1},children:"输入文本"}),n.jsx(z,{onClick:()=>k(!1),color:"secondary",children:"取消"}),n.jsx(z,{onClick:()=>{P?(m(P),u("text")):C("空啦",1e3,{kind:"info"}),k(!1)},color:"primary",variant:"contained",children:"确认"})]}),n.jsx(ae,{children:n.jsx(W,{autoFocus:!0,value:P,onChange:o=>U(o.target.value),multiline:!0,rows:6,fullWidth:!0,variant:"outlined",placeholder:"请输入要发送的文本...",sx:{mt:1,fontSize:{xs:"14px",sm:"16px"}}})})]}),n.jsx(Zt,{targetUserId:Ee,onClose:()=>{Q(!1)},open:Ue,progress:E,setProgress:R}),n.jsx(je,{sx:{color:"#fff",zIndex:o=>o.zIndex.drawer+9999},open:y,children:n.jsx(oe,{color:"inherit"})}),n.jsx(Ht,{open:D}),n.jsx(zt,{})]})}const Se={light:K({palette:{mode:"light"}}),dark:K({palette:{mode:"dark"}}),blue:K({palette:{mode:"light",primary:{main:"#1976d2"},secondary:{main:"#90caf9"},background:{default:"#e3f2fd",paper:"#ffffff"}}}),green:K({palette:{mode:"light",primary:{main:"#388e3c"},secondary:{main:"#a5d6a7"},background:{default:"#f1f8e9",paper:"#ffffff"}}}),sunset:K({palette:{mode:"light",primary:{main:"#f57c00"},secondary:{main:"#ffcc80"},background:{default:"#fff3e0",paper:"#ffffff"}}}),coolGray:K({palette:{mode:"dark",primary:{main:"#90a4ae"},secondary:{main:"#cfd8dc"},background:{default:"#263238",paper:"#37474f"}}})},Xt=Te(()=>{const i=j.get("userTheme")||"system",e=window.matchMedia?.("(prefers-color-scheme: dark)").matches,s=Se[i==="system"?e?"dark":"light":i]??Se.light,[r,a]=p.useState(s);return p.useEffect(()=>{a(s);const l=s.palette.background.default,c=document.querySelector('meta[name="theme-color"]');c&&l&&c.setAttribute("content",l)},[j.get("userTheme")]),n.jsxs(dt,{theme:r,children:[n.jsx(ut,{}),n.jsx(ht,{styles:l=>({"::selection":{backgroundColor:l.palette.primary.light,color:l.palette.getContrastText(l.palette.primary.light)}})}),n.jsx(Gt,{})]})}),$t="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANMAAACECAYAAAAKjB6WAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NjdFMjg1MUU1MEJGMTFFN0IxNEZDN0U5MzZCREMyQjMiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NjdFMjg1MUY1MEJGMTFFN0IxNEZDN0U5MzZCREMyQjMiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo2N0UyODUxQzUwQkYxMUU3QjE0RkM3RTkzNkJEQzJCMyIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo2N0UyODUxRDUwQkYxMUU3QjE0RkM3RTkzNkJEQzJCMyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PrGIRRAAABbASURBVHja7F1/cFzFfd9VnHSSP8qN5KEJgnIax1HtOOZMXPqDaX3u7yRNdAKatDSp7igBG9nWHcaOHZKRNGmwMQHdGQOG0Nxp0naYlEHnDAmdtBM9t5PAOIAO4+AYx6NzsBnGtZSbTjuZ/uBed9/tCel80r39fnf3vZP3O35zZ937sW/3+9nv9/vZ3e/SbNe9I4SQYWJOHHaU2XGUHcX0zFcrBp9N2PuOsY+0zCWsjBnJZ7iIIvK62aCiXlg5Iuxjih1RxG16WFnKxEpL6TAMJC5xdiTZkWfHz1mD59kRNQSkpCSQuKTZdXHJa4qIYvK6GFP0ymkkkIoWSHJgClq4gk8LUEU0P2sIeJ1sh5NiB8ayJLEdjKjLIcQtePkzFiLtBab5oJpiShDTZJX4faH3jssot3DRcgrqA2uVMJ1Tzlql9gVT3cWZEu6YahkwadWYIo6I+Af8PKSlxlglXu6shUd7g6ku3OVLaLB8pq/HuEkRQHw3PzbEAHHUNDFkwaQfUEpcPgXK5Sm3rMVkCsmJCCcA64QhlRxW7oKFxvICU0QASgUpMaCoTJD7pExaJwF4DHkxamGx/MBEBGGQxtxAEAdxReWJy7JsIojPGgQwxioVWHkdC4vlCSZPOZA08ZDi8kBiJ97bQ2OQqF/3UoyHQevKUuGXAZiwvW1ScVmkXT0RzI8aeH9MPeUs6YATipj6Uiatqd8IgY/tNPaaPbKNLRjBCQ311i/IBVmXcxphOVJLEQPCKk1C25Ldu8fCAScrENeOi7GUVgpUD6IxvSa/BwdGISDiodl9IVOGUgiFH27x/pj6te5dO7h53JoI0KWQt9oEIB4Sml4rAYnjRHAPDfCji80RRJIsDsTKWgkwZhIuCiZukFWWpOZXgt4f06kMW6tkwTTXiRIEqxUSFw91fyRVHm+0TsIqQYHNqfCShUEbgkkQCA4YiT6XQgjiIar5daKIKU8YqnxYkVWyVHibWyYurxh4Rh8kdjD0HCxVPmedBLkDtUqWCl8GYNLrR8IVDBLLJKHTnZgic1evjHQxobNDyn6YWCvhB9N1ISQGCiKWKRp6HpaMSIpJwNDZHda9a3cwiV48jriFn2AZomBHGj5lBDxdCUmV8/EqiFW0VPgysUyY1Z+VVj4+cG5aZZ5yQZQsCsgRocI6QevRWqV2B5NQONQ6G4lYQkaKDcQABFBgGl7BrHJZd9ZS4e0KJu7aiXRik8hbHfXhQkKo6iMt/q+ViBCCocp9W2BrlfQKZm7eAFOgVlN8VE109XrVFr8nAK5PpUn8wP+fB5QPMndwziKyuuSAGtPY1pYKD7FligoyYalDGZB8KAKECHCaKTbQ1UOtmxJUuS4XzFLhy5CAgMp4CxcPmsbriOTfl5KYgpwVutww695ZMM1ZpVbkA9QqFCX/rts6OQSXDbap9bVUuAWTTNAMIR4WzXOOcPUSChLAqLYiKavmFkxc+n2MLSUJbMzlCPL3ZgJlFOcDuUzUZQjK2qysFkxej+ozUw50jKeI/F2Lq1cHAcFT5RVi03ZZMJEW+Q7mWaUogU1ParmVjfi9ALg3mogQz8a6ezYr62UOJt74myUyikKtwLgiV1C1tZwPKF4HUBetLKh2K5cpmLjy9EgmQUxCAOuX3RLnQXr3pKI6KRu+zgpCVoQERDnZOWOY/OHs2knN7+TlJbc5uy2YdItD1GzD2QdVdKIuXXIrV8+CyYLJd4A7EkShNafxUiVeXnJLTduYKeySbJNyDlkVs2AKuwxY0FuxYMK7eCbSeKmSiIYdEK1YMF12Vqldy2vlcgATYjVtkJJA7i9lxYLJxiA2drJgCrO0KztmXT0LplC5eHHSPsRDo0QtEWHBZHt3W34rPmVFOxQSmaCer+lxFBaHW0hI/r+EnRFhwRQGgbpIFdVTnhggSgSeTJO/h10aYd28QEV1whSwIBYNYt7DigWTEksATePFJaepWNBFg9i85FYsmAKxSmVdebXFokFo7GOJCAumwIgHaLyU01y8ceB1SQXpwKxYMIECdqjiFTSXDXP/pFW95SdhZ/PAxIPuzDyc4mYWxiENq3bf9663yS+z4z0dLnkffZt0UELeS6uk6lLvd5cfVTL2/aszY9539nf2WWEfJfa9Uq3t+cu+E+f1/7YK2m5gKgEDfBP7/EQB15jMFzf6Sx3VeOe7/5dcseJtEnn3/xFS5YChddCw/9IagpaW+UvpEzXQURJ9z/+Q/6y+i/yiSsl/VaWciKNWtc0LFbFJHBDcl3UXTsQWsbCV7eXewQgDSoIpPLecsWq1VpXexyJgarBMxKXiHFd80tr3qnjGO+dT7/y32fdfVDvK7Mj9h9uxVEdWsRuaBQgmKz5Nce9glCn+EDuSTMEjrqg+E2CqnTt3vsO+j9/07wcKtlUsmNpKjq+5iwGHjDGlTs4HUIBgqn8v3HzxfpuYPyTSYatgaXl1zdYRprbTJJwMXPLplV+I2VYKDwFhpYmcWLs1xoxCnlkFq6xWrGWCyo/XbhlhTtYUIaEHUumWi/dbssFapvDJyXVbOHs4UXVJ3AedHbRUmPvZ3/jHp7r2xljReYxXuXVmnwWatUzm5Sfr7uRWiOcgj7dFgSlJ3XzxQHkhkPakSc2i8veY+vvOvSO2ZS2YjMqp9TUgUdI28VH2pgsHFiwv+Vbnnjgr/1jDecPf7Nybty1sqn+7zOX19Xcwt4hOui6JEEE7VwVX7dHVdVp6jqKWosZLVUJL7D9nqy7lVqTchBqPi8dtYt9jVTEXcQlqvJS4cGBDA5D4NdPsksjcs8X5HjVPSeFzM/dZCt3GTPrktAckzyJFFIVI9Y2l+Xon58azB/3MD3Tm/+e57p28TNzVHGhCgPD7pZp0iRPEXXJCcHK864tkwAJKr2XKdt3L/ephoOLkVC4LFxl8uFsSkSxHyu8GZnX5aYwBqUomXe9Z9B1rBLNMDBB0/IYzDxdUNs53rronyizRELMwHGDMqtHRvrcWxklPr9wzwn4f9qwWnWcVF1qm2jsRUhiYXRxQrP6hDCbvEPp1TS5m5eLuaxp4eb9f3RALUScIbE5oZgWB5zPgCj/McyLIKvISMkTkl1xExHW+y3Am9nluifJMySJI1o4r0egNZw45OpToE29+jQNn0b1tawO27rCEt54sdN17NLn4JmxRYFHjQtlHNAApgQASlz4J3ZhA1MEmFQTEWBsudssjyQbeA/dvPH1oMzucIF7gmZW7I6LxpYR3IvnFN7DGdIq6VhD3Ia8/4hO0MYLLy3hEBZiiCOtmXJhV4r0cJiEkV7iej55+pBjoi1CvQ4A2/sQ3Opt2gJjVyVHsLvOLCKatKhJe0wDyOQVV1HhaU0UqlenrPx+j9BL6WEZSG0490s+OSpDv8cyVu7EdQtStxaYLG7G2dKMcFusklgZhvB6ZDi+JfY7KcaZ2GM+AAomDZ0Ps1KOFoF+geOXuGCWoDmGux3+y+To2jHVSnQIa6+KN+wRtAgnanGowxQQzGEopX397ksBmN3Agbb7u5KOl4IG0K6K003Jps3thOgzVrh4GnHyRqGMAtKX6YkzVMyCGwrgXEQNSBGSV3BqQ1p98LBxz3Gouakzh/aJPdn1ppMHVq4SBiFBACPilwzGptxdYctVgUttzKtMZj1qFmPH+j4QESN9+/64k1bGmyiVDT3R+KQJxjzS7elhQjhso74KOR8fcvDhDezIsQPrZRmaVKCTLkZtZ99pjTkiAFCNq4qTFOsB0g3XCJNlU5erFEdfKJCDFgHZBFixdE13DNPaUBFgl58OvHQ5Tgv08wQXILd1zRM+u3KqIUAEDyJzEc+KqnqMLTCFy91xZq1ShlIRmDtuzH9g1ZmA2e4S5ekmFRATWM8G6ikUDz3EarZ/OJRiJoJPU/2zjX8cBQWxu7YnDvlycF1dvS/5o9baxY6u2pY+t2q7ccjx71T0J5qKmTdSVS+lQg6vH6wDq5kaQOyViLFtJItUb5jmXWG7d65nyQbp7VLqy3PKaE4dH/Jz50upBruR5QW6MqbbEfJIrNWvdY493fTmq0NUD0c0KXDy/Y0uY3VW8GQ+mwcQrJsipRrK9o69MsC/3DjYjBBIvrNqukiSYQMZJ/QASIdFgnbjCVAzVvQriQcY9HVD9DBMrbdNBuHtvbLwtLqmMlV878XjLhpjqHVxqgmn6hZ7t2HiBfPeqnbjxJJdkb53ZV5S1LK7bVMGgY05QVw8zgCqTYx7jhuaCAhMh+mhdlY3it0drNcE0/3zPdjAQnuveGae4OKn0F7P7MjVMSW/5GTvc+eWIH8XR0QbILYS4+J0hniDwAWFnsZjMFJjMTzWicj07U+CWvXipdzDpr7Hp5A97dkg31j917wQtq5hvXcm8lbifnd0Hmc0Qb3D1OGMFHbhOaD6/8d2LOkDut3MxmVBl2ORUIyrne5d7jz++pMK8suYuvhDPr4X1QPGDa3dEJMuMjZMyf35pei/ZLUNj0KBegaun3cVDWr/yUks6TGcnMsJOnb/hNlk3y1nqR55rnMgPnMZk3vd73XePIIPvwmdm9hdk362JbEK4wFiAYN7fb6eBmSG+ZKdiGkx8qpGJcRNJC+ge9dEAkDgo8W/XDrW0Zt+7+u44M0sY1pNbo6bL2z83ex/PiFTG1B1yh3lfVgC7DEJiESDG+mV1gQlKmZpw92IAZVQIzoXtzACVXOzHf+6+O0JdlMWu8ISUn57dX0G8n5931e3qodYu+ZkPiHTxCq3cSAyYoCwPbDmEnFwhc/KHjj/RStnKqNIwsPzrNenYInFSHgnW0T+7uL9V+V+RueFjlzJ6RKwNgtaDnzEd7BQiP89IIu7fsjMBg0mk+AKzPMjpJiotU8t3WH/SW2FbwuGJTB69Jr1ASf+lO4POR3HLxfuzKt7RZ/2NI9o70sKqYGfKJBQBbjHiwdEGJiEZDBkRkpnlft3VzQjXtm6RJx0BqO9fncHmo2BWwk0pfseWro4mZVexoHDJpR/IaUq+ZsagwCTQmkUoV9tkNbru5KMVl1AsoLxpSAxI2PEk7h/233zxgNHELmKwEjojok+ji+cHlEPAe/oev1LB5o0iFCwd9MxyGdlw6pES0hp7fjt13SlknJS56cKBoFYAK3X1FCxP9wtKKGB9T1FCg0k8COXukTYSBqiC69PsL+WSIK51+i8cCGzhoqCgVU5+VRk7R5vF4qLDhta577buUFTB3Jd2EBUw0k6Auv7UIyPI+AET3/WHoAqg794n6f6pegY0JnMk1kYpHbTFrE4dDjCJJbTH4tbYrKvF4qTEBVCcFFVcEuiwyAJXT8HaJd3WT8qlVQYmgWCM+6Ny7OmobkX76Gkvq+tm1yWmSIDRvrcecEx0GFtnv+L4aGtHgbLrGB5ZMEiMmFnRdAGgKctUH3sqAy+Pk4C2wOQbnkGu23j6kAcoQrQDyvnUWw9gXOHrQkRE9Clwv0w8Q9r66pibF4ZkJKoGKVvKr//0kAqGr1WchK1Tmffza3GgRITn6gl3T5drnxBWCTV9KHAwibGnQsBgkrSOdBPmYTecOVRw4eNtLTunT771ANTak292fjEquVtG2Wc7YzK/JjW5ePNdPcwzijLEg07LVA/OA9spovvYN2QtE9q9/I0zD2cILq1wM8n+6ZsPYO8pq1Ay8/igRMQAUc/iNXP1oAO1IBdWC5gUjD2hxZULkKNix3Wk0JSrjOFzS59482sq6lA2ZihJtDN0FW5Ms2WqdyKQNi1Dd8LUtp4JOfakAk1HpU53wb3YnPzmmYP1cSCsVa5QBeNJf9e5NyqrUFtaMHkKiYiwCjjnhe7FgUFaJ9neJfGTdXeiJ97+1vTDfDHeZpyBI6mPv/lgGVsWKt9BQHrkwjIDUyGUYBJuwGgQNXLNi17cJGMhLklgD5Xfnj5YYpYOysAVPnbuQXTs9Q9de/mGBUkp8FHpfBHYVbhS1toEkDA7xptYts5ZrjIJRmSVcujkui1KloXcWD5YIPIMX4mqs+aQbXSgID5ioC1NDLmMu6wXhB7awSSQHsjYkyvt/1Kly0JuPHtQhuGr8PVJf3L+QXQPzKwSj5WkXbw7Z75SAbYxZgsaP+KIZ+icviWz02Bglqk+9mR8d/JfffFvIWxT+rUPb1E5mOiX4cv88fmHVCnLmKxVoq6LJRJ0EhHjBp6BDkdMZicKaOyJSrMzrsJlIb9zNlchtfhpqXcv/tG5h5TEHU917uU7DMrSzuU7Zv8G29npipvmz5HT9gwVnb0xMCmYCAu0Tk8WAC5I7MdrtygD1O++keMWZzGqu6zKDX6qa0+MwJbCjypqX0dDExYNkB1FDPEQhGXilZElppctEG8MCaAsNHli7dakqjJseiPrNAeN2/+H5x9CN+S3OvdAEmXWrZIqBdXhhuUMkB05FTcxnYTSFCuzQKIvg6wTH+/Jv7pGKaAKzOXLiLJ41uoPzo+VFAFpErTDIFXnLSC3oFmMFChpJjtKEvvfhgtMouBBLLuGUs754woBFT+XzW4+n+35vXNjG37/3BjaT//HlXv4eNIkgQDJJaXbZ5RZJR2xU86ABcypulEQlqnuoxslI5h1KiKCzPwra+5KkpDJ0yu/EKHEnQTveUtdHV7CuAFgqgKsEuIhUDAFOPaUQoA4X+q9aywsQHpm5W4OoGkCBBID4OjtitybJp6HivsuSgooJDuUEA9BW6a67+uYfGbPy1+vIKb5eMWe6h2cYkc0SCBNXLl7hKFhisKzoJZum/VWResSFa7TOPJ3oy5eoGAKioxYVfp6ERmzcUsw9dLqwRHTZS/+yq548crdPOceZpaGiQxHWNep0moZhAKyQxnxEAowBTX2xACVcXFW0Zt29OLqbdPs0B5Lffv9u6Ls4Nt/woiGBWESSaUAq0gBbnzBABgxoFVO4wdtmbBJWDDSz9ksLK/BY6ljq7ZNH1u1feSFVduVun/fueqexLMf2DVBa7GRCtCmkrNfNTWtC6OsOcXn6SQxwgOmoNy9D5aeUJlZKCpcr+kXerZPPd+zI/3Dnh1x2ZvwPW2f696Z+G73zjwD0s95eMRiIyUrUiklmYHZ+wqm6lfMx4RYf8ev+4UgOwoqiYe6rBAvLNvwJdUVn+26l8cx0PVEoPKsPv5E5fX1d2x2a+6Tqh05YnVX7AfX7iBVQh1mAStVl3q5FVx+VNnBtNv77tIr2GeMHVFxcKbN+02hjP7VzH1Bje1NScZzsuOBo0RuE4SKrtCCtxsBJM8v6UA2cJ+eCjaQPLX+zghTcAYoypWaVD0tp/xfTfE95abiu1dlpNrwnVel9yH+XgdNlZ/j8nvWzm0CJiIe532vijK9cz59pwzuvPMXfKe1/9N5z66fw6z+Z2f3FUhAIrK2RnXqlcpn8HVJKDBZIYQvWWeK6AX4ywRMFfb3zF8adO2Wg1gwKZST67aMMTCl2xpMLimz7/23zuwr2RY1B6YOW30LZc2JwxmmkSoyDAUlnK3bYIFkXqxlWkROrN3KJ5DmmVVItIllqrCP1Gdm9hdt61k3L5Ty6pqtHExjTKmjIQZTlq/Z+vTs/optMQum0AufNc6UepiDKkRg8nYxvOXi/WXbQhZMbSdTvYNJVt3DTMGjAYGpwj6K7O+jN12wILJgWgby0urBGFPoIVb3CXZEDICJJ7bMsXOKwN0DregGE+ZiKzX50Qe3x5nS97l8JkmVz2ZQASbOJlKH3esIO9/BbCtjxYKpbYTShQb++Z4dcQaGGENJpMr3fqqBydvcqwFMfGC1JMBUZt/PVvnUKEpKHzv3oAVPm4Hp/wUYAEb2qJoDg7CRAAAAAElFTkSuQmCC";function ce(i,e,t){return e<String(i).length?i.toString():Array(e-String(i).length+1).join("0")+i}function _t(i){const e=[0,4129,8258,12387,16516,20645,24774,28903,33032,37161,41290,45419,49548,53677,57806,61935,4657,528,12915,8786,21173,17044,29431,25302,37689,33560,45947,41818,54205,50076,62463,58334,9314,13379,1056,5121,25830,29895,17572,21637,42346,46411,34088,38153,58862,62927,50604,54669,13907,9842,5649,1584,30423,26358,22165,18100,46939,42874,38681,34616,63455,59390,55197,51132,18628,22757,26758,30887,2112,6241,10242,14371,51660,55789,59790,63919,35144,39273,43274,47403,23285,19156,31415,27286,6769,2640,14899,10770,56317,52188,64447,60318,39801,35672,47931,43802,27814,31879,19684,23749,11298,15363,3168,7233,60846,64911,52716,56781,44330,48395,36200,40265,32407,28342,24277,20212,15891,11826,7761,3696,65439,61374,57309,53244,48923,44858,40793,36728,37256,33193,45514,41451,53516,49453,61774,57711,4224,161,12482,8419,20484,16421,28742,24679,33721,37784,41979,46042,49981,54044,58239,62302,689,4752,8947,13010,16949,21012,25207,29270,46570,42443,38312,34185,62830,58703,54572,50445,13538,9411,5280,1153,29798,25671,21540,17413,42971,47098,34713,38840,59231,63358,50973,55100,9939,14066,1681,5808,26199,30326,17941,22068,55628,51565,63758,59695,39368,35305,47498,43435,22596,18533,30726,26663,6336,2273,14466,10403,52093,56156,60223,64286,35833,39896,43963,48026,19061,23124,27191,31254,2801,6864,10931,14994,64814,60687,56684,52557,48554,44427,40424,36297,31782,27655,23652,19525,15522,11395,7392,3265,61215,65342,53085,57212,44955,49082,36825,40952,28183,32310,20053,24180,11923,16050,3793,7920];let t=65535,s,r;for(r=0;r<i.length;r++){const a=i.charCodeAt(r);if(a>255)throw new RangeError;s=(a^t>>8)&255,t=e[s]^t<<8}return ce(((t^0)&65535).toString(16).toUpperCase(),4)}function en(i){let t=[{id:"00",value:"01"},{id:"01",value:"11"},{id:"26",value:[{id:"00",value:"SG.PAYNOW"},{id:"01",value:"0"},{id:"02",value:i.uen},{id:"03",value:i.editable.toString()},{id:"04",value:i.expiry}]},{id:"52",value:"0000"},{id:"53",value:"702"},{id:"54",value:i.amount.toString()},{id:"58",value:"SG"},{id:"59",value:i.name},{id:"60",value:"Singapore"},{id:"62",value:[{id:"01",value:"Blank is fine..."}]}].reduce((s,r)=>(Array.isArray(r.value)&&(r.value=r.value.reduce((a,l)=>(a+=l.id+ce(l.value.length.toString(),2)+l.value,a),"")),s+=r.id+ce(r.value.length.toString(),2)+r.value,s),"");return t+="6304"+_t(t+"6304"),t}const tn=()=>{const[i,e]=p.useState(localStorage.getItem("countryCode")||"+65"),[t,s]=p.useState(localStorage.getItem("phoneNumber")||""),[r,a]=p.useState(localStorage.getItem("payNowName")||"");p.useEffect(()=>{localStorage.setItem("countryCode",i)},[i]),p.useEffect(()=>{localStorage.setItem("phoneNumber",t)},[t]),p.useEffect(()=>{localStorage.setItem("payNowName",r)},[r]);const l=m=>{e(m.target.value)},c=m=>{s(m.target.value)},d=m=>{a(m.target.value)},u={uen:`${i}${t}`,name:r||"Payee",editable:1,expiry:"20990106",amount:0,refNumber:""},x=en(u),[F,I]=p.useState(!1);return p.useEffect(()=>{const m=()=>{window.innerHeight<document.documentElement.clientHeight?I(!0):I(!1)};return window.addEventListener("resize",m),()=>{window.removeEventListener("resize",m)}},[]),n.jsxs(vt,{maxWidth:"xs",sx:{height:F?"calc(100vh - 50px)":"100vh",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",paddingBottom:F?"50px":"0"},children:[n.jsxs(h,{sx:{width:"100%",mb:4},children:[n.jsxs(W,{select:!0,label:"国家代码",value:i,onChange:l,variant:"outlined",sx:{width:"30%",mr:1},children:[n.jsx(q,{value:"+65",children:"+65 新加坡"}),n.jsx(q,{value:"+86",children:"+86 中国"})]}),n.jsx(W,{label:"手机号",variant:"outlined",value:t,onChange:c,sx:{width:"65%"}})]}),n.jsx(h,{sx:{width:"100%",mb:4},children:n.jsx(W,{label:"PayNow 名字",variant:"outlined",fullWidth:!0,value:r,onChange:d})}),n.jsx(h,{sx:{width:"100%",display:"flex",justifyContent:"center",alignItems:"center",flexDirection:"column"},children:n.jsxs(h,{sx:{width:"80%",display:"flex",justifyContent:"center",alignItems:"center",flexDirection:"column",boxShadow:"0px 4px 12px rgba(0, 0, 0, 0.1)",padding:"16px",borderRadius:"8px",backgroundColor:"#fff"},children:[n.jsxs(h,{sx:{height:"8svh"},children:[n.jsx(h,{sx:{height:"4.4svh"},children:n.jsx("p",{style:{textAlign:"center",fontSize:"25px",margin:"0"},children:n.jsx("b",{children:r})})}),n.jsx(h,{sx:{height:"3svh"},children:n.jsx("p",{style:{textAlign:"center",color:"#645f60",fontSize:"20px",margin:"0"},children:i+" "+t})})]}),n.jsx(ke,{style:{marginBottom:"10px"},value:x,size:250,fgColor:"#771976",logoImage:$t,logoHeight:60,logoWidth:90,quietZone:10,logoOpacity:1,removeQrCodeBehindLogo:!0,eyeRadius:[{outer:0,inner:0},{outer:0,inner:0},{outer:0,inner:0}]}),n.jsx(z,{variant:"contained",color:"secondary",sx:{backgroundColor:"#771976"},children:"SCAN TO PAY"})]})})]})};function nn(){return n.jsx(Ft,{children:n.jsxs(Pt,{children:[n.jsx(we,{path:"/",element:n.jsx(Xt,{})}),n.jsx(we,{path:"/paynow",element:n.jsx(tn,{})})]})})}Qe.createRoot(document.getElementById("root")).render(n.jsx(nn,{}));
