const __vite__fileDeps=["./ably-Da9rdPj7.js","./@babel-Dgkpvorn.js","./@hugotomazi-DS0qXKOR.js","./@capacitor-qDJewH9C.js"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{r as h,j as n,a as N}from"./react-CSbO9UDQ.js";import{R as it,c as ot}from"./react-dom-DuxYtAv3.js";import{_ as Ne}from"./@hugotomazi-DS0qXKOR.js";import{u as ce,B as g,T as lt,D as oe,a as T,F as ct,I as dt,S as ut,M as K,b as H,c as F,d as he,e as ht,f as gt,g as pt,h as Le,i as Oe,j as me,k as fe,C as ye,l as Be,m as mt,L as ke,n as Ve,o as Ie,p as ft,q as yt,r as xt,P as bt,s as wt,t as St,v as vt,w as Ct,x as kt,y as Y,z as It,A as jt,G as Tt,E as re,H as At,J as Ut,K as Rt,N as Dt,O as Et,Q as Pt,R as Ft,U as Mt,V as je,W as Te,X as zt,Y as Nt,Z as Lt}from"./@mui-Bh5p_5NY.js";import{m as Ot}from"./mitt-DJ65BbbF.js";import{v as Bt}from"./uuid-ChpN7rDH.js";import{t as Vt,i as ee}from"./i18next-CMUxQoQY.js";import{i as Ae,o as Ue}from"./react-device-detect-Cg_tFtfp.js";import{a as Jt,r as Wt,b as ge}from"./mobx-DqfxVlHi.js";import{J as we}from"./jszip-DKe8AYj8.js";import{B as Kt}from"./i18next-browser-languagedetector-BYJGhdrD.js";import{i as Ht,u as ne,T as le}from"./react-i18next-z13pudJP.js";import{k as qt}from"./bigonion-kit-CY3QLVqN.js";import{C as Qt,a as Je,r as Yt}from"./@capacitor-qDJewH9C.js";import{Q as xe}from"./react-qrcode-logo-B5WL9caK.js";import{o as We}from"./mobx-react-lite-BwLOQLWC.js";import{H as Zt}from"./react-router-dom-Bez3Jxb0.js";import{a as Gt,b as Re}from"./react-router-BI72GPyv.js";import"./@babel-Dgkpvorn.js";import"./scheduler-CzFDRTuY.js";import"./clsx-B-dksMZM.js";import"./@emotion-BG6USH-z.js";import"./hoist-non-react-statics-DQogQWOa.js";import"./stylis-YPZU7XtI.js";import"./react-is-DUDD-a5e.js";import"./react-transition-group-BXtmX9vz.js";import"./@popperjs-DXqTHVUr.js";import"./ua-parser-js-B5xEC-cs.js";import"./html-parse-stringify-D972AbD_.js";import"./void-elements-SqjqTxkI.js";import"./lodash.isequal-CctyO0RI.js";import"./qrcode-generator-B7rwAJ2l.js";import"./use-sync-external-store-BiA-bmUR.js";import"./@remix-run-DspApiwr.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(r){if(r.ep)return;r.ep=!0;const i=t(r);fetch(r.href,i)}})();const Ke=Ot(),Xt=()=>{const a=ce(),[e,t]=h.useState([]),s=h.useRef(null),r=h.useRef(null);return h.useEffect(()=>{Ke.on("show",i=>{const o=Date.now(),d=r.current;if(d&&d.message===i.message&&o-d.timestamp<200)return;r.current={message:i.message,timestamp:o};const c=Bt(),p={id:c,message:i.message,duration:i.duration||2500,zIndex:i.zIndex||9999};t(u=>[...u,p]),setTimeout(()=>{t(u=>u.map(x=>x.id===c?{...x,isExiting:!0}:x)),setTimeout(()=>{t(u=>u.filter(x=>x.id!==c))},300)},p.duration)})},[]),it.createPortal(n.jsxs("div",{ref:s,style:{position:"fixed",bottom:"10%",left:"50%",transform:"translateX(-50%)",zIndex:Math.max(...e.map(i=>i.zIndex),9999)},children:[n.jsx("div",{style:{position:"relative"},children:e.map((i,o)=>n.jsx("div",{className:`toast ${i.isExiting?"toast-exit":"toast-enter"}`,style:{backgroundColor:a.palette.background.paper,color:a.palette.text.primary,padding:"10px 20px",borderRadius:"8px",fontSize:"14px",maxWidth:"300px",textAlign:"center",whiteSpace:"pre-wrap",wordBreak:"break-word",boxShadow:"0 4px 8px rgba(0,0,0,0.3)",position:"relative",marginBottom:"10px",transition:"transform 300ms ease, opacity 300ms ease, margin 300ms ease",opacity:i.isExiting?0:1,transform:i.isExiting?"translateY(10px)":"translateY(0)"},children:i.message},i.id))}),n.jsx("style",{children:`
        .toast-enter {
          animation: fadeInUp 200ms ease-out;
        }

        .toast-exit {
          animation: fadeOutDown 300ms ease-in;
        }

        @keyframes fadeInUp {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        @keyframes fadeOutDown {
          from {
            opacity: 1;
            transform: translateY(0);
          }
          to {
            opacity: 0;
            transform: translateY(10px);
          }
        }
      `})]}),document.body)},y=(a,e,t)=>{Ke.emit("show",{message:a,severity:t?.kind??"success",duration:e??2500,zIndex:t?.zIndex??9999})};class Se{rtc;static rtcServers=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.counterpath.net"},{urls:"stun:stun.internetcalls.com"},{urls:"stun:stun.voip.aebc.com"},{urls:"stun:stun.voipbuster.com"},{urls:"stun:stun.xten.com"},{urls:"stun:global.stun.twilio.com:3478"}];constructor(e){this.rtc=e}createPeerConnection(e){const t=new RTCPeerConnection({iceServers:Se.rtcServers,iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});this.rtc.negotiationMap.set(e,{isNegotiating:!1,queue:[]}),t.onnegotiationneeded=async()=>{};let s=[],r=!1;return t.onicecandidate=i=>{if(i.candidate){s.push(i.candidate);const c=i.candidate.candidate.split(" "),p=c[4],u=c[7];this.rtc.staticIp&&p!==this.rtc.staticIp&&u==="srflx"&&y(Vt("alert.proxy")),r||(r=!0,setTimeout(()=>{this.rtc.broadcastSignal({type:"candidate",candidates:s,to:e}),s=[],r=!1},400))}},t.ondatachannel=i=>{this.rtc.setupDataChannel(i.channel,e)},t.onconnectionstatechange=()=>{if(console.log(`[CONNECT] ${e} çŠ¶æ€:`,t.connectionState),t.connectionState==="connected"){console.log(`[CONNECT] âœ… ${e} è¿æ¥æˆåŠŸï¼Œå–æ¶ˆè¶…æ—¶`);const i=this.rtc.userList.get(e);i&&this.rtc.userList.set(e,{...i,status:"connected"}),clearTimeout(this.rtc.connectionTimeouts.get(e))}["failed","disconnected","closed"].includes(t.connectionState)&&(console.warn(`[CONNECT] âŒ ${e} è¿æ¥å¤±è´¥æˆ–æ–­å¼€ï¼Œç«‹å³å…³é—­`),t.close(),b.peers.delete(e),this.rtc.updateConnectedUsers(this.rtc.userList))},e&&b.peers.set(e,t),t}removePeer(e){const t=b.peers.get(e);t&&(t.close(),b.peers.delete(e)),this.rtc.dataChannels.delete(e),this.rtc.negotiationMap.delete(e),this.rtc.lastConnectAttempt.delete(e),this.rtc.userList.delete(e),console.log(`ğŸ§¹ å·²æ¸…é™¤ä¸ ${e} çš„è¿æ¥èµ„æº`)}isPrivateIP(e){return e.startsWith("10.")||e.startsWith("192.168.")||e.match(/^172\.(1[6-9]|2\d|3[0-1])\./)}}const X=()=>Ae&&Ue==="iOS"?"apple":Ae&&Ue==="Android"?"android":"desktop";function He(a,e){const[t,s]=a.split(":"),[r,i]=e.split(":");if(!s||!i)return!1;const o=s.localeCompare(i);if(o>0)return!0;if(o<0)return!1;const d=t.localeCompare(r);return d>0?!0:d<0?!1:a>e}function te(a){return a?a.length<2?{isValid:!1,message:"æˆ¿é—´åå¤ªçŸ­å•¦ï¼Œè‡³å°‘ä¸¤ä¸ªå­—ç¬¦"}:a.length>12?{isValid:!1,message:"æˆ¿é—´åæœ€å¤š 12 ä¸ªå­—ç¬¦"}:/^[\u4e00-\u9fa5a-zA-Z0-9 _-]+$/.test(a)?{isValid:!0,message:"æˆ¿é—´ååˆæ³•"}:{isValid:!1,message:"åªèƒ½ä½¿ç”¨ä¸­æ–‡ã€å­—æ¯ã€æ•°å­—ã€ç©ºæ ¼ã€ä¸‹åˆ’çº¿æˆ–ä¸­åˆ’çº¿"}:{isValid:!1,message:"æˆ¿é—´åä¸èƒ½ä¸ºç©º"}}async function $t(){const a=new AbortController,e=setTimeout(()=>a.abort(),2e3);try{const t=await fetch("https://ipinfo.io/json?token=43b00e5b7d1add",{signal:a.signal});if(!t.ok)throw new Error("Response not OK");return(await t.json()).ip?.trim()??null}catch(t){return console.warn("ğŸŒ testIp è¯·æ±‚å¤±è´¥æˆ–è¶…æ—¶:",t),null}finally{clearTimeout(e)}}const _="user_settings",J={roomId:"",userTheme:"light",userLanguage:"system",backupBackWsUrl:"wss://md-server-md-server-bndnqhexdf.cn-hangzhou.fcapp.run",customServerUrl:"wss://ecs.letshare.fun",customAuthToken:"98d9a399675116e5256e9082c192bc06eb6434937af99f201252e9424c7a5652",serverMode:"custom",ablyKey:"4TtssQ.e9OvDA:wYBGdtWQNgicbeIKNtgeV_s5XEKmfLKD_Gue5XQrWuw",version:"3.3.0",isNewUser:!0},pe={settingsPageState:!1};class _t{settings={...J};unrmb={...pe};constructor(){Jt(this),this.loadFromLocalStorage(),Wt(()=>this.settings,e=>{localStorage.setItem(_,JSON.stringify(e))})}update(e,t){if(!(e in J))throw new Error(`âŒ update() ä¸å…è®¸çš„è®¾ç½®é¡¹: ${e}`);const s=this.settings[e];typeof t=="object"&&t!==null&&typeof s=="object"&&!Array.isArray(s)?this.settings[e]={...s,...t}:this.settings[e]=t,localStorage.setItem(_,JSON.stringify(this.settings))}get(e){if(!(e in J))throw new Error(`âŒ get() ä¸å…è®¸çš„è®¾ç½®é¡¹: ${e}`);return this.settings[e]}getUnrmb(e){if(!(e in pe))throw new Error(`âŒ getUnrmb() ä¸å…è®¸çš„å­—æ®µ: ${e}`);return this.unrmb[e]}updateUnrmb(e,t){if(!(e in pe))throw new Error(`âŒ updateUnrmb() ä¸å…è®¸çš„å­—æ®µ: ${e}`);this.unrmb[e]=t}getAllSettings(){return{...this.settings}}reset(){ge(()=>{this.settings={...J}}),localStorage.setItem(_,JSON.stringify(this.settings))}loadFromLocalStorage(){const e=localStorage.getItem(_);try{const t=e?JSON.parse(e):null;if(t&&typeof t=="object"&&Object.keys(J).every(r=>r in t))ge(()=>{this.settings={...J,...t}});else throw new Error("æ— æ•ˆé…ç½®æˆ–å­—æ®µç¼ºå¤±ï¼Œå·²é‡ç½®ä¸ºé»˜è®¤å€¼")}catch(t){console.warn("âš ï¸ åŠ è½½é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®:",t),ge(()=>{this.settings={...J}}),localStorage.setItem(_,JSON.stringify(this.settings))}}}const f=new _t,De={translation:{meta:{title:"LetShare | Perkongsian Fail & Teks Merentas Platform"},welcome:"Selamat datang ke Aplikasi Saya",language:"Bahasa",button:{file:"Fail",image:"Gambar",text:"Teks",clipboard:"Papan Klip",searchUsers:"Cari pengguna dalam Wi-Fi yang sama",disconnected:"Server telah terputus",cancel:"Batal",confirm:"Sahkan",accept:"Terima",reject:"Tolak",downloadAll:"Download All"},prompt:{dropToUpload:"Lepaskan untuk muat naik"},guide:{title:"Panduan Pengguna ğŸ‰:",step1:"1. Sambungkan kedua-dua peranti ke Wi-Fi yang <strong>sama</strong>",step2:"2. ID bilik mesti <strong>sepadan</strong> di kedua-dua peranti!"},dialog:{newShare:"âœ¨ Kongsi Baru",incomingMessage:"Anda menerima mesej, adakah anda mahu terima?",inputText:"Masukkan Teks"},placeholder:{inputText:"Sila masukkan teks untuk dihantar..."},toast:{copiedToClipboard:"Berjaya salin ke papan klip",zipFailed:"Pemampatan gagal. Sila cuba lagi.",connectingUser:"Sedang sambung ke pengguna...",taskInProgress:"Tugas sedang dijalankan!",clipboardEmpty:"Papan klip kosong atau tidak disokong.",noContentSelected:"Tiada kandungan dipilih",emptyInput:"Kosong"},transfer:{sending:"ğŸ“¤ Menghantar fail kepada <strong>{{name}}</strong>",receiving:"ğŸ“¥ Menerima fail dari <strong>{{name}}</strong>: {{filename}}",byte:"bait",receivedFiles:"ğŸ“ Fail yang diterima",noTasks:"Tiada tugas aktif"},settings:{title:"Tetapan",languageLabel:"Bahasa",languageOptions:{system:"Ikut sistem",zh:"Cina Ringkas"},roomId:{label:"ID Bilik",required:"ID bilik wajib diisi",helper:"Peranti mesti menggunakan ID bilik yang sama untuk berhubung"},saveButton:"Simpan Tetapan",joinSuccess:"Berjaya sertai bilik"},footer:{shareTitle:"Kongsi Â· Segera",qrPrompt:"Imbas kod QR untuk menyertai bilik:"},userId:{inputError:"Hanya huruf, nombor",display:"ID anda"},alert:{invalidRoom:"Nama bilik tidak sah",newUser:"Pengguna baru telah bersambung: {{name}}",transferCancelled:"Pihak lawan membatalkan pemindahan!",chunkMissing:"Kepingan {{index}} hilang. Sila hantar semula fail!",unzipping:"Sedang mengekstrak... sila tunggu",fileReceived:"Berjaya menerima fail daripada {{name}}!",disconnected:"Terputus sambungan. Sila tunggu atau segarkan semula",proxy:"IP virtual telah terdeteksi, mohon jangan gunakan proxy atau VPN, jika tidak, Anda mungkin tidak dapat terhubung!"}}},en={en:{translation:{meta:{title:"LetShare | Cross-platform File & Text Sharing"},welcome:"Welcome to My App",language:"Language",button:{file:"File",image:"Image",text:"Text",clipboard:"Clipboard",searchUsers:"Search Users in Same Wi-Fi",disconnected:"The server has been disconnected",cancel:"Cancel",confirm:"Confirm",accept:"Accept",reject:"Reject",downloadAll:"Download All"},prompt:{dropToUpload:"Drop to upload"},guide:{title:"User Guide ğŸ‰:",step1:"1. Connect both devices to the <strong>same</strong> Wi-Fi",step2:"2. Room IDs <strong>must match</strong> on both devices!"},dialog:{newShare:"âœ¨ New Share",incomingMessage:"You received a message, accept it?",inputText:"Input Text"},placeholder:{inputText:"Please enter the text to send..."},toast:{copiedToClipboard:"Copied to clipboard",zipFailed:"File compression failed. Please try again.",connectingUser:"Connecting to user, please wait...",taskInProgress:"A task is already in progress!",clipboardEmpty:"Clipboard is empty or unsupported.",noContentSelected:"No content selected",emptyInput:"It's empty"},transfer:{sending:"ğŸ“¤ Sending file to <strong>{{name}}</strong>",receiving:"ğŸ“¥ Receiving file from <strong>{{name}}</strong>: {{filename}}",byte:"byte",receivedFiles:"ğŸ“ Received Files",noTasks:"No active tasks"},settings:{title:"Settings",languageLabel:"Language",languageOptions:{system:"Follow system",zh:"Simplified Chinese"},roomId:{label:"Room ID",required:"Room ID is required",helper:"Only Same RoomId Can Connect"},saveButton:"Save Settings",joinSuccess:"Successfully joined room"},footer:{shareTitle:"Share Â· Instantly",qrPrompt:"Scan the QR code to join room:"},userId:{inputError:"Only letters, numbers",display:"Your ID"},alert:{invalidRoom:"Invalid room name",newUser:"New user connected: {{name}}",transferCancelled:"The other party canceled the transfer!",chunkMissing:"Chunk {{index}} missing. Please resend the file!",unzipping:"Unzipping... please wait",fileReceived:"Successfully received file from {{name}}!",disconnected:"Disconnected. Please wait or refresh the page",proxy:"A virtual IP has been detected, please do not use a proxy or VPN, otherwise you may not be able to connect!"}}},zh:{translation:{meta:{title:"ä¹äº«Share | æ–‡ä»¶ & æ–‡æœ¬è·¨å¹³å°å…±äº«"},welcome:"æ¬¢è¿ä½¿ç”¨æˆ‘çš„åº”ç”¨",language:"è¯­è¨€",button:{file:"æ–‡ä»¶",image:"å›¾ç‰‡",text:"æ–‡æœ¬",clipboard:"å‰ªè´´æ¿",searchUsers:"æœç´¢åŒWIFIä¸‹ç”¨æˆ·",disconnected:"æœåŠ¡å™¨å·²æ–­å¼€è¿æ¥",cancel:"å–æ¶ˆ",confirm:"ç¡®è®¤",accept:"æ¥å—",reject:"æ‹’ç»",downloadAll:"å…¨éƒ¨ä¸‹è½½"},prompt:{dropToUpload:"æ¾æ‰‹ä¸Šä¼ æ–‡ä»¶"},guide:{title:"ä½¿ç”¨æŒ‡å—ğŸ‰ï¼š",step1:"1. ä¸¤ä¸ªè®¾å¤‡è¿æ¥åˆ°<strong>åŒä¸€ä¸ª</strong>å±€åŸŸç½‘ï¼ˆéƒ¨åˆ†å…¬å…± WiFi ä¸å¯ç”¨ï¼‰",step2:"2. ä¸¤ä¸ªè®¾å¤‡æˆ¿é—´å·<strong>å¿…é¡»ç›¸åŒ</strong>ï¼"},dialog:{newShare:"âœ¨ æ–°åˆ†äº«",incomingMessage:"æ‚¨æœ‰æ¥è‡ªå¤–éƒ¨çš„æ¶ˆæ¯ï¼Œæ˜¯å¦æ¥å—ï¼Ÿ",inputText:"è¾“å…¥æ–‡æœ¬"},placeholder:{inputText:"è¯·è¾“å…¥è¦å‘é€çš„æ–‡æœ¬..."},toast:{copiedToClipboard:"æˆåŠŸå†™å…¥å‰ªè´´æ¿",zipFailed:"æ–‡ä»¶å‹ç¼©å¤±è´¥ï¼Œè¯·é‡è¯•ï¼",connectingUser:"æ­£åœ¨è¿æ¥ç›®æ ‡ç”¨æˆ·ï¼Œè¯·ç­‰å¾…è¿æ¥å»ºç«‹",taskInProgress:"æœ‰ä»»åŠ¡æ­£åœ¨è¿›è¡Œä¸­ï¼",clipboardEmpty:"å‰ªåˆ‡æ¿ä¸ºç©º, æˆ–æµè§ˆå™¨ä¸æ”¯æŒ",noContentSelected:"æœªé€‰æ‹©å‘é€å†…å®¹",emptyInput:"ç©ºå•¦"},transfer:{sending:"ğŸ“¤ æ­£åœ¨å‘é€æ–‡ä»¶ç»™ <strong>{{name}}</strong>",receiving:"ğŸ“¥ æ­£åœ¨æ¥æ”¶æ¥è‡ª <strong>{{name}}</strong> çš„æ–‡ä»¶ï¼š{{filename}}",byte:"å­—èŠ‚",receivedFiles:"ğŸ“ å·²æ¥æ”¶çš„æ–‡ä»¶",noTasks:"æ²¡æœ‰è¿›è¡Œä¸­çš„ä»»åŠ¡"},settings:{title:"è®¾ç½®",languageLabel:"è¯­è¨€/Language",languageOptions:{system:"è·Ÿéšç³»ç»Ÿ",zh:"ç®€ä½“ä¸­æ–‡"},roomId:{label:"æˆ¿é—´å·",required:"æˆ¿é—´å·å¿…å¡«å•¦",helper:"åªæœ‰åŒä¸€æˆ¿é—´å·æ‰èƒ½äº’ç›¸è¿æ¥å“¦"},saveButton:"ä¿å­˜è®¾ç½®",joinSuccess:"æˆåŠŸåŠ å…¥æˆ¿é—´"},footer:{shareTitle:"åˆ†äº«Â·ä¸€è§¦å³å‘",qrPrompt:"æ‰«æäºŒç»´ç ä»¥åŠ å…¥æˆ¿é—´:"},userId:{inputError:"åªå…è®¸12å­—ç¬¦ä»¥å†…çš„å­—æ¯ã€æ•°å­—å’Œæ±‰å­—",display:"ä½ çš„ID"},alert:{invalidRoom:"æˆ¿é—´åä¸åˆæ³•",newUser:"æ–°ç”¨æˆ·å·²è¿æ¥: {{name}}",transferCancelled:"å¯¹æ–¹å–æ¶ˆäº†ä¼ è¾“ï¼",chunkMissing:"æ–‡ä»¶ä¼ è¾“ç¼ºå°‘åˆ‡ç‰‡ {{index}}ï¼Œè¯·é‡æ–°ä¼ è¾“ï¼",unzipping:"è§£å‹ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...",fileReceived:"æˆåŠŸæ¥å—æ¥è‡ª {{name}} çš„æ–‡ä»¶ï¼",disconnected:"ä¸å¯¹æ–¹æ–­å¼€è¿æ¥ï¼Œè¯·ç­‰å¾…æˆ–åˆ·æ–°é¡µé¢",proxy:"æ£€æµ‹åˆ°è™šæ‹ŸIPï¼Œè¯·ä¸è¦ä½¿ç”¨ä»£ç†æˆ–VPNï¼Œå¦åˆ™å¯èƒ½æ— æ³•è¿æ¥ï¼"}}},ms:De,id:De},tn=f.get("userLanguage"),Ee=tn??"system",Pe=()=>{if(Ee==="system"){const a=navigator.language.toLowerCase();return a.startsWith("zh")?"zh":a.startsWith("ms")?"ms":a.startsWith("id")?"id":"en"}return Ee};ee.use(Kt).use(Ht).init({resources:en,lng:Pe(),fallbackLng:{id:["ms"],default:["en"]},interpolation:{escapeValue:!1},detection:{order:[],caches:[]}}).then(()=>{document.title=ee.t("meta.title"),document.documentElement.lang=Pe()});class nn{constructor(e,t,s,r,i){this.getServerUrl=e,this.getAuthToken=t,this.getUserId=s,this.validateRoom=r,this.onError=i}socket=null;messageHandler=null;currentRoomId=null;myId=null;async connect(e){const t=this.validateRoom(e);if(!t.isValid)return this.onError(t.message||"æˆ¿é—´åæ— æ•ˆ"),!1;try{const s=this.getServerUrl(),r=this.getAuthToken(),i=this.getUserId();let o=`${s}?token=${encodeURIComponent(r)}`;return i&&(o+=`&userId=${encodeURIComponent(i)}`),this.socket=new WebSocket(o),new Promise(d=>{this.socket.onopen=()=>{console.log("âœ… å·²è¿æ¥è‡ªå®šä¹‰æœåŠ¡å™¨"),this.subscribeToRoom(e),d(!0)},this.socket.onmessage=c=>{this.handleServerMessage(c)},this.socket.onclose=()=>{console.warn("ğŸ”Œ è‡ªå®šä¹‰æœåŠ¡å™¨è¿æ¥æ–­å¼€")},this.socket.onerror=c=>{console.error("è‡ªå®šä¹‰æœåŠ¡å™¨è¿æ¥é”™è¯¯:",c),this.onError("è¿æ¥è‡ªå®šä¹‰æœåŠ¡å™¨å¤±è´¥"),d(!1)}})}catch(s){return console.error("âŒ è‡ªå®šä¹‰æœåŠ¡å™¨è¿æ¥å¤±è´¥:",s),this.onError("è¿æ¥å¤±è´¥"),!1}}async disconnect(e){this.socket&&(this.currentRoomId&&this.sendToServer({type:"unsubscribe",channel:this.currentRoomId}),this.socket.close(),this.socket=null)}broadcastSignal(e){if(!this.socket||this.socket.readyState!==WebSocket.OPEN||!this.currentRoomId)return;const t={...e,from:this.getUserId()};e.to?this.sendToServer({type:"publish",channel:this.currentRoomId,event:`signal:${e.to}`,data:t}):this.sendToServer({type:"publish",channel:this.currentRoomId,event:"signal:all",data:t})}setMessageHandler(e){this.messageHandler=e}isConnected(){return this.socket!==null&&this.socket.readyState===WebSocket.OPEN}async switchRoom(e){const t=this.validateRoom(e);if(!t.isValid){this.onError(t.message||"æˆ¿é—´åæ— æ•ˆ");return}this.currentRoomId!==e&&(this.isConnected()?(this.currentRoomId&&(this.sendToServer({type:"unsubscribe",channel:this.currentRoomId}),console.log(`[C]ç¦»å¼€æ—§æˆ¿é—´: ${this.currentRoomId}`)),this.subscribeToRoom(e)):await this.connect(e))}subscribeToRoom(e){!this.socket||this.socket.readyState!==WebSocket.OPEN||(this.currentRoomId=e,this.myId=this.getUserId(),this.myId&&(this.sendToServer({type:"subscribe",channel:e,event:`signal:${this.myId}`}),this.sendToServer({type:"subscribe",channel:e,event:"signal:all"})),console.log(`[C]å·²åŠ å…¥æˆ¿é—´: ${e}`))}handleServerMessage(e){try{const t=JSON.parse(e.data);switch(t.type){case"message":this.messageHandler&&t.data&&this.messageHandler({data:JSON.stringify(t.data)});break;case"subscribed":console.log(`âœ… å·²è®¢é˜…: ${t.channel}${t.event?`:${t.event}`:""}`);break;case"unsubscribed":console.log(`âŒ å·²å–æ¶ˆè®¢é˜…: ${t.channel}${t.event?`:${t.event}`:""}`);break;case"error":console.error("æœåŠ¡å™¨é”™è¯¯:",t.error),this.onError(t.error||"æœåŠ¡å™¨é”™è¯¯");break;default:console.warn("æœªçŸ¥çš„æœåŠ¡å™¨æ¶ˆæ¯ç±»å‹:",t.type)}}catch(t){console.error("è§£ææœåŠ¡å™¨æ¶ˆæ¯å¤±è´¥:",t)}}sendToServer(e){this.socket&&this.socket.readyState===WebSocket.OPEN&&this.socket.send(JSON.stringify(e))}}function sn(a){return new nn(a.getServerUrl,a.getAuthToken,a.getUserId,a.validateRoom,a.onError)}class rn{constructor(e,t,s,r){this.getAblyKey=e,this.getUserId=t,this.validateRoom=s,this.onError=r}ably=null;ablyChannel=null;messageHandler=null;currentRoomId=null;myId=null;async connect(e){const t=this.validateRoom(e);if(!t.isValid)return this.onError(t.message||"æˆ¿é—´åæ— æ•ˆ"),!1;try{if(this.ably){const s=this.ably.connection.state;if(s==="closed"||s==="disconnected"||s==="suspended")console.log(`å½“å‰è¿æ¥çŠ¶æ€ä¸º ${s}ï¼Œå°è¯•é‡æ–°è¿æ¥ Ably...`),this.ably.connection.connect(),await this.ably.connection.whenState("connected");else if(s==="connecting")await this.ably.connection.whenState("connected");else if(s==="connected")return this.currentRoomId!==e&&this.subscribeToRoom(e),!0}else{const s=(await Ne(async()=>{const{default:r}=await import("./ably-Da9rdPj7.js").then(i=>i.a);return{default:r}},__vite__mapDeps([0,1]),import.meta.url)).default;this.ably=new s.Realtime({key:this.getAblyKey()}),await new Promise((r,i)=>{this.ably.connection.once("connected",r),this.ably.connection.once("failed",i)})}return this.subscribeToRoom(e),!0}catch(s){return console.error("Ablyè¿æ¥å¤±è´¥:",s),!1}}async disconnect(e){this.ablyChannel?.unsubscribe(),this.ablyChannel=null,this.ably&&(e?this.ably.connection.close():(this.ably.connection.close(),this.ably=null))}broadcastSignal(e){const t={...e,from:this.getUserId()};this.ablyChannel&&(e.to?this.ablyChannel.publish(`signal:${e.to}`,t):this.ablyChannel.publish("signal:all",t))}setMessageHandler(e){this.messageHandler=e}isConnected(){return this.ably&&this.ably.connection.state==="connected"}async switchRoom(e){const t=this.validateRoom(e);if(!t.isValid){this.onError(t.message||"æˆ¿é—´åæ— æ•ˆ");return}!this.ably||this.ably.connection.state!=="connected"?await this.connect(e):this.subscribeToRoom(e)}subscribeToRoom(e){this.ably&&(this.ablyChannel&&(this.ablyChannel.unsubscribe(),console.log(`[A]ç¦»å¼€æ—§æˆ¿é—´: ${this.currentRoomId}`)),this.ablyChannel=this.ably.channels.get(e),this.currentRoomId=e,this.myId=this.getUserId(),this.ablyChannel.subscribe(`signal:${this.myId}`,t=>{this.messageHandler&&this.messageHandler({data:JSON.stringify(t.data)})}),this.ablyChannel.subscribe("signal:all",t=>{this.messageHandler&&this.messageHandler({data:JSON.stringify(t.data)})}))}}class Fe{static async createTransport(e,t){switch(e){case"ably":if(!t.getAblyKey)throw new Error("Ably transport requires getAblyKey function");return new rn(t.getAblyKey,t.getUserId,t.validateRoom,t.onError);case"custom":if(!t.getServerUrl||!t.getAuthToken)throw new Error("Custom transport requires getServerUrl and getAuthToken functions");return sn({getServerUrl:t.getServerUrl,getAuthToken:t.getAuthToken,getUserId:t.getUserId,validateRoom:t.validateRoom,onError:t.onError});default:throw new Error(`Unknown transport type: ${e}`)}}}const ae={ably:{type:"ably",name:"Ably äº‘æœåŠ¡",description:"ä½¿ç”¨ Ably äº‘æœåŠ¡è¿›è¡Œå®æ—¶é€šä¿¡",isConfigured:()=>!!f.get("ablyKey"),createTransport:a=>Fe.createTransport("ably",{getAblyKey:()=>f.get("ablyKey")||"",getUserId:a,validateRoom:te,onError:e=>{y(e,2e3,{kind:"error"}),f.updateUnrmb("settingsPageState",!0)}})},custom:{type:"custom",name:"è‡ªå®šä¹‰æœåŠ¡å™¨",description:"ä½¿ç”¨è‡ªå®šä¹‰åç«¯æœåŠ¡å™¨",isConfigured:()=>!!f.get("customServerUrl"),createTransport:a=>Fe.createTransport("custom",{getServerUrl:()=>f.get("customServerUrl")||f.get("backupBackWsUrl")||"",getAuthToken:()=>f.get("customAuthToken")||"",getUserId:a,validateRoom:te,onError:e=>y(e,2e3,{kind:"error"})})}};class Z{static ablyRetryCount=0;static maxAblyRetries=1;static getTransportByPriority(){switch(f.get("serverMode")){case"ably":return"ably";case"custom":return"custom";case"auto":default:return this.ablyRetryCount<=this.maxAblyRetries&&ae.ably.isConfigured()?"ably":ae.custom.isConfigured()?"custom":"ably"}}static async createTransport(e,t){const s=t||this.getTransportByPriority(),r=ae[s];return console.log(`ğŸš€ åˆ›å»ºä¼ è¾“å±‚: ${r.name} (æ¨¡å¼: ${f.get("serverMode")})`),await r.createTransport(e)}static recordAblyFailure(){this.ablyRetryCount++,console.warn(`âš ï¸ Ably è¿æ¥å¤±è´¥ï¼Œé‡è¯•æ¬¡æ•°: ${this.ablyRetryCount}/${this.maxAblyRetries}`)}static resetAblyRetryCount(){this.ablyRetryCount=0}static shouldSwitchToBackup(){return f.get("serverMode")==="auto"&&this.ablyRetryCount>this.maxAblyRetries}static getAvailableTransports(){return Object.values(ae).filter(e=>e.isConfigured())}static getTransportStatus(){return{currentMode:f.get("serverMode"),ablyRetries:this.ablyRetryCount,maxRetries:this.maxAblyRetries,availableTransports:this.getAvailableTransports().map(e=>e.name)}}}const W=ee.t;class b{static instance=null;static userId=null;static uniqId=null;static peers=new Map;staticIp=null;constructor(){const e=this.getStatesMemorable();let t=e.memorable.userId,s=e.memorable.uniqId;this.peerManager=new Se(this),t||(t=this.generateUUID(),this.changeStatesMemorable({memorable:{userId:t}})),s||(s=`${t}:${this.generateUUID()}`,this.changeStatesMemorable({memorable:{uniqId:s}})),b.userId=t,b.uniqId=s,this.initializeSignalTransport()}signalTransport=null;userList=new Map;dataChannels=new Map;receivingFiles=new Map;receivedFiles=new Map;lastPingTimes=new Map;lastPongTimes=new Map;heartbeatIntervals=new Map;timeoutHandles=new Set;connectionQueue=new Map;pendingOffers=new Set;negotiationMap=new Map;pingFailures=new Map;pongFailures=new Map;recentlyResetPeers=new Map;lastConnectAttempt=new Map;connectionTimeouts=new Map;isSendingFile=!1;fileMetaInfo={name:"default_received_file"};coolingTime=2e3;cleaningLock=!1;setFileTransferProgress=()=>{};setDownloadPageState=()=>{};setMsgFromSharing=()=>{};updateConnectedUsers=()=>{};setFileSendingTargetUser=()=>{};peerManager;transferConfig={chunkSize:32*1024,maxConcurrentReads:10,bufferThreshold:256*1024};aborted=!1;initTransferConfig(){const e=X();e==="apple"||e==="android"?this.transferConfig={chunkSize:4*32*1024,maxConcurrentReads:8,bufferThreshold:128*1024}:this.transferConfig={chunkSize:32*1024,maxConcurrentReads:8,bufferThreshold:256*1024}}async init(e,t,s,r=()=>{},i){this.setFileSendingTargetUser=e,this.setMsgFromSharing=t,this.setDownloadPageState=s,this.updateConnectedUsers=r,this.setFileTransferProgress=i,this.initTransferConfig(),this.setupVisibilityWatcher(),setInterval(async()=>{for(const[o,d]of this.userList.entries())if(d.status==="waiting"){if(d.attempts>=3){console.warn(`[USER CHECK] ${o} é‡è¯•æ¬¡æ•°è¿‡å¤šï¼Œæ ‡è®°ä¸º disconnected`),d.status="disconnected",this.userList.set(o,d),this.updateUI();continue}try{await this.connectToUser(o),d.status="connecting",d.attempts+=1,this.userList.set(o,d)}catch(c){console.error(`[USER CHECK] è¿æ¥ ${o} å¤±è´¥:`,c)}}},4e3)}async initializeSignalTransport(){try{this.signalTransport=await Z.createTransport(()=>this.getUniqId()),this.signalTransport.setMessageHandler(e=>{this.handleSignal(e)})}catch(e){console.error("åˆå§‹åŒ–ä¿¡å·ä¼ è¾“å±‚å¤±è´¥:",e)}}async connectToServer(){if(!this.signalTransport&&(console.log("ç­‰å¾…ä¿¡å·ä¼ è¾“å±‚åˆå§‹åŒ–..."),await this.initializeSignalTransport(),!this.signalTransport))return console.error("ä¿¡å·ä¼ è¾“å±‚åˆå§‹åŒ–å¤±è´¥"),!1;this.staticIp=await $t();const e=f.get("roomId");if(!te(e).isValid)return f.updateUnrmb("settingsPageState",!0),!1;try{return await this.signalTransport.connect(e)?(Z.resetAblyRetryCount(),!0):await this.handleConnectionFailure(e)}catch(t){return console.error("è¿æ¥å¤±è´¥:",t),await this.handleConnectionFailure(e)}}async handleConnectionFailure(e){const t=f.get("serverMode");if(t==="auto"&&Z.getTransportByPriority()==="ably"&&(Z.recordAblyFailure(),Z.shouldSwitchToBackup())){console.log("ğŸ”„ Ablyé‡è¯•æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œåˆ‡æ¢åˆ°è‡ªå®šä¹‰æœåŠ¡å™¨"),y("Ablyè¿æ¥å¤±è´¥ï¼Œåˆ‡æ¢åˆ°è‡ªå®šä¹‰æœåŠ¡å™¨",2e3,{kind:"warning"}),await this.signalTransport?.disconnect(),this.signalTransport=await Z.createTransport(()=>this.getUniqId()),this.signalTransport.setMessageHandler(r=>{this.handleSignal(r)});try{if(await this.signalTransport.connect(e))return console.log("âœ… å·²åˆ‡æ¢åˆ°è‡ªå®šä¹‰æœåŠ¡å™¨"),!0}catch(r){console.error("è‡ªå®šä¹‰æœåŠ¡å™¨è¿æ¥ä¹Ÿå¤±è´¥:",r)}}switch(t){case"ably":y("Ablyè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é…ç½®",2e3,{kind:"error"});break;case"custom":y("è‡ªå®šä¹‰æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€",2e3,{kind:"error"});break;case"auto":y("æ‰€æœ‰æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥",2e3,{kind:"error"});break}return!1}async disconnect(e){this.signalTransport&&await this.signalTransport.disconnect(e)}async handleRename(){const e=f.get("roomId"),t=te(e);if(!t.isValid){y(t.message||W("alert.invalidRoom"),2e3,{kind:"error"});return}if((!this.signalTransport||!this.signalTransport.isConnected())&&(console.log("æœªè¿æ¥åˆ°ä¿¡å·æœåŠ¡å™¨ï¼Œå°è¯•è¿æ¥..."),await this.connectToServer()),!this.signalTransport||!this.signalTransport.isConnected()){y("æ— æ³•è¿æ¥æœåŠ¡å™¨ï¼Œä½ ä¸«åœ¨åœ°çƒå—",2e3,{kind:"error"});return}await this.signalTransport.switchRoom(e),this.broadcastSignal({type:"discover",userType:X()})}broadcastSignal(e){this.signalTransport&&this.signalTransport.broadcastSignal(e)}getStatesMemorable(){const e=localStorage.getItem("memorableState");if(!e)return{memorable:{userId:null,uniqId:null}};try{const t=JSON.parse(e);return{memorable:{userId:t.memorable?.userId??null,uniqId:t.memorable?.uniqId??null}}}catch{return localStorage.removeItem("memorableState"),{memorable:{userId:null,uniqId:null}}}}changeStatesMemorable(e){const t=this.getStatesMemorable().memorable,s={userId:e.memorable.userId??t.userId,uniqId:e.memorable.uniqId??t.uniqId};localStorage.setItem("memorableState",JSON.stringify({memorable:s}))}getUniqId(){return b.uniqId}getUserId(){return b.userId}setUserId(e){if(b.userId!=e){b.userId=e,this.changeStatesMemorable({memorable:{userId:e}});const t=`${e}:${this.generateUUID()}`;b.uniqId=t,this.changeStatesMemorable({memorable:{uniqId:t}})}}setUniqId(e){b.uniqId=e,this.changeStatesMemorable({memorable:{uniqId:e}})}static getInstance(){return b.instance||(b.instance=new b),b.instance}cleanUpConnections(){console.warn("ğŸ”Œ ä¿¡å·æœåŠ¡å™¨æ–­å¼€è¿æ¥ï¼Œæ¸…ç†çŠ¶æ€ã€‚"),this.signalTransport&&this.signalTransport.disconnect()}async handleSignal(e){try{const t=JSON.parse(e.data);if(!t)return;switch(t.type){case"discover":await this.handleDiscover(t);break;case"offer":await this.handleOffer(t);break;case"answer":await this.handleAnswer(t);break;case"candidate":await this.handleCandidate(t);break;default:console.warn("Unknown message type",t.type)}}catch(t){console.error("ğŸš¨ Failed to parse signal message:",e.data,t)}}async handleDiscover(e){const t=e.from,s=e.isReply;if(!t||t===this.getUniqId())return;const r=Date.now(),i=this.userList.get(t);if(!i)this.userList.set(t,{status:"waiting",attempts:0,lastSeen:r,userType:e.userType});else if(i.lastSeen=r,i.status==="disconnected"&&(i.attempts=0,i.status="waiting"),i.status==="waiting"||i.status==="connecting"||i.status==="connected")return;if(s||this.broadcastSignal({type:"discover",to:t,isReply:!0,userType:X()}),He(this.getUniqId(),t)){const o=this.userList.get(t);if(o.status==="waiting")try{await this.connectToUser(t),o.attempts=0}catch{console.warn("å‘é€é”™è¯¯"),o.attempts++,o.attempts>=10&&(o.status="disconnected")}else if(o.status==="connecting")return}this.updateUI()}clearCache(e){console.warn(`ğŸ§¹ æ¸…ç†è¿æ¥ç›¸å…³çŠ¶æ€ï¼š${e}`);const t=b.peers.get(e);t&&(t.close(),b.peers.delete(e));const s=this.dataChannels.get(e);s&&(s.close(),this.dataChannels.delete(e)),this.negotiationMap.delete(e),this.pendingOffers.delete(e),this.connectionQueue.delete(e);const r=this.heartbeatIntervals.get(e);r&&(clearInterval(r),this.heartbeatIntervals.delete(e));const i=this.connectionTimeouts.get(e);i&&(clearTimeout(i),this.connectionTimeouts.delete(e)),this.lastPingTimes.delete(e),this.lastPongTimes.delete(e),this.pingFailures.delete(e),this.pongFailures.delete(e),this.recentlyResetPeers.delete(e)}async handleOffer(e){const t=e.from;b.peers.has(t)||this.peerManager.createPeerConnection(t),this.negotiationMap.get(t).queue.push({type:"offer",sdp:e.offer}),this.processNegotiationQueue(t)}async processNegotiationQueue(e){if(!b.peers.get(e))return;const s=this.negotiationMap.get(e);if(s&&!s.isNegotiating){s.isNegotiating=!0;try{for(;s.queue.length>0;){const r=s.queue.shift();r.type==="offer"?await this.doHandleOffer(e,r.sdp):r.type==="answer"&&await this.doHandleAnswer(e,r.sdp)}}finally{s.isNegotiating=!1}}}async doHandleOffer(e,t){const s=b.peers.get(e);if(!s)return;const r=this.getUniqId()>e;if(s.signalingState==="have-local-offer"||s.signalingState==="have-local-pranswer")if(r){const c=Date.now(),p=this.recentlyResetPeers.get(e)??0;if(c-p<5e3){console.warn(`[OFFER] æœ€è¿‘åˆš reset è¿‡ ${e}ï¼Œè·³è¿‡`);return}console.warn(`[OFFER] Polite peer, resetting connection with ${e}`),this.recentlyResetPeers.set(e,c),s.close(),b.peers.delete(e);const u=this.peerManager.createPeerConnection(e);b.peers.set(e,u);const x=this.negotiationMap.get(e);x&&(x.queue.unshift({type:"offer",sdp:t}),this.processNegotiationQueue(e));return}else{console.warn("[OFFER] Impolite peer, ignoring incoming offer");return}await s.setRemoteDescription(new RTCSessionDescription(t));const o=await s.createAnswer();await s.setLocalDescription(o),this.broadcastSignal({type:"answer",answer:s.localDescription,to:e});const d=this.candidateCache.get(e);d&&d.length>0&&(await this.handleCandidate({from:e,candidates:d}),this.candidateCache.delete(e))}async handleAnswer(e){const t=e.from;if(!b.peers.has(t))return;const s=this.negotiationMap.get(t);s&&(s.queue.push({type:"answer",sdp:e.answer}),this.processNegotiationQueue(t))}async doHandleAnswer(e,t){const s=b.peers.get(e);if(!s)return;if(s.signalingState!=="have-local-offer"){console.warn(`Ignore answer from ${e}, because local signalingState=${s.signalingState}`);return}await s.setRemoteDescription(new RTCSessionDescription(t));const r=this.candidateCache.get(e);r&&r.length>0&&(await this.handleCandidate({from:e,candidates:r}),this.candidateCache.delete(e))}candidateCache=new Map;processedCandidates=new Map;async handleCandidate(e){const t=b.peers.get(e.from),s=e.from;if(!t){console.warn(`[ICE] âŒ æ—  peerï¼Œè·³è¿‡ ${s}`);return}if(!t.remoteDescription){console.warn("[ICE] âš ï¸ remoteDescription å°šæœªè®¾ç½®ï¼Œç¼“å­˜å€™é€‰");const i=this.candidateCache.get(s)||[];this.candidateCache.set(s,i.concat(e.candidates||[]));return}const r=this.processedCandidates.get(s)||new Set;this.processedCandidates.set(s,r);for(const i of e.candidates||[]){const o=JSON.stringify(i);if(r.has(o)){console.log("[ICE] ğŸ” è·³è¿‡é‡å¤å€™é€‰");continue}try{await t.addIceCandidate(new RTCIceCandidate(i)),r.add(o)}catch(d){console.error("Error adding ICE candidate:",d)}}}getAllUsers(){return Array.from(this.userList.keys())}setupDataChannel(e,t){e.binaryType="arraybuffer",this.dataChannels.set(t,e),e.onopen=()=>{f.update("isNewUser",!1);const s=this.connectionTimeouts.get(t);s&&(clearTimeout(s),this.connectionTimeouts.delete(t));let r=this.userList.get(t);r||(console.warn("âš ï¸ user ä¸å­˜åœ¨ï¼Œåœ¨é€šé“æ‰“å¼€æ—¶è‡ªåŠ¨æ·»åŠ :",t),r={status:"connected",attempts:0,lastSeen:Date.now(),userType:"desktop"},this.userList.set(t,r)),y(W("alert.newUser",{name:t.split(":")[0]}),2e3,{kind:"success"}),this.updateUI(),this.heartbeatIntervals.has(t)&&(clearInterval(this.heartbeatIntervals.get(t)),this.heartbeatIntervals.delete(t));const i=setInterval(()=>{e.readyState==="open"&&e.send(JSON.stringify({type:"ping"}))},3e3);this.heartbeatIntervals.set(t,i)},this.receivingFiles||(this.receivingFiles=new Map),e.onmessage=async s=>{if(typeof s.data=="string"){const r=JSON.parse(s.data);switch(r.type){case"file-meta":this.receivingFiles.set(t,{name:r.name,size:r.size,totalChunks:Math.ceil(r.size/r.chunkSize),chunks:new Array(Math.ceil(r.size/r.chunkSize)),chunkSize:r.chunkSize,receivedSize:0,receivedChunkCount:0}),I.fileMetaInfo.name=r.name,this.setDownloadPageState(!0);break;case"abort":I.abortFileTransferToUser?.(),this.setFileTransferProgress(null),this.setDownloadPageState(!1),y(W("alert.transferCancelled"),2e3,{kind:"error"});break;case"ping":this.lastPingTimes.set(t,Date.now()),this.pongFailures.set(t,0),e.readyState==="open"&&e.send(JSON.stringify({type:"pong"}));break;case"pong":this.lastPongTimes.set(t,Date.now());const i=this.userList.get(t);i&&(i.status="connected",this.userList.set(t,i)),this.pingFailures.set(t,0),this.updateUI();break;case"text":default:this.setMsgFromSharing(r.msg);break}}else{const r=s.data,i=8;if(r.byteLength<i){console.error("æ¥æ”¶åˆ°çš„äºŒè¿›åˆ¶æ•°æ®å¤ªå°");return}const o=new DataView(r),d=o.getUint32(0),c=o.getUint32(4),p=r.slice(i);if(p.byteLength!==c){console.error(`åˆ‡ç‰‡ ${d} é•¿åº¦ä¸åŒ¹é…ï¼šåº”ä¸º ${c}ï¼Œå®é™…ä¸º ${p.byteLength}`);return}const u=this.receivingFiles.get(t);if(!u){console.error("å°šæœªæ”¶åˆ°æ–‡ä»¶å…ƒæ•°æ®ï¼Œæ— æ³•å¤„ç†åˆ‡ç‰‡");return}if(u.chunks[d]||(u.chunks[d]=p,u.receivedSize+=p.byteLength,u.receivedChunkCount++),u.receivedChunkCount===u.totalChunks){const x=[];for(let v=0;v<u.totalChunks;v++){if(!u.chunks[v]){y(W("alert.chunkMissing",{index:v}),1e3,{kind:"error"}),console.error(`ç¼ºå°‘åˆ‡ç‰‡ ${v}`),this.receivingFiles.delete(t);return}x.push(u.chunks[v])}const S=new Blob(x),k=new File([S],u.name,{type:"application/octet-stream"});this.receivedFiles.set(t+"::"+k.name,k);const C=Array.from(this.receivedFiles.entries()).filter(([v,U])=>U.name.startsWith("LetShare_")&&U.name.endsWith(".zip"));C&&y(W("alert.unzipping"),2e3,{kind:"info"});for(const[v,U]of C)try{const P=await we.loadAsync(U),[D]=v.split("::");for(const[E,Q]of Object.entries(P.files))if(!Q.dir){const B=await Q.async("blob"),w=new File([B],E),m=`${D}::${E}`;this.receivedFiles.set(m,w)}this.receivedFiles.delete(v)}catch(P){console.error("è§£å‹å¤±è´¥:",P)}y(W("alert.fileReceived",{name:t.split(":")[0]})),this.receivingFiles.delete(t)}}},e.onclose=()=>{console.warn(`ğŸ§¹ DataChannel closed for ${t}ï¼Œæ‰§è¡Œ clearCache(${t})`),this.clearCache(t),this.userList.delete(t),this.updateUI(),y(W("alert.disconnected"),2e3,{kind:"error"})},e.onerror=()=>{this.cleanupDataChannel(t)}}cleanupDataChannel(e){const t=this.dataChannels.get(e);t&&(t.close(),this.heartbeatIntervals.has(e)&&(clearInterval(this.heartbeatIntervals.get(e)),this.heartbeatIntervals.delete(e)),this.dataChannels.delete(e),this.userList.delete(e),this.lastPongTimes.delete(e),this.updateUI())}async connectToUser(e){const t=Date.now(),s=this.lastConnectAttempt.get(e)??0;if(t-s<4e3){console.warn(`[CONNECT] ä¸ ${e} çš„è¿æ¥å°è¯•å¤ªé¢‘ç¹ï¼Œè·³è¿‡`);return}if(this.lastConnectAttempt.set(e,t),this.connectionQueue.has(e)){console.warn(`[CONNECT] ${e} æ­£åœ¨è¿æ¥ä¸­ï¼Œè·³è¿‡`);return}this.connectionQueue.set(e,!0);try{let r=b.peers.get(e);if(r){const c=r.connectionState,p=this.dataChannels.get(e),u=["connected","connecting"].includes(c),x=p?.readyState==="open";if(u&&x){console.log(`[CONNECT] ${e} è¿æ¥æ­£å¸¸ (ICE: ${c}, Channel: open)`);return}console.warn(`[CONNECT] æ¸…ç† ${e} çš„æ—§è¿æ¥`,`ICE çŠ¶æ€: ${c}, é€šé“çŠ¶æ€: ${p?.readyState||"missing"}`),this.clearCache(e)}r=this.peerManager.createPeerConnection(e);const i=r.createDataChannel("chat");this.setupDataChannel(i,e);const o=await r.createOffer({iceRestart:!0});await r.setLocalDescription(o),console.log(`[CONNECT] âœ… å‘ ${e} å‘é€ offer`),this.broadcastSignal({type:"offer",offer:r.localDescription,to:e});const d=window.setTimeout(()=>{const c=b.peers.get(e);this.userList.get(e)?.status!="connected"&&c&&c.iceConnectionState!=="connected"&&c.iceConnectionState!=="checking"?(console.warn(`[CONNECT] â° ${e} è¿æ¥é•¿æ—¶é—´æœªå»ºç«‹ï¼Œå¼ºåˆ¶å…³é—­`),this.clearCache(e),this.userList.delete(e),this.updateUI()):console.log(`[CONNECT] ${e} æ­£åœ¨è¿æ¥ä¸­ï¼Œå»¶é•¿ç­‰å¾… çŠ¶æ€`),this.connectionTimeouts.delete(e)},3e3);this.connectionTimeouts.set(e,d)}catch(r){console.error(`[CONNECT] âŒ è¿æ¥ ${e} å¤±è´¥:`,r)}finally{this.connectionQueue.delete(e),this.pendingOffers.delete(e)}}updateUI(){this.updateConnectedUsers(this.userList)}async sendMessageToUser(e,t){const s=this.dataChannels.get(e);if(s?.readyState==="open"){s.send(JSON.stringify({msg:t,type:"text"}));return}console.warn(`Channel not open with user ${e}. Attempting reconnection...`)}abortFileTransferToUser(){if(this.aborted=!0,this.isSendingFile=!1,this.timeoutHandles){for(const e of this.timeoutHandles)clearTimeout(e);this.timeoutHandles.clear()}}isConnectedToUser(e){const t=this.dataChannels.get(e);return!!t&&t.readyState==="open"}async sendFileToUser(e,t){const s=this.dataChannels.get(e);if(this.setFileSendingTargetUser(e),!s||s.readyState!=="open"){console.error(`Data channel with user ${e} is not available.`);return}const r=Math.ceil(t.size/this.transferConfig.chunkSize);let i=this.transferConfig.maxConcurrentReads,o=0,d=0;this.aborted=!1;const c=[],p={type:"file-meta",name:t.name,size:t.size,totalChunks:r,chunkSize:this.transferConfig.chunkSize};try{s.send(JSON.stringify(p)),console.log("ğŸ“¦ å·²å‘é€æ–‡ä»¶å…ƒæ•°æ®:",p)}catch(k){console.error("âŒ æ— æ³•å‘é€æ–‡ä»¶å…ƒæ•°æ®ï¼š",k);return}const u=k=>new Promise((C,v)=>{if(this.aborted)return v(new Error("è¯»å–ä¸­æ­¢"));const U=k*this.transferConfig.chunkSize,P=t.slice(U,U+this.transferConfig.chunkSize),D=new FileReader;D.onload=()=>{if(this.aborted)return v(new Error("è¯»å–ä¸­æ­¢"));D.result instanceof ArrayBuffer?C(D.result):v(new Error("è¯»å–ç»“æœä¸æ˜¯ ArrayBuffer"))},D.onerror=E=>v(E),D.readAsArrayBuffer(P)}),x=async k=>{if(!this.aborted)try{const C=await u(k);if(this.aborted)return;const v=8,U=new ArrayBuffer(v+C.byteLength),P=new DataView(U);P.setUint32(0,k),P.setUint32(4,C.byteLength),new Uint8Array(U,v).set(new Uint8Array(C));const D=()=>{if(!this.aborted)if(s.bufferedAmount<this.transferConfig.bufferThreshold){s.send(U),o++;const E=Math.min(o/r*100,100);this.setFileTransferProgress(E),E>=100&&(setTimeout(()=>this.setFileTransferProgress(null),1500),this.setDownloadPageState(!1)),this.isSendingFile=E<100&&E>0}else{const E=setTimeout(D,100);this.timeoutHandles.add(E)}};D()}catch(C){this.aborted||console.error(`åˆ‡ç‰‡ ${k} å‘é€å¤±è´¥:`,C)}};await(async()=>{for(;d<r&&!this.aborted;){c.length>=i&&await Promise.race(c);const k=d++,C=x(k);c.push(C),C.finally(()=>{const v=c.indexOf(C);v>-1&&c.splice(v,1)})}})(),await Promise.allSettled(c),this.aborted?console.warn("ğŸš« æ–‡ä»¶å‘é€è¢«ä¸­æ­¢"):console.log("âœ… æ–‡ä»¶å‘é€å®Œæˆ")}generateUUID(){return Math.random().toString(36).substring(2,8)}isConnected(){return this.signalTransport?this.signalTransport.isConnected():!1}getConnectedUserIds(){return Array.from(this.userList.entries()).filter(([e,t])=>t.status==="connected").map(([e])=>e)}async waitForUnlock(e){const r=Date.now();for(;e;){if(Date.now()-r>1e4){console.warn("âš ï¸ ç­‰å¾… cleaningLock è§£é”è¶…æ—¶ï¼Œæ”¾å¼ƒ discover");return}await new Promise(i=>setTimeout(i,200))}}setupVisibilityWatcher(){let e=null,t=null;const s=3e4;document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?(e=Date.now(),t=setTimeout(()=>{const r=Date.now();e&&r-e>=s&&(y(`â± é¡µé¢åå°è¶…è¿‡${s}ç§’ï¼Œæ–­å¼€æœåŠ¡å™¨è¿æ¥èŠ‚æµ`,3e3),this.disconnect())},s)):document.visibilityState==="visible"&&(t&&(clearTimeout(t),t=null),this.isConnected())})}}const I=b.getInstance(),q=Qt.isNativePlatform();async function an(){try{if(q){const{value:a}=await Je.read();return a||""}else{if(navigator.clipboard&&typeof navigator.clipboard.readText=="function")return await navigator.clipboard.readText()||"";y("å½“å‰ç¯å¢ƒä¸æ”¯æŒè¯»å–å‰ªè´´æ¿",3e3,{kind:"warning"})}}catch(a){console.error("è¯»å–å‰ªè´´æ¿å¤±è´¥: ",a),y("è¯»å–å‰ªè´´æ¿å†…å®¹å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™æˆ–æ‰‹åŠ¨ç²˜è´´ã€‚",3e3,{kind:"error"})}return""}async function on(a){try{if(q)return await Je.write({string:a}),!0;if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function")if(await navigator.clipboard.writeText(a),typeof navigator.clipboard.readText=="function")try{const e=await navigator.clipboard.readText();if(e===a)return!0;console.warn("å‰ªè´´æ¿å†…å®¹éªŒè¯å¤±è´¥:",a,e)}catch(e){return console.warn("å‰ªè´´æ¿å†…å®¹éªŒè¯å¤±è´¥:",e),!0}else return!0;else y("å½“å‰ç¯å¢ƒä¸æ”¯æŒå¤åˆ¶åˆ°å‰ªè´´æ¿",3e3,{kind:"warning"})}catch(e){console.error("å¤åˆ¶å¤±è´¥:",e),y("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶æ–‡æœ¬ã€‚",3e3,{kind:"warning"})}return!1}const ln=[{key:"light",color:"#f5f5f5",label:"äº®è‰²"},{key:"dark",color:"#212121",label:"æš—è‰²"},{key:"blue",color:"#1976d2",label:"è“è‰²"},{key:"green",color:"#388e3c",label:"ç»¿è‰²"},{key:"sunset",color:"#f57c00",label:"æ—¥è½æ©™"},{key:"coolGray",color:"#90a4ae",label:"å†·ç°"}],cn=()=>{const a=f.get("userTheme")||"light",e=t=>{f.update("userTheme",t)};return n.jsx(g,{sx:{borderRadius:"50%",display:"flex",gap:1.3,justifyContent:"center",alignItems:"center",flexWrap:"wrap"},children:ln.map(t=>{const s=a===t.key;return n.jsx(lt,{title:t.label,arrow:!0,children:n.jsx("div",{tabIndex:0,onClick:()=>e(t.key),style:{width:24,height:24,borderRadius:"50%",backgroundColor:t.color,cursor:"pointer",marginLeft:s?8:0,marginRight:s?8:0,transform:s?"scale(1.4)":"scale(1)",boxShadow:s?"0 0 0 3px rgba(0,0,0,0.3)":"0 0 0 1px rgba(0,0,0,0.2)",transition:"transform 0.2s ease, margin 0.2s ease, box-shadow 0.2s ease",outline:"none",WebkitTapHighlightColor:"transparent"},onMouseEnter:r=>{r.currentTarget.style.transform=s?"scale(1.4)":"scale(1.2)"},onMouseLeave:r=>{r.currentTarget.style.transform=s?"scale(1.4)":"scale(1)"}})},t.key)})})},dn=()=>{const{t:a}=ne(),e=f.getAllSettings(),t=N.useRef(null),s=N.useRef(f.get("roomId")),r=(c,p)=>{f.update(c,p)},i=()=>{d()},o=c=>{const p=c.target.value;f.update("userLanguage",p);const x=(S=>{if(S==="system"){const k=navigator.language.toLowerCase();return k.startsWith("zh")?"zh":k.startsWith("ms")?"ms":k.startsWith("id")?"id":"en"}return S})(p);ee.changeLanguage(x).then(()=>{document.title=ee.t("meta.title")}),console.log("Language changed to:",p)},d=async()=>{const c=f.get("roomId");s.current!==c&&(await I.handleRename(),y(`${a("settings.joinSuccess")}: "${c}"`),s.current=c);const p=f.get("roomId");let u=te(p);u.isValid?f.updateUnrmb("settingsPageState",!1):y(u.message,2e3,{kind:"error"})};return N.useEffect(()=>{const c=p=>{p.key==="Enter"&&f.getUnrmb("settingsPageState")&&(p.preventDefault(),i())};return window.addEventListener("keydown",c),()=>{window.removeEventListener("keydown",c)}},[]),n.jsx(oe,{onClose:d,open:f.getUnrmb("settingsPageState")??!1,PaperProps:{sx:{borderRadius:3,bgcolor:"background.paper",overflow:"hidden"}},children:n.jsxs(g,{ref:t,sx:{maxWidth:330,mx:"auto",px:4.3,py:4,bgcolor:"background.paper",borderRadius:3,boxShadow:3,display:"flex",flexDirection:"column",gap:3},children:[n.jsx(T,{variant:"h6",gutterBottom:!0,children:a("settings.title")}),n.jsx(cn,{}),n.jsxs(ct,{fullWidth:!0,children:[n.jsx(dt,{children:"è¯­è¨€/Language"}),n.jsxs(ut,{value:f.get("userLanguage"),onChange:o,label:"è¯­è¨€/Language",sx:{minWidth:140,mt:0},children:[n.jsx(K,{value:"system",children:"System"}),n.jsx(K,{value:"zh",children:"ç®€ä½“ä¸­æ–‡"}),n.jsx(K,{value:"en",children:"English"}),n.jsx(K,{value:"ms",children:"Bahasa Melayu"}),n.jsx(K,{value:"id",children:"Bahasa Indonesia"})]})]}),n.jsx(H,{required:!0,label:a("settings.roomId.label"),fullWidth:!0,autoFocus:f.get("roomId")=="",variant:"outlined",value:e.roomId||"",onChange:c=>r("roomId",c.target.value),error:!e.roomId,inputProps:{maxLength:12},helperText:e.roomId?a("settings.roomId.helper"):a("settings.roomId.required")}),n.jsx(F,{onClick:i,variant:"contained",size:"large",sx:{mt:0},children:a("settings.saveButton")})]})})},un=We(dn);class hn{constructor(e){this.rtc=e}offerQRCodeString=null;localOffer=null;targetUserId=null;async generateOfferQr(e){this.targetUserId=e;let t=b.peers.get(e);if(!t){t=this.rtc.peerManager.createPeerConnection(e);const i=t.createDataChannel("chat");this.rtc.setupDataChannel(i,e)}const s=await t.createOffer();await t.setLocalDescription(s),this.localOffer=s;const r={from:this.rtc.getUniqId(),to:e,offer:s};this.offerQRCodeString=btoa(JSON.stringify(r))}async handleScannedOffer(e){const t=JSON.parse(atob(e)),{from:s,to:r,offer:i}=t;this.targetUserId=s;let o=b.peers.get(s);o||(o=this.rtc.peerManager.createPeerConnection(s),this.rtc.setupDataChannel(o.createDataChannel("chat"),s)),await o.setRemoteDescription(new RTCSessionDescription(i));const d=await o.createAnswer();return await o.setLocalDescription(d),btoa(JSON.stringify({from:r,to:s,answer:d}))}async handleScannedAnswer(e){const t=JSON.parse(atob(e)),{from:s,answer:r}=t;await this.rtc.doHandleAnswer(s,r)}}const gn=()=>{const{t:a}=ne(),[e,t]=h.useState(!1),s=()=>t(!0),r=()=>t(!1),i=ce(),o="https://bigonion.cn/shortlink",d="https://github.com/LiWeny16/LetShare",[c,p]=h.useState("share"),[u]=h.useState(()=>new hn(I));return h.useEffect(()=>{c==="connect"&&u.generateOfferQr("ä½ è¦è¿æ¥çš„ç”¨æˆ·id")},[c]),n.jsxs(n.Fragment,{children:[n.jsxs(g,{component:"footer",sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:1,borderTop:"1px solid #e0e0e0",borderBottom:"1px solid #e0e0e0",mb:"20px",mt:"auto"},children:[n.jsx(T,{variant:"body2",color:"text.secondary",children:"Â© 2025 LetShare Copyright Author Onion"}),n.jsxs(g,{sx:{display:"flex",alignItems:"center"},children:[n.jsx(he,{"aria-label":"GitHub",component:"a",href:d,target:"_blank",rel:"noopener noreferrer",children:n.jsx(ht,{})}),n.jsx(he,{"aria-label":"QR Code",onClick:s,children:n.jsx(gt,{})}),n.jsx(he,{onClick:()=>{f.updateUnrmb("settingsPageState",!0)},children:n.jsx(pt,{})})]})]}),n.jsx(oe,{open:e,onClose:r,PaperProps:{sx:{borderRadius:2,bgcolor:"background.paper",overflow:"hidden"}},children:n.jsxs(g,{sx:{minHeight:400,padding:1,bgcolor:"background.paper",borderRadius:2},children:[n.jsx(Le,{children:a("footer.shareTitle")}),n.jsx(Oe,{}),n.jsx(me,{sx:{display:"flex",justifyContent:"center",alignItems:"center",p:1.4,width:"300px",maxWidth:"100%"},children:c==="share"?n.jsxs(g,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[n.jsxs(T,{variant:"body1",color:"text.secondary",sx:{mb:1},children:[a("footer.qrPrompt"),n.jsx("br",{}),n.jsx("strong",{children:f.get("roomId")})]}),n.jsx(xe,{value:o,eyeRadius:1,size:150,bgColor:i.palette.background.paper,fgColor:i.palette.text.primary,ecLevel:"H",quietZone:10}),n.jsx(T,{variant:"body2",color:"primary",component:"a",href:o,target:"_blank",rel:"noopener noreferrer",sx:{mt:1,wordBreak:"break-word",textDecoration:"none"},children:"https://letshare.fun"})]}):n.jsxs(g,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[n.jsx(T,{variant:"body2",color:"text.secondary",sx:{mb:1},children:a("footer.qrScanPrompt")}),u.offerQRCodeString?n.jsx(xe,{value:u.offerQRCodeString,size:150,eyeRadius:1,bgColor:i.palette.background.paper,fgColor:i.palette.text.primary,ecLevel:"H",quietZone:10}):n.jsx(T,{variant:"caption",color:"text.disabled",children:"æ­£åœ¨ç”ŸæˆäºŒç»´ç ..."})]})})]})}),n.jsx(un,{})]})},pn=({onEditDone:a})=>{const{t:e}=ne(),[t,s]=h.useState(!1),[r,i]=h.useState(""),[o,d]=h.useState(!1),c=h.useRef("");h.useEffect(()=>{const S=I.getUserId();S&&(i(S),c.current=S)},[]);const p=/^[\u4e00-\u9fa5a-zA-Z0-9\u{1F000}-\u{1FFFF}]*$/u,u=S=>{const k=S.target.value;i(k),d(!p.test(k))},x=()=>{const S=r.trim();if(!p.test(S)||!S){i(c.current),d(!0),s(!1);return}I.setUserId(S),c.current=S,d(!1),s(!1),a&&a(S)};return n.jsx(n.Fragment,{children:t?n.jsx(H,{value:r,onChange:u,onBlur:x,onKeyDown:S=>{S.key==="Enter"&&x()},autoFocus:!0,variant:"standard",error:o,helperText:o?e("userId.inputError"):"",inputProps:{style:{textAlign:"center"},maxLength:12},sx:{mt:2,display:"block",mx:"auto"}}):n.jsxs(T,{variant:"body2",color:"textSecondary",align:"center",sx:{mt:2,cursor:"pointer"},onClick:()=>s(!0),children:[e("userId.display"),": ",r]})})},mn=({open:a})=>{const[e,t]=h.useState(!1);return n.jsx(fe,{in:a,timeout:600,unmountOnExit:!0,children:n.jsx(g,{sx:{width:"100vw",minHeight:"100vh",position:"fixed",top:0,left:0,display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",backgroundColor:s=>s.palette.background.default,color:"white",textAlign:"center",p:2,boxSizing:"border-box",zIndex:9999},children:n.jsxs(g,{sx:{mb:"200px",display:"flex",flexDirection:"column",alignItems:"center"},children:[n.jsx(g,{sx:{width:{xs:120,sm:160,md:200},height:{xs:120,sm:160,md:200},mb:3,display:"flex",justifyContent:"center",alignItems:"center"},children:n.jsx(fe,{in:e,timeout:600,children:n.jsx(g,{component:"img",src:"/icons/512x512_trans.png",alt:"Logo",onLoad:()=>t(!0),sx:{width:"100%",height:"100%",objectFit:"contain"}})})}),n.jsx(T,{variant:"h6",sx:{fontWeight:300,color:s=>s.palette.getContrastText(s.palette.background.default)},children:"Connect To The World"}),n.jsx(T,{variant:"subtitle1",sx:{opacity:.85,color:s=>s.palette.getContrastText(s.palette.background.default)},children:"è½»è§¦ï¼Œå¼€å¯é€šå¾€ä¸–ç•Œçš„å¤§é—¨"}),n.jsx(g,{mt:4,children:n.jsx(ye,{sx:{opacity:.85,color:s=>s.palette.getContrastText(s.palette.background.default)},color:"inherit"})})]})})})},fn=Yt("BinarySaver");async function Me(a){const e=await a.arrayBuffer(),t=new Uint8Array(e);await fn.saveBytes({fileName:a.name,mimeType:a.type,data:Array.from(t)})}function yn({open:a,progress:e,setProgress:t,onClose:s,targetUserId:r}){const{t:i}=ne(),o=ce(),[d,c]=N.useState(a),[p,u]=N.useReducer(w=>w+1,0);N.useEffect(()=>{a&&c(!0)},[a]),N.useEffect(()=>{const w=setInterval(()=>{u()},350);return()=>clearInterval(w)},[]);const x=()=>{c(!1),s()},S=I.receivingFiles,k=I.receivedFiles,C=Array.from(S.entries()),v=Array.from(k.entries()),U=async()=>{if(v.length===0)return;const w=new we;v.forEach(([m,R])=>{w.file(R.name,R)});try{const m=await w.generateAsync({type:"blob"}),R=`Received_${Date.now()}.zip`,L=new File([m],R,{type:"application/zip"});if(q)await Me(L),y(`${R} å·²æˆåŠŸä¿å­˜åˆ°è·¯å¾„: /Download/letshare/`,3e3,{kind:"success"});else{const se=URL.createObjectURL(L),M=document.createElement("a");M.href=se,M.download=R,document.body.appendChild(M),M.click(),document.body.removeChild(M),URL.revokeObjectURL(se)}}catch(m){console.error("æ‰“åŒ…ä¸‹è½½å¤±è´¥:",m),y("æ‰“åŒ…ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•ï¼",2e3,{kind:"error"})}},P=w=>{const m=I.dataChannels.get(w);m&&m.send(JSON.stringify({type:"abort"})),s(),y(`ç»ˆæ­¢æ¥è‡ª ${w.split(":")[0]} çš„æ¥æ”¶`,2e3,{kind:"error"}),S.delete(w),u(),S.size===0&&e===null&&c(!1)},D=()=>{s(),y("ç»ˆæ­¢å‘é€",2e3,{kind:"error"}),I.abortFileTransferToUser?.(),t(0),S.size===0&&c(!1)},E=w=>{const m=w.split(".").pop()?.toLowerCase();return m?["png","jpg","jpeg","gif","bmp","webp","svg"].includes(m)?n.jsx(ft,{fontSize:"medium"}):["mp4","mov","avi","mkv","webm"].includes(m)?n.jsx(yt,{fontSize:"medium"}):["zip","rar","7z","tar","gz","xz","bz2"].includes(m)?n.jsx(xt,{fontSize:"medium"}):m==="pdf"?n.jsx(bt,{fontSize:"medium"}):["doc","docx"].includes(m)?n.jsx(wt,{fontSize:"medium"}):["xls","xlsx","csv"].includes(m)?n.jsx(St,{fontSize:"medium"}):["ppt","pptx"].includes(m)?n.jsx(vt,{fontSize:"medium"}):["txt","md","rtf"].includes(m)?n.jsx(Ct,{fontSize:"medium"}):["js","ts","jsx","tsx","html","css","scss","py","java","c","cpp","cs","json","xml","yml","yaml","sh","bat","go","rs"].includes(m)?n.jsx(kt,{fontSize:"medium"}):n.jsx(Ie,{fontSize:"medium"}):n.jsx(Ie,{fontSize:"medium"})},Q=async w=>{if(q){await Me(w);const R=/\.(png|jpe?g|webp)$/i.test(w.name)?"/Pictures/letshare/":"/Download/letshare/";y(`${w.name} å·²æˆåŠŸä¿å­˜åˆ°è·¯å¾„: ${R}`,3e3,{kind:"success"})}else{const m=new Blob([w]),R=URL.createObjectURL(m),L=document.createElement("a");L.href=R,L.download=w.name,L.click(),URL.revokeObjectURL(R)}},B=e!==null||C.length>0||v.length>0;return!d&&!a?null:n.jsxs(n.Fragment,{children:[n.jsx(Be,{open:a,onClick:s,sx:{zIndex:o.zIndex.modal,backgroundColor:"rgba(0, 0, 0, 0.4)"}}),n.jsx(mt,{style:{userSelect:"none"},in:a,direction:"down",mountOnEnter:!0,unmountOnExit:!0,onExited:x,children:n.jsx(g,{onClick:w=>{w.target===w.currentTarget&&c(!1)},sx:{position:"fixed",top:0,left:0,width:"100%",display:"flex",justifyContent:"center",zIndex:o.zIndex.modal},children:n.jsxs(g,{className:"uniformed-scroller",sx:{width:{xs:"88%",sm:"80%",md:"60%",lg:"50%"},maxHeight:400,overflowY:"auto",backgroundColor:o.palette.background.paper,boxShadow:3,px:2,py:2,borderBottomLeftRadius:19,borderBottomRightRadius:19,display:"flex",flexDirection:"column",gap:2},children:[B&&n.jsxs(n.Fragment,{children:[e!==null&&n.jsxs(g,{sx:{display:"flex",flexDirection:"column",gap:1},children:[n.jsx(T,{variant:"body2",color:"text.secondary",children:n.jsx(le,{i18nKey:"transfer.sending",values:{name:r?.split(":")[0]??"æœªçŸ¥ç”¨æˆ·"},components:{strong:n.jsx("strong",{})}})}),n.jsxs(g,{sx:{display:"flex",alignItems:"center",gap:2},children:[n.jsxs(g,{sx:{flex:1},children:[n.jsxs(T,{variant:"caption",color:"text.secondary",children:[e.toFixed(1),"%"]}),n.jsx(ke,{variant:"determinate",value:e,sx:{height:8,borderRadius:5,mt:.5}})]}),n.jsx(F,{variant:"contained",color:"error",size:"small",onClick:D,sx:{whiteSpace:"nowrap",minWidth:64,...G},children:"å–æ¶ˆ"})]})]},"sending"),C.map(([w,m])=>{const R=m.size?m.receivedSize/m.size*100:0;return n.jsxs(g,{sx:{display:"flex",flexDirection:"column",gap:1},children:[n.jsx(T,{variant:"body2",color:"text.secondary",children:n.jsx(le,{i18nKey:"transfer.receiving",values:{name:w.split(":")[0],filename:m.name},components:{strong:n.jsx("strong",{})}})}),n.jsxs(g,{sx:{display:"flex",alignItems:"center",gap:2},children:[n.jsxs(g,{sx:{flex:1},children:[n.jsxs(T,{variant:"caption",color:"text.secondary",children:[R.toFixed(1),"%ï¼ˆ",m.receivedSize," / ",m.size,"   ",i("transfer.byte"),"ï¼‰"]}),n.jsx(ke,{variant:"determinate",value:R,sx:{height:8,borderRadius:5,mt:.5}})]}),n.jsx(F,{variant:"contained",color:"error",size:"small",onClick:()=>P(w),sx:{whiteSpace:"nowrap",minWidth:64,...G},children:"å–æ¶ˆ"})]})]},w)}),v.length>0&&n.jsxs(g,{children:[n.jsxs(g,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mt:2,mb:1},children:[n.jsx(T,{variant:"subtitle2",children:i("transfer.receivedFiles")}),n.jsx(F,{onClick:U,endIcon:n.jsx(Ve,{}),children:i("button.downloadAll")})]}),n.jsx(g,{sx:{display:"flex",flexDirection:"column",gap:1},children:v.map(([w,m])=>n.jsxs(g,{onClick:()=>Q(m),sx:{display:"flex",alignItems:"center",gap:1.5,px:2,py:1.5,borderRadius:2,boxShadow:1,cursor:"pointer",transition:"0.2s","&:hover":{boxShadow:3,backgroundColor:o.palette.action.hover}},children:[E(m.name),n.jsx(T,{variant:"body2",noWrap:!0,children:m.name})]},w))})]})]}),d&&!B&&n.jsx(g,{sx:{textAlign:"center",color:"gray",py:2},children:i("transfer.noTasks")})]})})})]})}const xn={position:"relative",padding:"10px",borderRadius:"8px",display:"flex",flexDirection:"column",mt:"10px",mb:"5px",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.1)",overflow:"hidden",cursor:"pointer"},ie={"& .MuiBadge-badge":{top:4,right:4}},G={borderRadius:"5px",borderColor:"#e0e0e0"};function bn(){const{t:a}=ne(),e=ce(),[t,s]=h.useState(null),[r,i]=h.useState(!1),[o,d]=h.useState([]),[c,p]=h.useState(!1),[u,x]=h.useState("clip"),[S,k]=h.useState(null),[C,v]=h.useState(null),[U,P]=h.useState(!1),[D,E]=h.useState(""),[Q,B]=h.useState(null),[w,m]=h.useState(!0),[R,L]=h.useState(!0),[se,M]=h.useState(!1),[ve,de]=N.useState(!1),[qe,Qe]=N.useState(""),Ye=h.useRef(null),Ce=h.useRef(null),Ze=l=>{switch(l){case"apple":return n.jsx(Nt,{sx:{transition:"color 0.3s ease"}});case"android":return n.jsx(zt,{sx:{transition:"color 0.3s ease"}});case"desktop":return n.jsx(Te,{sx:{transition:"color 0.3s ease"}});default:return n.jsx(Te,{sx:{transition:"color 0.3s ease"}})}},Ge=()=>{E(""),P(!0)},Xe=l=>{const j=Array.from(l.entries()).map(([A,z])=>{const[O,V]=A.split(":");return{uniqId:V?`${O}:${V}`:A,name:O||A,status:z.status,userType:z.userType}});d(j)},$e=async()=>{p(!0);try{I.isConnected()?I.broadcastSignal({type:"discover",userType:X()}):I.connectToServer().then(l=>{l&&I.broadcastSignal({type:"discover",userType:X()})}),await qt.sleep(1e3)}catch(l){console.error("Search error:",l)}finally{p(!1)}},_e=async l=>{x("image"),ue(l,!0)},ue=async(l,j)=>{const A=l.target.files;if(!(!A||A.length===0)){if(x(j?"image":"file"),A.length===1){const z=l.target.files?.[0]||null;z&&k(z);return}try{const z=new we;Array.from(A).forEach($=>{z.file($.name,$)});const O=await z.generateAsync({type:"blob"}),V=new File([O],`LetShare_${Date.now()}.zip`,{type:"application/zip"});k(V)}catch{y(a("toast.zipFailed"),2e3,{kind:"error"})}}},et=async(l,j)=>{try{if(!I.isConnectedToUser(j)){y(a("toast.connectingUser"),2e3,{kind:"warning"}),I.connectToUser(j);return}if((u==="file"||u==="image")&&S){if(I.isSendingFile){y(a("toast.taskInProgress"),2e3,{kind:"info"}),M(!0);return}M(!0),await I.sendFileToUser(j,S)}else if(u==="text"&&C)await I.sendMessageToUser(j,C);else if(u==="clip"){let A=await an();A!=""?await I.sendMessageToUser(j,A??"è¯»å–å‰ªåˆ‡æ¿å¤±è´¥"):y(a("toast.clipboardEmpty"),2e3,{kind:"info"})}else y(a("toast.noContentSelected"),2e3,{kind:"info"})}catch(A){console.error("å‘é€å¤±è´¥ï¼š",A)}};h.useEffect(()=>(I.connectToServer().then(l=>{l&&I.broadcastSignal({type:"discover",userType:X()})}),I.init(Qe,l=>{s(l),i(!0)},M,Xe,B),setTimeout(()=>{L(!1)},1e3),()=>{I.disconnect()}),[]),h.useEffect(()=>{const l=async j=>{if(U||r)return;const A=j.clipboardData;if(!A)return;const z=A.items;for(const V of z)if(V.kind==="file"){const $=V.getAsFile();if($){k($),x("file");return}}const O=A.getData("text/plain");O&&O.trim().length>0&&(v(O),x("text"))};return window.addEventListener("paste",l),m(!1),()=>{window.removeEventListener("paste",l)}},[U,r]);const tt=()=>{try{t&&(on(t),y(a("toast.copiedToClipboard"),2e3,{kind:"success"}))}catch(l){console.error("å¤„ç†æ¥å—å¤±è´¥",l)}finally{i(!1),setTimeout(()=>{s(null)},500)}},nt=l=>{l.preventDefault(),l.stopPropagation()},st=l=>{l.preventDefault(),l.stopPropagation(),de(!0)},rt=l=>{l.preventDefault(),l.stopPropagation();const j=Ce.current?.getBoundingClientRect();j&&(l.clientX<j.left||l.clientX>j.right||l.clientY<j.top||l.clientY>j.bottom)&&de(!1)},at=l=>{l.preventDefault(),l.stopPropagation(),de(!1);const j=l.dataTransfer.files;j.length>0&&ue({target:{files:j}},!1)};return n.jsxs(n.Fragment,{children:[!R&&n.jsxs(g,{ref:Ce,onDragEnter:st,onDragLeave:rt,onDragOver:nt,onDrop:at,sx:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:{xs:"89%",sm:"80%",md:"60%"},maxWidth:"900px",height:q?"85svh":"75vh",p:3,m:"auto",boxShadow:8,borderRadius:2,backgroundColor:"background.paper",zIndex:l=>l.zIndex.modal,display:"flex",flexDirection:"column",justifyContent:"space-between"},children:[ve&&n.jsx(fe,{in:ve,timeout:400,unmountOnExit:!0,children:n.jsx(g,{sx:{position:"absolute",top:0,left:0,width:"100%",height:"100%",zIndex:1e3,backgroundColor:"rgba(0, 0, 0, 0.4)",borderRadius:2,display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"none"},children:n.jsx(T,{variant:"h6",color:"white",children:a("prompt.dropToUpload")})})}),n.jsx(gn,{}),n.jsxs(g,{sx:{display:"flex",gap:2,flexWrap:"wrap"},children:[n.jsx(re,{color:"primary",badgeContent:u==="file"?1:0,overlap:"circular",sx:ie,children:n.jsx(F,{variant:"outlined",sx:G,startIcon:n.jsx(At,{}),onClick:()=>{const l=document.getElementById("multi-file-input");l&&(l.value="",l.click())},children:a("button.file")})}),n.jsx("input",{id:"multi-file-input",type:"file",hidden:!0,multiple:!0,onChange:l=>{ue(l,!1)}}),n.jsx(re,{color:"primary",badgeContent:u==="image"?1:0,overlap:"circular",sx:ie,children:n.jsx(F,{variant:"outlined",sx:G,startIcon:n.jsx(Ut,{}),onClick:()=>{const l=document.getElementById("image-input");l&&(l.value="",l.click())},children:a("button.image")})}),n.jsx("input",{id:"image-input",type:"file",hidden:!0,accept:"image/*",multiple:!0,onChange:_e}),n.jsx(re,{color:"primary",badgeContent:u==="text"?1:0,overlap:"circular",sx:ie,children:n.jsx(F,{onClick:Ge,variant:"outlined",startIcon:n.jsx(Rt,{}),sx:G,children:a("button.text")})}),n.jsx(re,{color:"primary",badgeContent:u==="clip"?1:0,overlap:"circular",sx:ie,children:n.jsx(F,{onClick:()=>x("clip"),variant:"outlined",startIcon:n.jsx(Dt,{}),sx:G,children:a("button.clipboard")})})]}),n.jsx(g,{sx:{display:"flex",justifyContent:"space-between",mt:2},children:n.jsx(F,{ref:Ye,onClick:$e,variant:"contained",endIcon:c?n.jsx(ye,{size:20,color:"inherit"}):n.jsx(Et,{}),disabled:c,children:a("button.searchUsers")})}),n.jsx(Oe,{sx:{mb:.5,mt:2}}),n.jsxs(g,{className:"uniformed-scroller",sx:{mt:0,p:0,flexGrow:1,overflowY:"auto"},children:[o.length==0&&f.get("isNewUser")?n.jsx(n.Fragment,{children:n.jsx(g,{sx:{display:"flex",alignItems:"center",justifyContent:"center",textAlign:"left",height:"100%",px:2},children:n.jsxs(g,{children:["  ",n.jsxs(T,{variant:"body2",color:"text.secondary",sx:{whiteSpace:"pre-line"},children:[a("guide.title"),`
`,n.jsx(le,{i18nKey:"guide.step1",components:{strong:n.jsx("strong",{})}}),`
`,n.jsx(le,{i18nKey:"guide.step2",components:{strong:n.jsx("strong",{})}})]})]})})}):n.jsx(n.Fragment,{}),[...o].sort((l,j)=>l.status==="connected"&&j.status==="connected"?He(l.uniqId,j.uniqId)?-1:1:0).map(l=>n.jsx(Pt,{onClick:j=>{u==="video"?I.isConnectedToUser(l.uniqId)||I.connectToUser(l.uniqId):et(j,l.uniqId)},sx:{...xn,width:"96%",textAlign:"inherit",backgroundColor:l.status==="waiting"?e.palette.action.hover:e.palette.background.paper,opacity:l.status==="waiting"?.7:1,transition:"all 0.3s ease-in-out","&:hover":{boxShadow:l.status==="connected"?2:1,bgcolor:l.status==="waiting"?"rgba(0, 0, 0, 0.12)":"background.default"},padding:1.5,borderRadius:2,display:"block"},children:n.jsxs(g,{sx:{display:"flex",alignItems:"flex-start",textAlign:"left",gap:1,width:"100%",transition:"opacity 0.3s ease",opacity:l.status==="waiting"?.8:1},children:[Ze(l.userType),n.jsx(T,{variant:"body1",sx:{width:"100%",textAlign:"left",color:l.status==="connected"?"text.primary":"text.secondary",transition:"color 0.3s ease"},children:l.name})]})},l.uniqId))]}),n.jsx(Ft,{color:"primary",onClick:()=>{M(!0)},sx:{position:"absolute",bottom:65,right:35,zIndex:l=>l.zIndex.modal+1},children:n.jsx(Ve,{})}),n.jsx(pn,{})]}),n.jsxs(oe,{open:r,onClose:()=>{i(!1),setTimeout(()=>{s(null)},300)},children:[n.jsx(Le,{children:a("dialog.newShare")}),n.jsxs(me,{sx:{width:{sx:200,sm:200,md:400,lg:400}},children:[n.jsx(Mt,{children:a("dialog.incomingMessage")}),t&&n.jsx(H,{value:t??"",multiline:!0,fullWidth:!0,InputProps:{readOnly:!0},variant:"outlined",sx:{border:"none",maxHeight:300,overflowY:"auto",borderRadius:1,mt:1,fontSize:{xs:"14px",sm:"15px"},"& .MuiInputBase-input":{whiteSpace:"pre-wrap"}}})]}),n.jsxs(je,{children:[n.jsx(F,{onClick:()=>{i(!1),s(null)},color:"secondary",children:a("button.reject")}),n.jsx(F,{onClick:tt,color:"primary",autoFocus:!0,children:a("button.accept")})]})]}),n.jsx(oe,{open:U,onClose:()=>P(!1),fullWidth:!0,maxWidth:"sm",PaperProps:{sx:{borderRadius:2,maxWidth:500,mx:{xs:1,sm:"auto"}}},children:n.jsxs(g,{sx:{padding:"20px"},children:[n.jsxs(je,{sx:{justifyContent:"space-between"},children:[n.jsx(T,{variant:"h6",sx:{flexGrow:1},children:a("dialog.inputText")}),n.jsx(F,{onClick:()=>P(!1),color:"secondary",children:a("button.cancel")}),n.jsx(F,{onClick:()=>{D?(v(D),x("text")):y(a("toast.emptyInput"),1e3,{kind:"info"}),P(!1)},color:"primary",variant:"contained",children:a("button.confirm")})]}),n.jsx(me,{children:n.jsx(H,{autoFocus:!0,value:D,onChange:l=>E(l.target.value),multiline:!0,rows:5,fullWidth:!0,variant:"outlined",placeholder:`${a("placeholder.inputText")}...`,sx:{px:0,fontSize:{xs:"14px",sm:"16px"}}})})]})}),n.jsx(yn,{targetUserId:qe,onClose:()=>{M(!1)},open:se,progress:Q,setProgress:B}),n.jsx(Be,{sx:{color:"#fff",zIndex:l=>l.zIndex.drawer+9999},open:w,children:n.jsx(ye,{color:"inherit"})}),n.jsx(mn,{open:R}),n.jsx(Xt,{})]})}const ze={light:Y({palette:{mode:"light"}}),dark:Y({palette:{mode:"dark"}}),blue:Y({palette:{mode:"light",primary:{main:"#1976d2"},secondary:{main:"#90caf9"},background:{default:"#e3f2fd",paper:"#ffffff"}}}),green:Y({palette:{mode:"light",primary:{main:"#388e3c"},secondary:{main:"#a5d6a7"},background:{default:"#f1f8e9",paper:"#ffffff"}}}),sunset:Y({palette:{mode:"light",primary:{main:"#f57c00"},secondary:{main:"#ffcc80"},background:{default:"#fff3e0",paper:"#ffffff"}}}),coolGray:Y({palette:{mode:"dark",primary:{main:"#90a4ae"},secondary:{main:"#cfd8dc"},background:{default:"#263238",paper:"#37474f"}}})},wn=We(()=>{const a=f.get("userTheme")||"system",e=window.matchMedia?.("(prefers-color-scheme: dark)").matches,t=a==="system"?e?"dark":"light":a,s=ze[t]??ze.light,[r,i]=h.useState(s);return h.useEffect(()=>{i(s);const o=s.palette.background.default,d=document.querySelector('meta[name="theme-color"]');d&&o&&d.setAttribute("content",o),q&&Ne(async()=>{const{NavigationBar:c}=await import("./@hugotomazi-DS0qXKOR.js").then(p=>p.i);return{NavigationBar:c}},__vite__mapDeps([2,3]),import.meta.url).then(({NavigationBar:c})=>{c.setColor({color:o,darkButtons:t!=="dark"})})},[f.get("userTheme")]),n.jsxs(It,{theme:r,children:[n.jsx(jt,{}),n.jsx(Tt,{styles:o=>({"::selection":{backgroundColor:o.palette.primary.light,color:o.palette.getContrastText(o.palette.primary.light)}})}),n.jsx(bn,{})]})}),Sn="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANMAAACECAYAAAAKjB6WAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NjdFMjg1MUU1MEJGMTFFN0IxNEZDN0U5MzZCREMyQjMiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NjdFMjg1MUY1MEJGMTFFN0IxNEZDN0U5MzZCREMyQjMiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo2N0UyODUxQzUwQkYxMUU3QjE0RkM3RTkzNkJEQzJCMyIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo2N0UyODUxRDUwQkYxMUU3QjE0RkM3RTkzNkJEQzJCMyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PrGIRRAAABbASURBVHja7F1/cFzF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";function be(a,e,t){return e<String(a).length?a.toString():Array(e-String(a).length+1).join("0")+a}function vn(a){const e=[0,4129,8258,12387,16516,20645,24774,28903,33032,37161,41290,45419,49548,53677,57806,61935,4657,528,12915,8786,21173,17044,29431,25302,37689,33560,45947,41818,54205,50076,62463,58334,9314,13379,1056,5121,25830,29895,17572,21637,42346,46411,34088,38153,58862,62927,50604,54669,13907,9842,5649,1584,30423,26358,22165,18100,46939,42874,38681,34616,63455,59390,55197,51132,18628,22757,26758,30887,2112,6241,10242,14371,51660,55789,59790,63919,35144,39273,43274,47403,23285,19156,31415,27286,6769,2640,14899,10770,56317,52188,64447,60318,39801,35672,47931,43802,27814,31879,19684,23749,11298,15363,3168,7233,60846,64911,52716,56781,44330,48395,36200,40265,32407,28342,24277,20212,15891,11826,7761,3696,65439,61374,57309,53244,48923,44858,40793,36728,37256,33193,45514,41451,53516,49453,61774,57711,4224,161,12482,8419,20484,16421,28742,24679,33721,37784,41979,46042,49981,54044,58239,62302,689,4752,8947,13010,16949,21012,25207,29270,46570,42443,38312,34185,62830,58703,54572,50445,13538,9411,5280,1153,29798,25671,21540,17413,42971,47098,34713,38840,59231,63358,50973,55100,9939,14066,1681,5808,26199,30326,17941,22068,55628,51565,63758,59695,39368,35305,47498,43435,22596,18533,30726,26663,6336,2273,14466,10403,52093,56156,60223,64286,35833,39896,43963,48026,19061,23124,27191,31254,2801,6864,10931,14994,64814,60687,56684,52557,48554,44427,40424,36297,31782,27655,23652,19525,15522,11395,7392,3265,61215,65342,53085,57212,44955,49082,36825,40952,28183,32310,20053,24180,11923,16050,3793,7920];let t=65535,s,r;for(r=0;r<a.length;r++){const i=a.charCodeAt(r);if(i>255)throw new RangeError;s=(i^t>>8)&255,t=e[s]^t<<8}return be(((t^0)&65535).toString(16).toUpperCase(),4)}function Cn(a){let t=[{id:"00",value:"01"},{id:"01",value:"11"},{id:"26",value:[{id:"00",value:"SG.PAYNOW"},{id:"01",value:"0"},{id:"02",value:a.uen},{id:"03",value:a.editable.toString()},{id:"04",value:a.expiry}]},{id:"52",value:"0000"},{id:"53",value:"702"},{id:"54",value:a.amount.toString()},{id:"58",value:"SG"},{id:"59",value:a.name},{id:"60",value:"Singapore"},{id:"62",value:[{id:"01",value:"Blank is fine..."}]}].reduce((s,r)=>(Array.isArray(r.value)&&(r.value=r.value.reduce((i,o)=>(i+=o.id+be(o.value.length.toString(),2)+o.value,i),"")),s+=r.id+be(r.value.length.toString(),2)+r.value,s),"");return t+="6304"+vn(t+"6304"),t}const kn=()=>{const[a,e]=h.useState(localStorage.getItem("countryCode")||"+65"),[t,s]=h.useState(localStorage.getItem("phoneNumber")||""),[r,i]=h.useState(localStorage.getItem("payNowName")||"");h.useEffect(()=>{localStorage.setItem("countryCode",a)},[a]),h.useEffect(()=>{localStorage.setItem("phoneNumber",t)},[t]),h.useEffect(()=>{localStorage.setItem("payNowName",r)},[r]);const o=C=>{e(C.target.value)},d=C=>{s(C.target.value)},c=C=>{i(C.target.value)},u={uen:`${a}${t}`,name:r||"Payee",editable:1,expiry:"20990106",amount:0,refNumber:""},x=Cn(u),[S,k]=h.useState(!1);return h.useEffect(()=>{const C=()=>{window.innerHeight<document.documentElement.clientHeight?k(!0):k(!1)};return window.addEventListener("resize",C),()=>{window.removeEventListener("resize",C)}},[]),n.jsxs(Lt,{maxWidth:"xs",sx:{height:S?"calc(100vh - 50px)":"100vh",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",paddingBottom:S?"50px":"0"},children:[n.jsxs(g,{sx:{width:"100%",mb:4},children:[n.jsxs(H,{select:!0,label:"å›½å®¶ä»£ç ",value:a,onChange:o,variant:"outlined",sx:{width:"30%",mr:1},children:[n.jsx(K,{value:"+65",children:"+65 æ–°åŠ å¡"}),n.jsx(K,{value:"+86",children:"+86 ä¸­å›½"})]}),n.jsx(H,{label:"æ‰‹æœºå·",variant:"outlined",value:t,onChange:d,sx:{width:"65%"}})]}),n.jsx(g,{sx:{width:"100%",mb:4},children:n.jsx(H,{label:"PayNow åå­—",variant:"outlined",fullWidth:!0,value:r,onChange:c})}),n.jsx(g,{sx:{width:"100%",display:"flex",justifyContent:"center",alignItems:"center",flexDirection:"column"},children:n.jsxs(g,{sx:{width:"80%",display:"flex",justifyContent:"center",alignItems:"center",flexDirection:"column",boxShadow:"0px 4px 12px rgba(0, 0, 0, 0.1)",padding:"16px",borderRadius:"8px",backgroundColor:"#fff"},children:[n.jsxs(g,{sx:{height:"8svh"},children:[n.jsx(g,{sx:{height:"4.4svh"},children:n.jsx("p",{style:{textAlign:"center",fontSize:"25px",margin:"0"},children:n.jsx("b",{children:r})})}),n.jsx(g,{sx:{height:"3svh"},children:n.jsx("p",{style:{textAlign:"center",color:"#645f60",fontSize:"20px",margin:"0"},children:a+" "+t})})]}),n.jsx(xe,{style:{marginBottom:"10px"},value:x,size:250,fgColor:"#771976",logoImage:Sn,logoHeight:60,logoWidth:90,quietZone:10,logoOpacity:1,removeQrCodeBehindLogo:!0,eyeRadius:[{outer:0,inner:0},{outer:0,inner:0},{outer:0,inner:0}]}),n.jsx(F,{variant:"contained",color:"secondary",sx:{backgroundColor:"#771976"},children:"SCAN TO PAY"})]})})]})};function In(){return n.jsx(Zt,{children:n.jsxs(Gt,{children:[n.jsx(Re,{path:"/",element:n.jsx(wn,{})}),n.jsx(Re,{path:"/paynow",element:n.jsx(kn,{})})]})})}ot.createRoot(document.getElementById("root")).render(n.jsx(In,{}));
